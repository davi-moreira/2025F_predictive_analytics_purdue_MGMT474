<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>time_series – MGMT 47400: Predictive Analytics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-79df7ed5347781c1339259261daa236f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../images/mgmt_474_ai_logo_02-modified.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main">
    <a href="https://github.com/davi-moreira/2025F_predictive_analytics_purdue_MGMT474" title="GitHub" class="quarto-navigation-tool px-1" aria-label="GitHub"><i class="bi bi-github"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Syllabus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../schedule.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Schedule and Material</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a>
  <ul class="collapse">
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  </ul></li>
  <li><a href="#forecasting-vs.-generic-supervised-prediction" id="toc-forecasting-vs.-generic-supervised-prediction" class="nav-link" data-scroll-target="#forecasting-vs.-generic-supervised-prediction">1 - Forecasting vs.&nbsp;Generic Supervised Prediction</a>
  <ul class="collapse">
  <li><a href="#problem-framing-two-worlds" id="toc-problem-framing-two-worlds" class="nav-link" data-scroll-target="#problem-framing-two-worlds">Problem Framing: Two Worlds</a>
  <ul class="collapse">
  <li><a href="#generic-supervised-prediction" id="toc-generic-supervised-prediction" class="nav-link" data-scroll-target="#generic-supervised-prediction">Generic Supervised Prediction</a></li>
  <li><a href="#forecasting" id="toc-forecasting" class="nav-link" data-scroll-target="#forecasting">Forecasting</a></li>
  </ul></li>
  <li><a href="#why-we-get-confused" id="toc-why-we-get-confused" class="nav-link" data-scroll-target="#why-we-get-confused">Why We Get Confused</a></li>
  <li><a href="#evaluation-protocols" id="toc-evaluation-protocols" class="nav-link" data-scroll-target="#evaluation-protocols">Evaluation Protocols</a>
  <ul class="collapse">
  <li><a href="#generic-regression" id="toc-generic-regression" class="nav-link" data-scroll-target="#generic-regression">Generic Regression</a></li>
  <li><a href="#forecasting-1" id="toc-forecasting-1" class="nav-link" data-scroll-target="#forecasting-1">Forecasting</a></li>
  </ul></li>
  <li><a href="#common-pitfalls" id="toc-common-pitfalls" class="nav-link" data-scroll-target="#common-pitfalls">Common Pitfalls</a></li>
  </ul></li>
  <li><a href="#time-series-graphics" id="toc-time-series-graphics" class="nav-link" data-scroll-target="#time-series-graphics">2 - Time Series Graphics</a>
  <ul class="collapse">
  <li><a href="#load-common-libraries-and-settings" id="toc-load-common-libraries-and-settings" class="nav-link" data-scroll-target="#load-common-libraries-and-settings">Load common libraries and settings</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#time-series-plots" id="toc-time-series-plots" class="nav-link" data-scroll-target="#time-series-plots">Time Series Plots</a>
  <ul class="collapse">
  <li><a href="#ansett-airlines-economy-class-melbourne-sydney" id="toc-ansett-airlines-economy-class-melbourne-sydney" class="nav-link" data-scroll-target="#ansett-airlines-economy-class-melbourne-sydney">Ansett airlines economy class: Melbourne-Sydney</a></li>
  <li><a href="#ansett-airlines-economy-class-melbourne-sydney-1" id="toc-ansett-airlines-economy-class-melbourne-sydney-1" class="nav-link" data-scroll-target="#ansett-airlines-economy-class-melbourne-sydney-1">Ansett airlines economy class: Melbourne-Sydney</a></li>
  <li><a href="#australian-antidiabetic-drug-sales" id="toc-australian-antidiabetic-drug-sales" class="nav-link" data-scroll-target="#australian-antidiabetic-drug-sales">Australian antidiabetic drug sales</a></li>
  <li><a href="#australian-antidiabetic-drug-sales-1" id="toc-australian-antidiabetic-drug-sales-1" class="nav-link" data-scroll-target="#australian-antidiabetic-drug-sales-1">Australian antidiabetic drug sales</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#time-series-patterns" id="toc-time-series-patterns" class="nav-link" data-scroll-target="#time-series-patterns">3 - Time Series Patterns</a>
  <ul class="collapse">
  <li><a href="#trend" id="toc-trend" class="nav-link" data-scroll-target="#trend"><strong>Trend</strong></a></li>
  <li><a href="#seasonal" id="toc-seasonal" class="nav-link" data-scroll-target="#seasonal"><strong>Seasonal</strong></a></li>
  <li><a href="#cyclic" id="toc-cyclic" class="nav-link" data-scroll-target="#cyclic"><strong>Cyclic</strong></a></li>
  <li><a href="#key-distinction" id="toc-key-distinction" class="nav-link" data-scroll-target="#key-distinction"><strong>Key Distinction</strong></a></li>
  <li><a href="#practical-insight" id="toc-practical-insight" class="nav-link" data-scroll-target="#practical-insight"><strong>Practical Insight</strong></a></li>
  <li><a href="#four-examples-of-time-series-showing-different-patterns" id="toc-four-examples-of-time-series-showing-different-patterns" class="nav-link" data-scroll-target="#four-examples-of-time-series-showing-different-patterns">Four examples of time series showing different patterns</a></li>
  <li><a href="#four-examples-of-time-series-showing-different-patterns-1" id="toc-four-examples-of-time-series-showing-different-patterns-1" class="nav-link" data-scroll-target="#four-examples-of-time-series-showing-different-patterns-1">Four Examples of Time Series Showing Different Patterns</a></li>
  <li><a href="#lag-plots" id="toc-lag-plots" class="nav-link" data-scroll-target="#lag-plots">Lag plots</a>
  <ul class="collapse">
  <li><a href="#lagged-scatterplots-for-quarterly-beer-production." id="toc-lagged-scatterplots-for-quarterly-beer-production." class="nav-link" data-scroll-target="#lagged-scatterplots-for-quarterly-beer-production.">Lagged scatterplots for quarterly beer production.</a></li>
  <li><a href="#lagged-scatterplots-for-quarterly-beer-production" id="toc-lagged-scatterplots-for-quarterly-beer-production" class="nav-link" data-scroll-target="#lagged-scatterplots-for-quarterly-beer-production">Lagged Scatterplots for Quarterly Beer Production</a></li>
  </ul></li>
  <li><a href="#autocorrelation" id="toc-autocorrelation" class="nav-link" data-scroll-target="#autocorrelation">Autocorrelation</a>
  <ul class="collapse">
  <li><a href="#autocorrelation-function-for-quarterly-beer-production." id="toc-autocorrelation-function-for-quarterly-beer-production." class="nav-link" data-scroll-target="#autocorrelation-function-for-quarterly-beer-production.">Autocorrelation function for quarterly beer production.</a></li>
  <li><a href="#autocorrelation-function-for-quarterly-beer-production.-1" id="toc-autocorrelation-function-for-quarterly-beer-production.-1" class="nav-link" data-scroll-target="#autocorrelation-function-for-quarterly-beer-production.-1">Autocorrelation function for quarterly beer production.</a></li>
  <li><a href="#trend-and-seasonality-in-acf-plots" id="toc-trend-and-seasonality-in-acf-plots" class="nav-link" data-scroll-target="#trend-and-seasonality-in-acf-plots">Trend and Seasonality in ACF Plots</a></li>
  <li><a href="#autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia" id="toc-autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia" class="nav-link" data-scroll-target="#autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia">Autocorrelation function for monthly antidiabetic drug sales in Australia</a></li>
  <li><a href="#autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia-1" id="toc-autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia-1" class="nav-link" data-scroll-target="#autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia-1">Autocorrelation function for monthly antidiabetic drug sales in Australia</a></li>
  </ul></li>
  <li><a href="#white-noise" id="toc-white-noise" class="nav-link" data-scroll-target="#white-noise">White noise</a>
  <ul class="collapse">
  <li><a href="#white-noise-series" id="toc-white-noise-series" class="nav-link" data-scroll-target="#white-noise-series">White noise series</a></li>
  <li><a href="#autocorrelation-function-for-the-white-noise-series" id="toc-autocorrelation-function-for-the-white-noise-series" class="nav-link" data-scroll-target="#autocorrelation-function-for-the-white-noise-series">Autocorrelation function for the white noise series</a></li>
  <li><a href="#autocorrelation-function-for-the-white-noise-series-1" id="toc-autocorrelation-function-for-the-white-noise-series-1" class="nav-link" data-scroll-target="#autocorrelation-function-for-the-white-noise-series-1">Autocorrelation Function for the White Noise Series</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#time-series-decomposition" id="toc-time-series-decomposition" class="nav-link" data-scroll-target="#time-series-decomposition">4 - Time Series Decomposition</a>
  <ul class="collapse">
  <li><a href="#load-common-libraries-and-settings-1" id="toc-load-common-libraries-and-settings-1" class="nav-link" data-scroll-target="#load-common-libraries-and-settings-1">Load common libraries and settings</a></li>
  <li><a href="#introduction-1" id="toc-introduction-1" class="nav-link" data-scroll-target="#introduction-1">Introduction</a></li>
  <li><a href="#introduction-2" id="toc-introduction-2" class="nav-link" data-scroll-target="#introduction-2">Introduction</a></li>
  <li><a href="#introduction-3" id="toc-introduction-3" class="nav-link" data-scroll-target="#introduction-3">Introduction</a></li>
  <li><a href="#introduction-4" id="toc-introduction-4" class="nav-link" data-scroll-target="#introduction-4">Introduction</a></li>
  <li><a href="#time-series-components" id="toc-time-series-components" class="nav-link" data-scroll-target="#time-series-components">Time Series Components</a>
  <ul class="collapse">
  <li><a href="#additive-decomposition" id="toc-additive-decomposition" class="nav-link" data-scroll-target="#additive-decomposition"><strong>Additive Decomposition</strong></a></li>
  <li><a href="#multiplicative-decomposition" id="toc-multiplicative-decomposition" class="nav-link" data-scroll-target="#multiplicative-decomposition"><strong>Multiplicative Decomposition</strong></a></li>
  <li><a href="#log-transformation-equivalence" id="toc-log-transformation-equivalence" class="nav-link" data-scroll-target="#log-transformation-equivalence"><strong>Log Transformation Equivalence</strong></a></li>
  <li><a href="#example-employment-in-the-us-retail-sector" id="toc-example-employment-in-the-us-retail-sector" class="nav-link" data-scroll-target="#example-employment-in-the-us-retail-sector">Example: Employment in the US Retail Sector</a></li>
  <li><a href="#example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method" id="toc-example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method" class="nav-link" data-scroll-target="#example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method">Example: Seasonal and Trend decomposition using Loess (STL) decomposition method</a></li>
  <li><a href="#example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-1" id="toc-example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-1" class="nav-link" data-scroll-target="#example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-1">Example: Seasonal and Trend decomposition using Loess (STL) decomposition method</a></li>
  <li><a href="#example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-2" id="toc-example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-2" class="nav-link" data-scroll-target="#example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-2">Example: Seasonal and Trend decomposition using Loess (STL) decomposition method</a></li>
  <li><a href="#example-seasonal-and-trend-decomposition-using-loess-stl" id="toc-example-seasonal-and-trend-decomposition-using-loess-stl" class="nav-link" data-scroll-target="#example-seasonal-and-trend-decomposition-using-loess-stl">Example: Seasonal and Trend Decomposition Using Loess (STL)</a></li>
  </ul></li>
  <li><a href="#seasonally-adjusted-data" id="toc-seasonally-adjusted-data" class="nav-link" data-scroll-target="#seasonally-adjusted-data">Seasonally adjusted data</a></li>
  <li><a href="#seasonally-adjusted-data-1" id="toc-seasonally-adjusted-data-1" class="nav-link" data-scroll-target="#seasonally-adjusted-data-1">Seasonally Adjusted Data</a>
  <ul class="collapse">
  <li><a href="#key-insight" id="toc-key-insight" class="nav-link" data-scroll-target="#key-insight">Key Insight</a></li>
  </ul></li>
  <li><a href="#moving-averages" id="toc-moving-averages" class="nav-link" data-scroll-target="#moving-averages">Moving Averages</a>
  <ul class="collapse">
  <li><a href="#moving-average-smoothing" id="toc-moving-average-smoothing" class="nav-link" data-scroll-target="#moving-average-smoothing"><strong>Moving Average Smoothing</strong></a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><strong>Interpretation</strong></a></li>
  <li><a href="#example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017" id="toc-example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017" class="nav-link" data-scroll-target="#example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017">Example: Australian exports of goods and services (as % of GDP) from 1960–2017</a></li>
  <li><a href="#example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017-1" id="toc-example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017-1" class="nav-link" data-scroll-target="#example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017-1">Example: Australian exports of goods and services (as % of GDP) from 1960–2017</a></li>
  <li><a href="#example-australian-exports-of-goods-and-services-of-gdp-19602017" id="toc-example-australian-exports-of-goods-and-services-of-gdp-19602017" class="nav-link" data-scroll-target="#example-australian-exports-of-goods-and-services-of-gdp-19602017">Example: Australian Exports of Goods and Services (% of GDP), 1960–2017</a></li>
  <li><a href="#example-australian-exports-of-goods-and-services-of-gdp-19602017-1" id="toc-example-australian-exports-of-goods-and-services-of-gdp-19602017-1" class="nav-link" data-scroll-target="#example-australian-exports-of-goods-and-services-of-gdp-19602017-1">Example: Australian Exports of Goods and Services (% of GDP), 1960–2017</a></li>
  <li><a href="#example-australian-exports-of-goods-and-services-of-gdp-19602017-2" id="toc-example-australian-exports-of-goods-and-services-of-gdp-19602017-2" class="nav-link" data-scroll-target="#example-australian-exports-of-goods-and-services-of-gdp-19602017-2">Example: Australian Exports of Goods and Services (% of GDP), 1960–2017</a></li>
  <li><a href="#example-australian-exports-of-goods-and-services-of-gdp-19602017-3" id="toc-example-australian-exports-of-goods-and-services-of-gdp-19602017-3" class="nav-link" data-scroll-target="#example-australian-exports-of-goods-and-services-of-gdp-19602017-3">Example: Australian Exports of Goods and Services (% of GDP), 1960–2017</a></li>
  </ul></li>
  <li><a href="#classical-decomposition" id="toc-classical-decomposition" class="nav-link" data-scroll-target="#classical-decomposition">Classical Decomposition</a>
  <ul class="collapse">
  <li><a href="#additive-decomposition-1" id="toc-additive-decomposition-1" class="nav-link" data-scroll-target="#additive-decomposition-1">Additive Decomposition</a></li>
  <li><a href="#additive-decomposition-2" id="toc-additive-decomposition-2" class="nav-link" data-scroll-target="#additive-decomposition-2">Additive Decomposition</a></li>
  <li><a href="#multiplicative-decomposition-1" id="toc-multiplicative-decomposition-1" class="nav-link" data-scroll-target="#multiplicative-decomposition-1">Multiplicative Decomposition</a></li>
  <li><a href="#multiplicative-decomposition-2" id="toc-multiplicative-decomposition-2" class="nav-link" data-scroll-target="#multiplicative-decomposition-2">Multiplicative Decomposition</a></li>
  </ul></li>
  <li><a href="#comments-on-classical-decomposition" id="toc-comments-on-classical-decomposition" class="nav-link" data-scroll-target="#comments-on-classical-decomposition">Comments on Classical Decomposition</a></li>
  <li><a href="#stl-decomposition" id="toc-stl-decomposition" class="nav-link" data-scroll-target="#stl-decomposition">STL Decomposition</a>
  <ul class="collapse">
  <li><a href="#key-advantages-of-stl" id="toc-key-advantages-of-stl" class="nav-link" data-scroll-target="#key-advantages-of-stl"><strong>Key Advantages of STL</strong></a></li>
  <li><a href="#limitations-of-stl" id="toc-limitations-of-stl" class="nav-link" data-scroll-target="#limitations-of-stl"><strong>Limitations of STL</strong></a></li>
  <li><a href="#transformations-for-alternative-forms" id="toc-transformations-for-alternative-forms" class="nav-link" data-scroll-target="#transformations-for-alternative-forms"><strong>Transformations for Alternative Forms</strong></a></li>
  <li><a href="#practical-use" id="toc-practical-use" class="nav-link" data-scroll-target="#practical-use"><strong>Practical Use</strong></a></li>
  <li><a href="#example-total-us-retail-employment-top-and-its-three-additive-components-obtained-from-a-robust-stl-decomposition-with-flexible-trend-cycle-and-fixed-seasonality." id="toc-example-total-us-retail-employment-top-and-its-three-additive-components-obtained-from-a-robust-stl-decomposition-with-flexible-trend-cycle-and-fixed-seasonality." class="nav-link" data-scroll-target="#example-total-us-retail-employment-top-and-its-three-additive-components-obtained-from-a-robust-stl-decomposition-with-flexible-trend-cycle-and-fixed-seasonality.">Example: Total US retail employment (top) and its three additive components obtained from a robust STL decomposition with flexible trend-cycle and fixed seasonality.</a></li>
  <li><a href="#example-total-us-retail-employment-and-its-stl-components" id="toc-example-total-us-retail-employment-and-its-stl-components" class="nav-link" data-scroll-target="#example-total-us-retail-employment-and-its-stl-components">Example: Total US Retail Employment and Its STL Components</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#some-simple-forecasting-methods" id="toc-some-simple-forecasting-methods" class="nav-link" data-scroll-target="#some-simple-forecasting-methods">5 - Some simple forecasting methods</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#mean-method" id="toc-mean-method" class="nav-link" data-scroll-target="#mean-method">Mean method</a>
  <ul class="collapse">
  <li><a href="#example-mean-or-average-forecasts-applied-to-clay-brick-production-in-australia." id="toc-example-mean-or-average-forecasts-applied-to-clay-brick-production-in-australia." class="nav-link" data-scroll-target="#example-mean-or-average-forecasts-applied-to-clay-brick-production-in-australia.">Example: Mean (or average) forecasts applied to clay brick production in Australia.</a></li>
  </ul></li>
  <li><a href="#naïve-method" id="toc-naïve-method" class="nav-link" data-scroll-target="#naïve-method">Naïve method</a>
  <ul class="collapse">
  <li><a href="#example-naïve-forecasts-applied-to-clay-brick-production-in-australia." id="toc-example-naïve-forecasts-applied-to-clay-brick-production-in-australia." class="nav-link" data-scroll-target="#example-naïve-forecasts-applied-to-clay-brick-production-in-australia.">Example: Naïve forecasts applied to clay brick production in Australia.</a></li>
  </ul></li>
  <li><a href="#seasonal-naïve-method-with-period-m" id="toc-seasonal-naïve-method-with-period-m" class="nav-link" data-scroll-target="#seasonal-naïve-method-with-period-m">Seasonal Naïve Method with Period <span class="math inline">\(m\)</span></a>
  <ul class="collapse">
  <li><a href="#interpretation-1" id="toc-interpretation-1" class="nav-link" data-scroll-target="#interpretation-1"><strong>Interpretation</strong></a></li>
  <li><a href="#example-seasonal-naïve-forecasts-applied-to-clay-brick-production-in-australia." id="toc-example-seasonal-naïve-forecasts-applied-to-clay-brick-production-in-australia." class="nav-link" data-scroll-target="#example-seasonal-naïve-forecasts-applied-to-clay-brick-production-in-australia.">Example: Seasonal naïve forecasts applied to clay brick production in Australia.</a></li>
  </ul></li>
  <li><a href="#drift-method" id="toc-drift-method" class="nav-link" data-scroll-target="#drift-method">Drift Method</a>
  <ul class="collapse">
  <li><a href="#interpretation-2" id="toc-interpretation-2" class="nav-link" data-scroll-target="#interpretation-2"><strong>Interpretation</strong></a></li>
  <li><a href="#example-drift-forecasts-applied-to-clay-brick-production-in-australia" id="toc-example-drift-forecasts-applied-to-clay-brick-production-in-australia" class="nav-link" data-scroll-target="#example-drift-forecasts-applied-to-clay-brick-production-in-australia">Example: Drift forecasts applied to clay brick production in Australia</a></li>
  </ul></li>
  <li><a href="#example-australian-quarterly-beer-production" id="toc-example-australian-quarterly-beer-production" class="nav-link" data-scroll-target="#example-australian-quarterly-beer-production">Example: Australian Quarterly Beer Production</a></li>
  <li><a href="#example-googles-daily-closing-stock-price" id="toc-example-googles-daily-closing-stock-price" class="nav-link" data-scroll-target="#example-googles-daily-closing-stock-price">Example: Google’s Daily Closing Stock Price</a></li>
  <li><a href="#benchmark-role-of-simple-forecasting-methods" id="toc-benchmark-role-of-simple-forecasting-methods" class="nav-link" data-scroll-target="#benchmark-role-of-simple-forecasting-methods">Benchmark Role of Simple Forecasting Methods</a></li>
  </ul></li>
  <li><a href="#forecasting-with-decomposition" id="toc-forecasting-with-decomposition" class="nav-link" data-scroll-target="#forecasting-with-decomposition">6 – Forecasting with Decomposition</a>
  <ul class="collapse">
  <li><a href="#additive-decomposition-3" id="toc-additive-decomposition-3" class="nav-link" data-scroll-target="#additive-decomposition-3"><strong>Additive Decomposition</strong></a></li>
  <li><a href="#multiplicative-decomposition-3" id="toc-multiplicative-decomposition-3" class="nav-link" data-scroll-target="#multiplicative-decomposition-3"><strong>Multiplicative Decomposition</strong></a></li>
  <li><a href="#forecasting-strategy" id="toc-forecasting-strategy" class="nav-link" data-scroll-target="#forecasting-strategy"><strong>Forecasting Strategy</strong></a></li>
  <li><a href="#load-additional-libraries" id="toc-load-additional-libraries" class="nav-link" data-scroll-target="#load-additional-libraries">Load additional libraries</a></li>
  <li><a href="#example-naïve-forecasts-of-the-seasonally-adjusted-data-obtained-from-an-stl-decomposition-of-the-total-us-retail-employment." id="toc-example-naïve-forecasts-of-the-seasonally-adjusted-data-obtained-from-an-stl-decomposition-of-the-total-us-retail-employment." class="nav-link" data-scroll-target="#example-naïve-forecasts-of-the-seasonally-adjusted-data-obtained-from-an-stl-decomposition-of-the-total-us-retail-employment.">Example: Naïve forecasts of the seasonally adjusted data obtained from an STL decomposition of the total US retail employment.</a>
  <ul class="collapse">
  <li><a href="#forecasting-with-stl-decomposition" id="toc-forecasting-with-stl-decomposition" class="nav-link" data-scroll-target="#forecasting-with-stl-decomposition">Forecasting with STL Decomposition</a></li>
  <li><a href="#automated-forecasting-with-stl" id="toc-automated-forecasting-with-stl" class="nav-link" data-scroll-target="#automated-forecasting-with-stl"><strong>Automated Forecasting with <code>STL()</code></strong></a></li>
  <li><a href="#example-forecasts-of-the-total-us-retail-employment-data-based-on-a-naïve-forecast-of-the-seasonally-adjusted-data-and-a-seasonal-naïve-forecast-of-the-seasonal-component-after-an-stl-decomposition-of-the-data." id="toc-example-forecasts-of-the-total-us-retail-employment-data-based-on-a-naïve-forecast-of-the-seasonally-adjusted-data-and-a-seasonal-naïve-forecast-of-the-seasonal-component-after-an-stl-decomposition-of-the-data." class="nav-link" data-scroll-target="#example-forecasts-of-the-total-us-retail-employment-data-based-on-a-naïve-forecast-of-the-seasonally-adjusted-data-and-a-seasonal-naïve-forecast-of-the-seasonal-component-after-an-stl-decomposition-of-the-data.">Example: Forecasts of the total US retail employment data based on a naïve forecast of the seasonally adjusted data and a seasonal naïve forecast of the seasonal component, after an STL decomposition of the data.</a></li>
  <li><a href="#prediction-intervals-and-residual-analysis" id="toc-prediction-intervals-and-residual-analysis" class="nav-link" data-scroll-target="#prediction-intervals-and-residual-analysis">Prediction Intervals and Residual Analysis</a></li>
  <li><a href="#residual-diagnostics" id="toc-residual-diagnostics" class="nav-link" data-scroll-target="#residual-diagnostics"><strong>Residual Diagnostics</strong></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#evaluating-point-forecast-accuracy" id="toc-evaluating-point-forecast-accuracy" class="nav-link" data-scroll-target="#evaluating-point-forecast-accuracy">7 - Evaluating Point Forecast Accuracy</a>
  <ul class="collapse">
  <li><a href="#training-and-test-sets" id="toc-training-and-test-sets" class="nav-link" data-scroll-target="#training-and-test-sets">Training and Test Sets</a>
  <ul class="collapse">
  <li><a href="#data-partitioning-for-model-evaluation" id="toc-data-partitioning-for-model-evaluation" class="nav-link" data-scroll-target="#data-partitioning-for-model-evaluation"><strong>Data Partitioning for Model Evaluation</strong></a></li>
  <li><a href="#data-partitioning-for-model-evaluation-1" id="toc-data-partitioning-for-model-evaluation-1" class="nav-link" data-scroll-target="#data-partitioning-for-model-evaluation-1"><strong>Data Partitioning for Model Evaluation</strong></a></li>
  </ul></li>
  <li><a href="#test-set-size-and-key-considerations" id="toc-test-set-size-and-key-considerations" class="nav-link" data-scroll-target="#test-set-size-and-key-considerations">Test Set Size and Key Considerations</a>
  <ul class="collapse">
  <li><a href="#important-guidelines" id="toc-important-guidelines" class="nav-link" data-scroll-target="#important-guidelines"><strong>Important Guidelines</strong></a></li>
  </ul></li>
  <li><a href="#percentage-errors" id="toc-percentage-errors" class="nav-link" data-scroll-target="#percentage-errors">Percentage Errors</a></li>
  <li><a href="#scaled-errors" id="toc-scaled-errors" class="nav-link" data-scroll-target="#scaled-errors">Scaled Errors</a>
  <ul class="collapse">
  <li><a href="#non-seasonal-scaled-error" id="toc-non-seasonal-scaled-error" class="nav-link" data-scroll-target="#non-seasonal-scaled-error"><strong>Non-Seasonal Scaled Error</strong></a></li>
  <li><a href="#scaled-errors-for-seasonal-time-series" id="toc-scaled-errors-for-seasonal-time-series" class="nav-link" data-scroll-target="#scaled-errors-for-seasonal-time-series">Scaled Errors for Seasonal Time Series</a></li>
  <li><a href="#mean-absolute-scaled-error-mase" id="toc-mean-absolute-scaled-error-mase" class="nav-link" data-scroll-target="#mean-absolute-scaled-error-mase"><strong>Mean Absolute Scaled Error (MASE)</strong></a></li>
  <li><a href="#root-mean-squared-scaled-error-rmsse" id="toc-root-mean-squared-scaled-error-rmsse" class="nav-link" data-scroll-target="#root-mean-squared-scaled-error-rmsse"><strong>Root Mean Squared Scaled Error (RMSSE)</strong></a></li>
  </ul></li>
  <li><a href="#example-forecasts-of-australian-quarterly-beer-production-using-data-up-to-the-end-of-2007" id="toc-example-forecasts-of-australian-quarterly-beer-production-using-data-up-to-the-end-of-2007" class="nav-link" data-scroll-target="#example-forecasts-of-australian-quarterly-beer-production-using-data-up-to-the-end-of-2007">Example: Forecasts of Australian quarterly beer production using data up to the end of 2007</a>
  <ul class="collapse">
  <li><a href="#example-forecast-accuracy-measures-for-the-four-forecast-methods-applied-to-the-quarterly-australian-beer-production" id="toc-example-forecast-accuracy-measures-for-the-four-forecast-methods-applied-to-the-quarterly-australian-beer-production" class="nav-link" data-scroll-target="#example-forecast-accuracy-measures-for-the-four-forecast-methods-applied-to-the-quarterly-australian-beer-production">Example: Forecast accuracy measures for the four forecast methods applied to the quarterly Australian beer production</a></li>
  <li><a href="#evaluating-forecast-accuracy" id="toc-evaluating-forecast-accuracy" class="nav-link" data-scroll-target="#evaluating-forecast-accuracy">Evaluating Forecast Accuracy</a></li>
  <li><a href="#comparing-forecasting-methods" id="toc-comparing-forecasting-methods" class="nav-link" data-scroll-target="#comparing-forecasting-methods"><strong>Comparing Forecasting Methods</strong></a></li>
  <li><a href="#example-non-seasonal-example-google-stock-price" id="toc-example-non-seasonal-example-google-stock-price" class="nav-link" data-scroll-target="#example-non-seasonal-example-google-stock-price">Example: Non-Seasonal Example — Google Stock Price</a></li>
  <li><a href="#example-non-seasonal-example-google-stock-price-1" id="toc-example-non-seasonal-example-google-stock-price-1" class="nav-link" data-scroll-target="#example-non-seasonal-example-google-stock-price-1">Example: Non-Seasonal Example — Google Stock Price</a></li>
  <li><a href="#example-non-seasonal-example-google-stock-price-2" id="toc-example-non-seasonal-example-google-stock-price-2" class="nav-link" data-scroll-target="#example-non-seasonal-example-google-stock-price-2">Example: Non-Seasonal Example — Google Stock Price</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#time-series-cross-validation" id="toc-time-series-cross-validation" class="nav-link" data-scroll-target="#time-series-cross-validation">8 – Time Series Cross-Validation</a>
  <ul class="collapse">
  <li><a href="#concept" id="toc-concept" class="nav-link" data-scroll-target="#concept"><strong>Concept</strong></a></li>
  <li><a href="#time-series-cross-validation-1" id="toc-time-series-cross-validation-1" class="nav-link" data-scroll-target="#time-series-cross-validation-1">Time Series Cross-Validation</a></li>
  <li><a href="#forecast-accuracy-and-rolling-forecasting-origin" id="toc-forecast-accuracy-and-rolling-forecasting-origin" class="nav-link" data-scroll-target="#forecast-accuracy-and-rolling-forecasting-origin">Forecast Accuracy and Rolling Forecasting Origin</a></li>
  <li><a href="#multi-step-forecast-evaluation" id="toc-multi-step-forecast-evaluation" class="nav-link" data-scroll-target="#multi-step-forecast-evaluation">Multi-Step Forecast Evaluation</a></li>
  <li><a href="#time-series-cross-validation-with-multi-step-models." id="toc-time-series-cross-validation-with-multi-step-models." class="nav-link" data-scroll-target="#time-series-cross-validation-with-multi-step-models.">Time series cross-validation with multi-step models.</a></li>
  <li><a href="#comparing-residual-accuracy-and-cross-validation-accuracy" id="toc-comparing-residual-accuracy-and-cross-validation-accuracy" class="nav-link" data-scroll-target="#comparing-residual-accuracy-and-cross-validation-accuracy">Comparing Residual Accuracy and Cross-Validation Accuracy</a></li>
  <li><a href="#comparing-residual-accuracy-and-cross-validation-accuracy-1" id="toc-comparing-residual-accuracy-and-cross-validation-accuracy-1" class="nav-link" data-scroll-target="#comparing-residual-accuracy-and-cross-validation-accuracy-1">Comparing Residual Accuracy and Cross-Validation Accuracy</a></li>
  <li><a href="#interpreting-forecast-accuracy-results" id="toc-interpreting-forecast-accuracy-results" class="nav-link" data-scroll-target="#interpreting-forecast-accuracy-results">Interpreting Forecast Accuracy Results</a></li>
  <li><a href="#model-selection-criterion" id="toc-model-selection-criterion" class="nav-link" data-scroll-target="#model-selection-criterion"><strong>Model Selection Criterion</strong></a></li>
  <li><a href="#example-forecast-horizon-accuracy-with-cross-validation" id="toc-example-forecast-horizon-accuracy-with-cross-validation" class="nav-link" data-scroll-target="#example-forecast-horizon-accuracy-with-cross-validation">Example: Forecast Horizon Accuracy with Cross-Validation</a></li>
  <li><a href="#example-forecast-horizon-accuracy-with-cross-validation-1" id="toc-example-forecast-horizon-accuracy-with-cross-validation-1" class="nav-link" data-scroll-target="#example-forecast-horizon-accuracy-with-cross-validation-1">Example: Forecast Horizon Accuracy with Cross-Validation</a></li>
  </ul></li>
  <li><a href="#end-to-end-workflow" id="toc-end-to-end-workflow" class="nav-link" data-scroll-target="#end-to-end-workflow">9 - End-to-End Workflow</a>
  <ul class="collapse">
  <li><a href="#synthetic-time-series-for-demonstration" id="toc-synthetic-time-series-for-demonstration" class="nav-link" data-scroll-target="#synthetic-time-series-for-demonstration">Synthetic Time Series for Demonstration</a></li>
  <li><a href="#temporal-split-and-naive-benchmark" id="toc-temporal-split-and-naive-benchmark" class="nav-link" data-scroll-target="#temporal-split-and-naive-benchmark">Temporal Split and Naive Benchmark</a></li>
  <li><a href="#theta-forecasting-model" id="toc-theta-forecasting-model" class="nav-link" data-scroll-target="#theta-forecasting-model">Theta forecasting model</a>
  <ul class="collapse">
  <li><a href="#key-objects-assumed-from-earlier-cells" id="toc-key-objects-assumed-from-earlier-cells" class="nav-link" data-scroll-target="#key-objects-assumed-from-earlier-cells">Key objects assumed from earlier cells</a></li>
  <li><a href="#baseline-metric-mape" id="toc-baseline-metric-mape" class="nav-link" data-scroll-target="#baseline-metric-mape">Baseline metric: MAPE</a></li>
  <li><a href="#why-multiplicative-seasonality-is-problematic-here" id="toc-why-multiplicative-seasonality-is-problematic-here" class="nav-link" data-scroll-target="#why-multiplicative-seasonality-is-problematic-here">Why “multiplicative seasonality” is problematic here</a></li>
  <li><a href="#model-a-thetaforecaster-no-deseasonalization" id="toc-model-a-thetaforecaster-no-deseasonalization" class="nav-link" data-scroll-target="#model-a-thetaforecaster-no-deseasonalization">Model A — ThetaForecaster (no deseasonalization)</a></li>
  <li><a href="#comparing-models-and-choosing-the-winner" id="toc-comparing-models-and-choosing-the-winner" class="nav-link" data-scroll-target="#comparing-models-and-choosing-the-winner">Comparing models and choosing the winner</a></li>
  <li><a href="#where-ets-fits-conceptually-mentioned-in-comments" id="toc-where-ets-fits-conceptually-mentioned-in-comments" class="nav-link" data-scroll-target="#where-ets-fits-conceptually-mentioned-in-comments">Where ETS fits conceptually (mentioned in comments)</a></li>
  <li><a href="#practical-checklist" id="toc-practical-checklist" class="nav-link" data-scroll-target="#practical-checklist">Practical checklist</a></li>
  </ul></li>
  <li><a href="#exponential-smoothing-ets-model" id="toc-exponential-smoothing-ets-model" class="nav-link" data-scroll-target="#exponential-smoothing-ets-model">Exponential Smoothing (ETS) model</a>
  <ul class="collapse">
  <li><a href="#why-ets-here" id="toc-why-ets-here" class="nav-link" data-scroll-target="#why-ets-here">Why ETS here</a></li>
  <li><a href="#the-etsaaa-with-damping-state-space-equations" id="toc-the-etsaaa-with-damping-state-space-equations" class="nav-link" data-scroll-target="#the-etsaaa-with-damping-state-space-equations">The ETS(A,A,A) with damping: state-space equations</a></li>
  <li><a href="#fit-forecast-and-horizon" id="toc-fit-forecast-and-horizon" class="nav-link" data-scroll-target="#fit-forecast-and-horizon">Fit, forecast, and horizon</a></li>
  <li><a href="#accuracy-metric-mape" id="toc-accuracy-metric-mape" class="nav-link" data-scroll-target="#accuracy-metric-mape">Accuracy metric: MAPE</a></li>
  <li><a href="#model-selection-by-metric" id="toc-model-selection-by-metric" class="nav-link" data-scroll-target="#model-selection-by-metric">Model selection by metric</a></li>
  <li><a href="#practical-intuition" id="toc-practical-intuition" class="nav-link" data-scroll-target="#practical-intuition">Practical intuition</a></li>
  </ul></li>
  <li><a href="#time-series-cross-validation-2" id="toc-time-series-cross-validation-2" class="nav-link" data-scroll-target="#time-series-cross-validation-2">Time-Series Cross Validation</a>
  <ul class="collapse">
  <li><a href="#time-series-cross-validation-rolling-origin" id="toc-time-series-cross-validation-rolling-origin" class="nav-link" data-scroll-target="#time-series-cross-validation-rolling-origin">Time-series cross-validation (rolling origin)</a></li>
  <li><a href="#calendar-of-folds-what-dates-were-used" id="toc-calendar-of-folds-what-dates-were-used" class="nav-link" data-scroll-target="#calendar-of-folds-what-dates-were-used">Calendar of folds (what dates were used)</a></li>
  <li><a href="#candidate-forecasters" id="toc-candidate-forecasters" class="nav-link" data-scroll-target="#candidate-forecasters">Candidate forecasters</a></li>
  <li><a href="#cross-validated-backtest-routine" id="toc-cross-validated-backtest-routine" class="nav-link" data-scroll-target="#cross-validated-backtest-routine">Cross-validated backtest routine</a></li>
  <li><a href="#running-cv-for-all-models-and-joining-fold-dates" id="toc-running-cv-for-all-models-and-joining-fold-dates" class="nav-link" data-scroll-target="#running-cv-for-all-models-and-joining-fold-dates">Running CV for all models and joining fold dates</a></li>
  <li><a href="#model-level-summary" id="toc-model-level-summary" class="nav-link" data-scroll-target="#model-level-summary">Model-level summary</a></li>
  <li><a href="#deliverables-printed" id="toc-deliverables-printed" class="nav-link" data-scroll-target="#deliverables-printed">Deliverables printed</a></li>
  <li><a href="#why-this-setup-is-correct-for-forecasting" id="toc-why-this-setup-is-correct-for-forecasting" class="nav-link" data-scroll-target="#why-this-setup-is-correct-for-forecasting">Why this setup is correct for forecasting</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




#
<center>
<a class="tocSkip">
</a></center><a class="tocSkip">
#
<center>
MGMT474 Predictive Analytics
</center>
#
<center>
Time Series
</center>
#
<center>
Professor: Davi Moreira
</center>
<hr>
<center>
<div>
<p><img src="https://raw.githubusercontent.com/davi-moreira/2025F_predictive_analytics_purdue_MGMT474/main/images/mgmt_474_ai_logo_02-modified.png" width="200"></p>
</div>
</center>
</a><p><a class="tocSkip">This lecture material was developed with reference to </a><a href="https://otexts.com/fpppy/"><em>Forecasting: Principles and Practice, the Pythonic Way</em></a>, <a href="https://www.sktime.net/en/v0.20.0/users.html"><code>sktime</code> documentation</a>, <a href="https://filippomb.github.io/python-time-series-handbook/notebooks/00/intro.html"><em>Time Series Analysis with Python</em> Book</a>, <a href="https://scikit-learn.org/stable/modules/cross_validation.html#cross-validation-of-time-series-data"><code>scikit-learn</code> documentation</a>, and customized for our course-specific learning objectives. You are welcome to use, share, and expand upon this material.</p>
<p>If you want to review the Time Series topic we covered in our Business Statistics course, <a href="https://davi-moreira.github.io/2025S_business_statistics_purdue_MGMT305/lecture_slides/17_chapter_time_series/17_chapter_time_series.html#/title-slide">here you can access the lecture slides</a>.</p>
<p><strong>Have fun!</strong></p>
<section id="overview" class="level1">
<h1>Overview</h1>
<ul>
<li>core distinctions between <em>forecasting</em> and <em>generic supervised prediction</em>.</li>
</ul>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<ul>
<li>Differentiate <strong>forecasting</strong> from <strong>generic supervised prediction</strong>.<br>
</li>
<li>Specify correct <strong>evaluation protocols</strong> for time series.</li>
</ul>
</section>
</section>
<section id="forecasting-vs.-generic-supervised-prediction" class="level1">
<h1>1 - Forecasting vs.&nbsp;Generic Supervised Prediction</h1>
<section id="problem-framing-two-worlds" class="level2">
<h2 class="anchored" data-anchor-id="problem-framing-two-worlds">Problem Framing: Two Worlds</h2>
<section id="generic-supervised-prediction" class="level3">
<h3 class="anchored" data-anchor-id="generic-supervised-prediction">Generic Supervised Prediction</h3>
<ul>
<li>Predict a target from feature columns.</li>
<li>Rows assumed <strong>exchangeable</strong>; order irrelevant.</li>
<li>Standard random/stratified splits.</li>
<li>Examples: tabular regression, classification.</li>
</ul>
</section>
<section id="forecasting" class="level3">
<h3 class="anchored" data-anchor-id="forecasting">Forecasting</h3>
<ul>
<li>Predict <strong>future rows</strong> of the same variable from <strong>past rows</strong>.</li>
<li><strong>Temporal order is intrinsic</strong>; rows are not exchangeable.</li>
<li>Time-aware splits and backtesting required.</li>
<li>Examples: demand, traffic, finance, sensor data.</li>
</ul>
</section>
</section>
<section id="why-we-get-confused" class="level2">
<h2 class="anchored" data-anchor-id="why-we-get-confused">Why We Get Confused</h2>
<p>Both output numeric or categorical predictions, but <strong>data-generating processes differ</strong>.</p>
<p>Treating forecasting as generic regression <strong>ignores time order</strong> and <strong>future-unknown constraints</strong>.</p>
<p>This changes <strong>feature construction</strong>, <strong>model interfaces</strong>, and <strong>evaluation</strong>.</p>
</section>
<section id="evaluation-protocols" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-protocols">Evaluation Protocols</h2>
<section id="generic-regression" class="level3">
<h3 class="anchored" data-anchor-id="generic-regression">Generic Regression</h3>
<ul>
<li>Random/stratified splits commonly used.</li>
<li>K-fold CV with row shuffling is acceptable.</li>
</ul>
</section>
<section id="forecasting-1" class="level3">
<h3 class="anchored" data-anchor-id="forecasting-1">Forecasting</h3>
<ul>
<li><p><strong>Temporal train/test split</strong> (hold-out <em>by time</em>).</p></li>
<li><p><strong>Rolling/expanding backtests</strong> across cutpoints/horizons.</p></li>
<li><p>Random splits cause <strong>information leakage</strong> and <strong>over-optimistic scores</strong>.</p></li>
</ul>
</section>
</section>
<section id="common-pitfalls" class="level2">
<h2 class="anchored" data-anchor-id="common-pitfalls">Common Pitfalls</h2>
<ul>
<li><p><strong>Row shuffling</strong> in time series evaluation.</p></li>
<li><p><strong>Ad-hoc lagging/windowing</strong> with hidden hyperparameters.</p></li>
<li><p>Producing repeated <strong>nowcasts</strong> instead of true <strong>multi-step forecasts</strong>.</p></li>
<li><p>Failing to map predictions back to a <strong>properly indexed horizon</strong>.</p></li>
</ul>
</section>
</section>
<section id="time-series-graphics" class="level1">
<h1>2 - Time Series Graphics</h1>
<p><br> <br></p>
<blockquote class="blockquote">
<p>Source: Chapter 2 “Time series graphics” (FPP, Pythonic Way).<br>
URL: https://otexts.com/fpppy/nbs/02-graphics.html</p>
</blockquote>
<section id="load-common-libraries-and-settings" class="level2">
<h2 class="anchored" data-anchor-id="load-common-libraries-and-settings">Load common libraries and settings</h2>
<div id="cell-11" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip <span class="op">-</span>q install utilsforecast statsmodels seaborn matplotlib cycler</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-12" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="5d7db705-9aae-406b-b4db-4006682ef601" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install fpppy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: fpppy in /usr/local/lib/python3.12/dist-packages (0.0.3)
Requirement already satisfied: matplotlib in /usr/local/lib/python3.12/dist-packages (from fpppy) (3.10.0)
Requirement already satisfied: pre-commit in /usr/local/lib/python3.12/dist-packages (from fpppy) (4.3.0)
Requirement already satisfied: pytest in /usr/local/lib/python3.12/dist-packages (from fpppy) (8.4.2)
Requirement already satisfied: pytest-cov in /usr/local/lib/python3.12/dist-packages (from fpppy) (7.0.0)
Requirement already satisfied: scikit-learn in /usr/local/lib/python3.12/dist-packages (from fpppy) (1.6.1)
Requirement already satisfied: statsmodels in /usr/local/lib/python3.12/dist-packages (from fpppy) (0.14.5)
Requirement already satisfied: utilsforecast in /usr/local/lib/python3.12/dist-packages (from fpppy) (0.2.14)
Requirement already satisfied: contourpy&gt;=1.0.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (1.3.3)
Requirement already satisfied: cycler&gt;=0.10 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (4.60.1)
Requirement already satisfied: kiwisolver&gt;=1.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (1.4.9)
Requirement already satisfied: numpy&gt;=1.23 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (2.0.2)
Requirement already satisfied: packaging&gt;=20.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (25.0)
Requirement already satisfied: pillow&gt;=8 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (11.3.0)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (3.2.5)
Requirement already satisfied: python-dateutil&gt;=2.7 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (2.9.0.post0)
Requirement already satisfied: cfgv&gt;=2.0.0 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (3.4.0)
Requirement already satisfied: identify&gt;=1.0.0 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (2.6.15)
Requirement already satisfied: nodeenv&gt;=0.11.1 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (1.9.1)
Requirement already satisfied: pyyaml&gt;=5.1 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (6.0.3)
Requirement already satisfied: virtualenv&gt;=20.10.0 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (20.35.3)
Requirement already satisfied: iniconfig&gt;=1 in /usr/local/lib/python3.12/dist-packages (from pytest-&gt;fpppy) (2.1.0)
Requirement already satisfied: pluggy&lt;2,&gt;=1.5 in /usr/local/lib/python3.12/dist-packages (from pytest-&gt;fpppy) (1.6.0)
Requirement already satisfied: pygments&gt;=2.7.2 in /usr/local/lib/python3.12/dist-packages (from pytest-&gt;fpppy) (2.19.2)
Requirement already satisfied: coverage&gt;=7.10.6 in /usr/local/lib/python3.12/dist-packages (from coverage[toml]&gt;=7.10.6-&gt;pytest-cov-&gt;fpppy) (7.10.7)
Requirement already satisfied: scipy&gt;=1.6.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn-&gt;fpppy) (1.15.3)
Requirement already satisfied: joblib&gt;=1.2.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn-&gt;fpppy) (1.5.2)
Requirement already satisfied: threadpoolctl&gt;=3.1.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn-&gt;fpppy) (3.6.0)
Requirement already satisfied: pandas!=2.1.0,&gt;=1.4 in /usr/local/lib/python3.12/dist-packages (from statsmodels-&gt;fpppy) (2.2.2)
Requirement already satisfied: patsy&gt;=0.5.6 in /usr/local/lib/python3.12/dist-packages (from statsmodels-&gt;fpppy) (1.0.1)
Requirement already satisfied: pytz&gt;=2020.1 in /usr/local/lib/python3.12/dist-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels-&gt;fpppy) (2025.2)
Requirement already satisfied: tzdata&gt;=2022.7 in /usr/local/lib/python3.12/dist-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels-&gt;fpppy) (2025.2)
Requirement already satisfied: six&gt;=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil&gt;=2.7-&gt;matplotlib-&gt;fpppy) (1.17.0)
Requirement already satisfied: distlib&lt;1,&gt;=0.3.7 in /usr/local/lib/python3.12/dist-packages (from virtualenv&gt;=20.10.0-&gt;pre-commit-&gt;fpppy) (0.4.0)
Requirement already satisfied: filelock&lt;4,&gt;=3.12.2 in /usr/local/lib/python3.12/dist-packages (from virtualenv&gt;=20.10.0-&gt;pre-commit-&gt;fpppy) (3.20.0)
Requirement already satisfied: platformdirs&lt;5,&gt;=3.9.1 in /usr/local/lib/python3.12/dist-packages (from virtualenv&gt;=20.10.0-&gt;pre-commit-&gt;fpppy) (4.5.0)</code></pre>
</div>
</div>
<div id="cell-13" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ignore"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    category<span class="op">=</span><span class="pp">UserWarning</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    message<span class="op">=</span><span class="st">".*FigureCanvasAgg is non-interactive.*"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"NIXTLA_ID_AS_COL"</span>] <span class="op">=</span> <span class="st">"true"</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(suppress<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"max_colwidth"</span>, <span class="dv">100</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.precision"</span>, <span class="dv">3</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.plotting <span class="im">import</span> plot_series <span class="im">as</span> plot_series_utils</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"ggplot"</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.figsize"</span>: (<span class="dv">8</span>, <span class="dv">5</span>),</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.dpi"</span>: <span class="dv">100</span>,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"savefig.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.constrained_layout.use"</span>: <span class="va">True</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.titlesize"</span>: <span class="dv">12</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xtick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ytick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.fontsize"</span>: <span class="dv">9</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.title_fontsize"</span>: <span class="dv">10</span>,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cycler <span class="im">import</span> cycler</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co"># mpl.rcParams['axes.prop_cycle'] = cycler(color=["#000000", "#000000"])</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fpppy.utils <span class="im">import</span> plot_series</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Then, once anywhere before plotting:</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">'axes.prop_cycle'</span>] <span class="op">=</span> mpl.rcParamsDefault[<span class="st">'axes.prop_cycle'</span>]</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> pearsonr</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.graphics.tsaplots <span class="im">import</span> plot_acf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Restore the default Tableau 10 cycle</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">'axes.prop_cycle'</span>] <span class="op">=</span> mpl.rcParamsDefault[<span class="st">'axes.prop_cycle'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In any data analysis workflow, <strong>the first step is EDA with visualization</strong>. Plotting the data reveals critical insights such as:</p>
<ul>
<li><strong>Patterns and trends</strong> across time</li>
<li><strong>Outliers and anomalies</strong> that may distort interpretation</li>
<li><strong>Structural changes</strong> and seasonality in time-dependent data</li>
<li><strong>Relationships</strong> among variables</li>
</ul>
<p>These visual features guide the <strong>choice and specification of forecasting models</strong>. Effective forecasting depends on understanding what the data reveal through visualization.</p>
</section>
<section id="time-series-plots" class="level2">
<h2 class="anchored" data-anchor-id="time-series-plots">Time Series Plots</h2>
<p>For time series data, the <strong>most fundamental visualization</strong> is the <strong>time plot</strong>.</p>
<p>In a time plot, each observation is displayed against its corresponding time point, and <strong>consecutive observations are connected by straight lines</strong> to reveal patterns, trends, or irregularities over time.</p>
<p>This type of graph enables analysts to identify:</p>
<ul>
<li>Long-term trends</li>
<li>Seasonal fluctuations</li>
<li>Sudden shifts or anomalies</li>
</ul>
<p>For example, a time plot of <strong>weekly economy passenger load</strong> between <strong>Melbourne and Sydney</strong> illustrates how air travel demand evolves through time.</p>
<section id="ansett-airlines-economy-class-melbourne-sydney" class="level3">
<h3 class="anchored" data-anchor-id="ansett-airlines-economy-class-melbourne-sydney">Ansett airlines economy class: Melbourne-Sydney</h3>
<div id="cell-18" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:502}}" data-outputid="4cea937e-43d7-4b2e-81fe-84dff9c12286" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ansett <span class="op">=</span> pd.read_csv(<span class="st">"ansett.csv"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ansett[<span class="st">"ds"</span>] <span class="op">=</span> pd.to_datetime(ansett[<span class="st">"ds"</span>])</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>melsyd_economy <span class="op">=</span> ansett.query(<span class="st">'Airports == "MEL-SYD" &amp; Class == "Economy"'</span>).copy()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>melsyd_economy[<span class="st">"y"</span>] <span class="op">=</span> melsyd_economy[<span class="st">"y"</span>] <span class="op">/</span> <span class="dv">1000</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>plot_series(df<span class="op">=</span>melsyd_economy,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            id_col<span class="op">=</span><span class="st">"Airports"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>            time_col<span class="op">=</span><span class="st">"ds"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            target_col<span class="op">=</span><span class="st">"y"</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            ylabel<span class="op">=</span><span class="st">"Passengers ('000)"</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>            xlabel<span class="op">=</span><span class="st">"Week [1W]"</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"Ansett airlines economy class: Melbourne-Sydney"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ansett-airlines-economy-class-melbourne-sydney-1" class="level3">
<h3 class="anchored" data-anchor-id="ansett-airlines-economy-class-melbourne-sydney-1">Ansett airlines economy class: Melbourne-Sydney</h3>
<p>This plot reveals some interesting features.</p>
<ul>
<li><p>There was a period in 1989 when no passengers were carried — this was due to an industrial dispute.</p></li>
<li><p>There was a period of reduced load in 1992. This was due to a trial in which some economy class seats were replaced by business class seats.</p></li>
<li><p>A large increase in passenger load occurred in the second half of 1991.</p></li>
<li><p>There are some large dips in load around the start of each year. These are due to holiday effects.</p></li>
<li><p>There is a long-term fluctuation in the level of the series which increases during 1987, decreases in 1989, and increases again through 1990 and 1991.</p></li>
</ul>
<p>Any model will need to take all these features into account in order to effectively forecast the passenger load into the future.</p>
</section>
<section id="australian-antidiabetic-drug-sales" class="level3">
<h3 class="anchored" data-anchor-id="australian-antidiabetic-drug-sales">Australian antidiabetic drug sales</h3>
<div id="cell-22" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:502}}" data-outputid="a384b403-3644-431d-e6b0-b91b0afb1f81" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>total_cost_df <span class="op">=</span> pd.read_csv(<span class="st">"total_cost_df.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"Month"</span>])</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>total_cost_df[<span class="st">"unique_id"</span>] <span class="op">=</span> <span class="st">"total_cost"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>plot_series(total_cost_df,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>            id_col<span class="op">=</span><span class="st">"unique_id"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>            time_col<span class="op">=</span><span class="st">"Month"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            target_col<span class="op">=</span><span class="st">"Cost"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>            xlabel<span class="op">=</span><span class="st">"Month [1M]"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>            ylabel<span class="op">=</span><span class="st">"$ (millions)"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"Australian antidiabetic drug sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="australian-antidiabetic-drug-sales-1" class="level3">
<h3 class="anchored" data-anchor-id="australian-antidiabetic-drug-sales-1">Australian antidiabetic drug sales</h3>
<p>This example shows a <strong>clear upward trend</strong> combined with a <strong>strong seasonal component</strong> whose amplitude increases with the overall level of the series.</p>
<p>A <strong>sharp drop at the beginning of each year</strong> results from a government <strong>subsidisation policy</strong>, which encourages patients to <strong>stockpile medications</strong> before year-end.</p>
<p>When forecasting such data, the model must capture:</p>
<ul>
<li>The <strong>seasonal pattern</strong> and its <strong>changing magnitude</strong></li>
<li>The <strong>gradual evolution of the trend</strong> over time</li>
</ul>
</section>
</section>
</section>
<section id="time-series-patterns" class="level1">
<h1>3 - Time Series Patterns</h1>
<p>When analyzing time series data, we frequently refer to <strong>trend</strong>, <strong>seasonal</strong>, and <strong>cyclic</strong> components. These concepts define the underlying structure of temporal behavior.</p>
<section id="trend" class="level2">
<h2 class="anchored" data-anchor-id="trend"><strong>Trend</strong></h2>
<p>A <strong>trend</strong> represents a long-term increase or decrease in the data.</p>
<ul>
<li>It may be <strong>linear or nonlinear</strong>.</li>
<li>A trend can <strong>change direction</strong>, shifting from growth to decline or vice versa.</li>
<li>Example: The <strong>antidiabetic drug sales</strong> (Figure 2.2) show a steady upward trend.</li>
</ul>
</section>
<section id="seasonal" class="level2">
<h2 class="anchored" data-anchor-id="seasonal"><strong>Seasonal</strong></h2>
<p>A <strong>seasonal pattern</strong> arises from <strong>systematic calendar-based effects</strong> such as:</p>
<ul>
<li>Time of year</li>
<li>Day of week</li>
<li>Hour of day</li>
</ul>
<p>Seasonality has a <strong>fixed and known period</strong>, and a series can exhibit <strong>multiple seasonalities</strong> (e.g., yearly and weekly). Example: The <strong>monthly antidiabetic drug sales</strong> display seasonality influenced by <strong>year-end cost changes</strong>.</p>
</section>
<section id="cyclic" class="level2">
<h2 class="anchored" data-anchor-id="cyclic"><strong>Cyclic</strong></h2>
<p>A <strong>cycle</strong> involves <strong>rises and falls with no fixed frequency</strong>, often linked to <strong>economic conditions</strong> such as the <strong>business cycle</strong>.</p>
<ul>
<li>Cycles usually last <strong>two years or more</strong>.</li>
<li>The <strong>magnitude and duration</strong> of cycles are <strong>less regular</strong> than seasonal patterns.</li>
</ul>
</section>
<section id="key-distinction" class="level2">
<h2 class="anchored" data-anchor-id="key-distinction"><strong>Key Distinction</strong></h2>
<ul>
<li><p>If fluctuations occur at a <strong>fixed, calendar-based frequency</strong>, they are <strong>seasonal</strong>.</p></li>
<li><p>If they occur at a <strong>variable frequency</strong>, they are <strong>cyclic</strong>.</p></li>
</ul>
</section>
<section id="practical-insight" class="level2">
<h2 class="anchored" data-anchor-id="practical-insight"><strong>Practical Insight</strong></h2>
<p>Most real-world time series combine <strong>trend</strong>, <strong>seasonal</strong>, and <strong>cyclic</strong> components.</p>
<p>When selecting a forecasting model, it is essential to first <strong>identify these patterns</strong> and then apply a method capable of <strong>capturing their combined effects</strong>.</p>
</section>
<section id="four-examples-of-time-series-showing-different-patterns" class="level2">
<h2 class="anchored" data-anchor-id="four-examples-of-time-series-showing-different-patterns">Four examples of time series showing different patterns</h2>
<center>
<div>
<p><img src="https://raw.githubusercontent.com/davi-moreira/2025F_predictive_analytics_purdue_MGMT474/main/lecture_slides/figs/fourexamples-output-1.png" width="200"></p>
</div>
</center>
<p>XXX include fig fourexamples-output-1 XXXX</p>
</section>
<section id="four-examples-of-time-series-showing-different-patterns-1" class="level2">
<h2 class="anchored" data-anchor-id="four-examples-of-time-series-showing-different-patterns-1">Four Examples of Time Series Showing Different Patterns</h2>
<ol type="1">
<li><p><strong>Monthly Housing Sales (Top Left)</strong></p>
<ul>
<li>Exhibit <strong>strong seasonality</strong> within each year.</li>
<li>Display <strong>cyclic behavior</strong> with a period of approximately <strong>6–10 years</strong>.</li>
<li>Show <strong>no clear long-term trend</strong> over the observed period.</li>
</ul></li>
<li><p><strong>US Treasury Bill Contracts (Top Right)</strong></p>
<ul>
<li>Reflect data from the <strong>Chicago market</strong> over <strong>100 trading days in 1981</strong>.</li>
<li>Show <strong>no seasonality</strong>, but a <strong>clear downward trend</strong>.</li>
<li>With a longer horizon, this trend could represent part of a <strong>larger economic cycle</strong>.</li>
</ul></li>
<li><p><strong>Australian Quarterly Electricity Production (Bottom Left)</strong></p>
<ul>
<li>Demonstrates a <strong>strong upward trend</strong> coupled with <strong>pronounced seasonality</strong>.</li>
<li><strong>No visible cyclic pattern</strong>, suggesting stable periodicity tied to seasonal factors.</li>
</ul></li>
<li><p><strong>Daily Change in Google Closing Stock Price (Bottom Right)</strong></p>
<ul>
<li>Displays <strong>no trend</strong>, <strong>no seasonality</strong>, and <strong>no cyclic behavior</strong>.</li>
<li>Characterized by <strong>random fluctuations</strong>, lacking predictable patterns suitable for traditional forecasting.</li>
</ul></li>
</ol>
</section>
<section id="lag-plots" class="level2">
<h2 class="anchored" data-anchor-id="lag-plots">Lag plots</h2>
<section id="lagged-scatterplots-for-quarterly-beer-production." class="level3">
<h3 class="anchored" data-anchor-id="lagged-scatterplots-for-quarterly-beer-production.">Lagged scatterplots for quarterly beer production.</h3>
<div id="cell-34" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:842}}" data-outputid="8b388fa7-1e5c-49d2-f1d4-8931554ca8a2" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Read and parse dates</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>aus_production <span class="op">=</span> pd.read_csv(<span class="st">"aus_production.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Filter by calendar year (not by string/int compare)</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>recent_production <span class="op">=</span> (</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    aus_production.loc[aus_production[<span class="st">"ds"</span>].dt.year <span class="op">&gt;=</span> <span class="dv">2000</span>, [<span class="st">"ds"</span>, <span class="st">"Beer"</span>]]</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"Beer"</span>: <span class="st">"y"</span>})</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Time-derived fields</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>recent_production[<span class="st">"Quarter"</span>] <span class="op">=</span> recent_production[<span class="st">"ds"</span>].dt.quarter</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Build lags</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lag <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>):</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    recent_production[<span class="ss">f"lag_</span><span class="sc">{</span>lag<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> recent_production[<span class="st">"y"</span>].shift(lag)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>lags <span class="op">=</span> [<span class="ss">f"lag_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>)]</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Drop rows with NaNs (from shifting) for plotting and limits</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">=</span> recent_production[[<span class="st">"y"</span>, <span class="st">"Quarter"</span>, <span class="op">*</span>lags]].dropna()</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Limits ignoring NaNs</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>lims <span class="op">=</span> [</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    np.nanmin([plot_df[lag].<span class="bu">min</span>() <span class="cf">for</span> lag <span class="kw">in</span> lags] <span class="op">+</span> [plot_df[<span class="st">"y"</span>].<span class="bu">min</span>()]),</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    np.nanmax([plot_df[lag].<span class="bu">max</span>() <span class="cf">for</span> lag <span class="kw">in</span> lags] <span class="op">+</span> [plot_df[<span class="st">"y"</span>].<span class="bu">max</span>()]),</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Lag plots</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, lag <span class="kw">in</span> <span class="bu">zip</span>(axes.flatten(), lags):</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    ax.scatter(plot_df[lag], plot_df[<span class="st">"y"</span>], c<span class="op">=</span>plot_df[<span class="st">"Quarter"</span>], cmap<span class="op">=</span><span class="st">"viridis"</span>)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    ax.plot(lims, lims, <span class="st">"grey"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    ax.set_title(lag)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipython-input-87298660.py:39: UserWarning: The figure layout has changed to tight
  plt.tight_layout()</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-8-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="lagged-scatterplots-for-quarterly-beer-production" class="level3">
<h3 class="anchored" data-anchor-id="lagged-scatterplots-for-quarterly-beer-production">Lagged Scatterplots for Quarterly Beer Production</h3>
<p>This plot presents <strong>scatterplots of quarterly Australian beer production</strong>, where the <strong>horizontal axis</strong> represents <strong>lagged values</strong> of the series.</p>
<p>Each graph displays <strong><span class="math inline">\(y_t\)</span> plotted against <span class="math inline">\(y_{t-k}\)</span></strong> for various lag values <span class="math inline">\(k\)</span>.</p>
<ul>
<li><strong>Color coding</strong> indicates the <strong>quarter</strong> corresponding to the observation on the vertical axis.</li>
<li>A <strong>strong positive relationship</strong> appears at <strong>lags 4 and 8</strong>, revealing the <strong>seasonal pattern</strong> that repeats annually.</li>
<li><strong>Negative relationships</strong> at <strong>lags 2 and 6</strong> occur because <strong>peaks (Q4)</strong> are compared with <strong>troughs (Q2)</strong>, emphasizing the alternation between seasonal highs and lows.</li>
</ul>
</section>
</section>
<section id="autocorrelation" class="level2">
<h2 class="anchored" data-anchor-id="autocorrelation">Autocorrelation</h2>
<p><strong>Autocorrelation</strong> quantifies the <strong>linear relationship between lagged observations</strong> of the same time series, analogous to how standard correlation measures relationships between two different variables.</p>
<p>For each lag <span class="math inline">\(k\)</span>, there is an <strong>autocorrelation coefficient</strong> <span class="math inline">\(r_k\)</span>:</p>
<ul>
<li><span class="math inline">\(r_1\)</span> measures the relationship between <span class="math inline">\(y_t\)</span> and <span class="math inline">\(y_{t-1}\)</span></li>
<li><span class="math inline">\(r_2\)</span> measures the relationship between <span class="math inline">\(y_t\)</span> and <span class="math inline">\(y_{t-2}\)</span></li>
<li>and so on</li>
</ul>
<p>The general formula for the <span class="math inline">\(k\)</span>-th autocorrelation is:</p>
<p><span class="math display">\[
r_k ;=;
\frac{\displaystyle \sum_{t=k+1}^{T} (y_t-\bar{y})(y_{t-k}-\bar{y})}
{\displaystyle \sum_{t=1}^{T} (y_t-\bar{y})^2},
\]</span></p>
<p>where <span class="math inline">\(T\)</span> denotes the length of the time series.</p>
<p>The complete set of autocorrelation coefficients forms the <strong>Autocorrelation Function (ACF)</strong>, which summarizes how current values relate to past values across different lags.</p>
<p>For instance, in the <strong>beer production dataset</strong>, the ACF can be computed directly using the <code>acf()</code> function.</p>
<div id="cell-37" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:362}}" data-outputid="f6fda044-da4f-46cd-f4d5-c9cc8b8dc75a" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>acf_df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"Lag"</span>: <span class="bu">range</span>(<span class="dv">10</span>), <span class="st">"ACF"</span>: sm.tsa.acf(recent_production[<span class="st">"y"</span>].dropna(), nlags<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        fft<span class="op">=</span><span class="va">False</span>, bartlett_confint<span class="op">=</span><span class="va">False</span>)}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>).set_index(<span class="st">"Lag"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>acf_df[<span class="dv">1</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div id="df-095b5a54-226c-42b5-9c6c-6a97621ae4c3" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ACF</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Lag</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.053</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.758</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.026</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>0.802</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>-0.077</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>-0.657</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>0.001</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8</td>
<td>0.707</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>-0.089</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-095b5a54-226c-42b5-9c6c-6a97621ae4c3')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-095b5a54-226c-42b5-9c6c-6a97621ae4c3 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-095b5a54-226c-42b5-9c6c-6a97621ae4c3');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-44cd8e95-258b-41b1-8590-e84298d1084f">
      <button class="colab-df-quickchart" onclick="quickchart('df-44cd8e95-258b-41b1-8590-e84298d1084f')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-44cd8e95-258b-41b1-8590-e84298d1084f button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
<p>The values in the <code>ACF</code> column are <span class="math inline">\(r_1, \ldots, r_9\)</span>, corresponding to the nine scatterplots in Figure 2.19. We usually plot the ACF to see how the correlations change with the lag <span class="math inline">\(k\)</span>. The plot is sometimes known as a <em>correlogram</em>.</p>
<section id="autocorrelation-function-for-quarterly-beer-production." class="level3">
<h3 class="anchored" data-anchor-id="autocorrelation-function-for-quarterly-beer-production.">Autocorrelation function for quarterly beer production.</h3>
<div id="cell-40" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:528}}" data-outputid="11c959bd-caa3-490c-8fcf-9c046fa80fd1" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>plot_acf(recent_production[<span class="st">"y"</span>].dropna(), lags<span class="op">=</span><span class="dv">16</span>, ax<span class="op">=</span>ax,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>         zero<span class="op">=</span><span class="va">False</span>, bartlett_confint<span class="op">=</span><span class="va">False</span>, auto_ylims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Autocorrelation Function for Beer"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Lags"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"ACF"</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="autocorrelation-function-for-quarterly-beer-production.-1" class="level3">
<h3 class="anchored" data-anchor-id="autocorrelation-function-for-quarterly-beer-production.-1">Autocorrelation function for quarterly beer production.</h3>
<ul>
<li><p><span class="math inline">\(r_4\)</span> is higher than for the other lags. This is due to the seasonal pattern in the data: the peaks tend to be four quarters apart and the troughs tend to be four quarters apart.</p></li>
<li><p><span class="math inline">\(r_2\)</span> is more negative than for the other lags because troughs tend to be two quarters behind peaks.</p></li>
<li><p>The grey area indicate whether the correlations are significantly different from zero (as explained in Section 2.9).</p></li>
</ul>
</section>
<section id="trend-and-seasonality-in-acf-plots" class="level3">
<h3 class="anchored" data-anchor-id="trend-and-seasonality-in-acf-plots">Trend and Seasonality in ACF Plots</h3>
<p>The <strong>Autocorrelation Function (ACF)</strong> reveals distinct patterns that help identify <strong>trend</strong> and <strong>seasonality</strong> in time series data.</p>
<ul>
<li><p><strong>Trend Effect:</strong></p>
<p>When a series exhibits a trend, <strong>nearby observations</strong> in time are also <strong>close in value</strong>. Consequently, <strong>autocorrelations for small lags</strong> are <strong>large and positive</strong>, and they <strong>decline gradually</strong> as the lag increases.</p></li>
<li><p><strong>Seasonality Effect:</strong></p>
<p>When a series is seasonal, <strong>autocorrelations spike</strong> at <strong>multiples of the seasonal period</strong> (e.g., lags 4, 8, 12 for quarterly data).</p></li>
<li><p><strong>Combined Effect:</strong></p>
<p>When both <strong>trend and seasonality</strong> are present, the ACF displays a <strong>slow decay</strong> due to the trend and a <strong>scalloped or wavelike pattern</strong> due to seasonality.</p></li>
</ul>
</section>
<section id="autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia" class="level3">
<h3 class="anchored" data-anchor-id="autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia">Autocorrelation function for monthly antidiabetic drug sales in Australia</h3>
<div id="cell-44" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:528}}" data-outputid="48f5ea94-605b-4581-c2ec-88c3a82678d2" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>total_cost_df <span class="op">=</span> pd.read_csv(<span class="st">"total_cost_df.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"Month"</span>])</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>plot_acf(total_cost_df[<span class="st">"Cost"</span>], lags<span class="op">=</span><span class="dv">48</span>, ax<span class="op">=</span>ax,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>         zero<span class="op">=</span><span class="va">False</span>, bartlett_confint<span class="op">=</span><span class="va">False</span>, auto_ylims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Australian antidiabetic drug sales"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Lags"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"ACF"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(bottom<span class="op">=-</span><span class="fl">0.3</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia-1" class="level3">
<h3 class="anchored" data-anchor-id="autocorrelation-function-for-monthly-antidiabetic-drug-sales-in-australia-1">Autocorrelation function for monthly antidiabetic drug sales in Australia</h3>
<ul>
<li><p>The <strong>slow decline</strong> in autocorrelation reflects the <strong>trend</strong></p></li>
<li><p>The <strong>repeating scalloped shape</strong> indicates <strong>seasonal periodicity</strong>.</p></li>
</ul>
</section>
</section>
<section id="white-noise" class="level2">
<h2 class="anchored" data-anchor-id="white-noise">White noise</h2>
<p>Time series that show no autocorrelation are called white noise.</p>
<section id="white-noise-series" class="level3">
<h3 class="anchored" data-anchor-id="white-noise-series">White noise series</h3>
<div id="cell-48" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:502}}" data-outputid="fe15c6eb-fd41-4475-ae0b-70f450c178c1" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">30</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.DataFrame({<span class="st">"wn"</span>: np.random.normal(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">50</span>), <span class="st">"ds"</span>: np.arange(<span class="dv">1</span>, <span class="dv">51</span>)})</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>y[<span class="st">"unique_id"</span>] <span class="op">=</span> <span class="st">"wn"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>plot_series(y, target_col<span class="op">=</span><span class="st">"wn"</span>, xlabel<span class="op">=</span><span class="st">"sample [1]"</span>, title<span class="op">=</span><span class="st">"White noise"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="autocorrelation-function-for-the-white-noise-series" class="level3">
<h3 class="anchored" data-anchor-id="autocorrelation-function-for-the-white-noise-series">Autocorrelation function for the white noise series</h3>
<div id="cell-50" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:528}}" data-outputid="060e052a-fc5e-43a5-c1d6-d873888e2229" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>plot_acf(y[<span class="st">"wn"</span>], lags<span class="op">=</span><span class="dv">16</span>, ax<span class="op">=</span>ax, zero<span class="op">=</span><span class="va">False</span>, bartlett_confint<span class="op">=</span><span class="va">False</span>, auto_ylims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"White Noise"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Lag[1]"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"ACF"</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="autocorrelation-function-for-the-white-noise-series-1" class="level3">
<h3 class="anchored" data-anchor-id="autocorrelation-function-for-the-white-noise-series-1">Autocorrelation Function for the White Noise Series</h3>
<p>In a <strong>white noise series</strong>, each observation is <strong>independent and identically distributed</strong>, meaning there is <strong>no predictable pattern or correlation</strong> across time.</p>
<ul>
<li><p>The <strong>autocorrelations</strong> are expected to be <strong>close to zero</strong>, though not exactly zero due to random variation.</p></li>
<li><p>For such a series, approximately <strong>95% of ACF spikes</strong> should lie within the bounds, <span class="math inline">\(\pm \frac{1.96}{\sqrt{T}}\)</span>, where <span class="math inline">\(T\)</span> is the length of the time series.</p></li>
<li><p>These <strong>confidence bounds</strong> help determine if a series is consistent with white noise.</p></li>
<li><p>If more than <strong>5% of spikes</strong> fall outside these limits, or if <strong>large spikes</strong> appear beyond them, the series likely exhibits <strong>non-random structure</strong>.</p></li>
</ul>
<p>In the plot, <strong>all but the first autocorrelation</strong> fall within the limits, confirming the data behave as <strong>white noise</strong>.</p>
</section>
</section>
</section>
<section id="time-series-decomposition" class="level1">
<h1>4 - Time Series Decomposition</h1>
<p><br> <br> <br></p>
<blockquote class="blockquote">
<p>Source: Chapter 3 “Time series decomposition” (FPP, Pythonic Way).<br>
URL: https://otexts.com/fpppy/nbs/03-decomposition.html</p>
</blockquote>
<section id="load-common-libraries-and-settings-1" class="level2">
<h2 class="anchored" data-anchor-id="load-common-libraries-and-settings-1">Load common libraries and settings</h2>
<div id="cell-54" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="dcfe3e3e-6c58-4fea-dcb2-d092cd03d4f8" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip <span class="op">-</span>q install utilsforecast statsmodels seaborn matplotlib cycler</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install fpppy</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure these are available:</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - boxcox() function — For applying Box–Cox transformations</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - boxcox_lambda() function — For finding optimal Box–Cox transformation parameters</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - plot_series() utility — For creating time series visualizations</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys, importlib, subprocess</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _pip_install(pkg):</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    subprocess.run([sys.executable, <span class="st">"-m"</span>, <span class="st">"pip"</span>, <span class="st">"install"</span>, <span class="st">"-qU"</span>, pkg], check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) coreforecast: boxcox, boxcox_lambda</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> coreforecast.scalers <span class="im">import</span> boxcox, boxcox_lambda</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    _pip_install(<span class="st">"coreforecast"</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> coreforecast.scalers <span class="im">import</span> boxcox, boxcox_lambda</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) plot_series utility: prefer fpppy.utils, fallback to utilsforecast.plotting</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> fpppy.utils <span class="im">import</span> plot_series  <span class="co"># if you have the FPP(Pythonic) helpers</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> utilsforecast.plotting <span class="im">import</span> plot_series  <span class="co"># fallback</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        _pip_install(<span class="st">"utilsforecast matplotlib pandas numpy"</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> utilsforecast.plotting <span class="im">import</span> plot_series</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="co"># --- quick smoke test / confirmation ---</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _has_callable(obj):</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">callable</span>(obj)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"• boxcox() function —"</span>, <span class="st">"OK"</span> <span class="cf">if</span> _has_callable(boxcox) <span class="cf">else</span> <span class="st">"MISSING"</span>)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"• boxcox_lambda() function —"</span>, <span class="st">"OK"</span> <span class="cf">if</span> _has_callable(boxcox_lambda) <span class="cf">else</span> <span class="st">"MISSING"</span>)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"• plot_series() utility —"</span>, <span class="st">"OK"</span> <span class="cf">if</span> _has_callable(plot_series) <span class="cf">else</span> <span class="st">"MISSING"</span>)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: tiny demo to verify they actually run (safe no-op)</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.array([<span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">4.0</span>, <span class="fl">8.0</span>])</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>lam <span class="op">=</span> boxcox_lambda(y, method<span class="op">=</span><span class="st">"guerrero"</span>, season_length<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> boxcox(y, lam)  <span class="co"># should not error</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: fpppy in /usr/local/lib/python3.12/dist-packages (0.0.3)
Requirement already satisfied: matplotlib in /usr/local/lib/python3.12/dist-packages (from fpppy) (3.10.0)
Requirement already satisfied: pre-commit in /usr/local/lib/python3.12/dist-packages (from fpppy) (4.3.0)
Requirement already satisfied: pytest in /usr/local/lib/python3.12/dist-packages (from fpppy) (8.4.2)
Requirement already satisfied: pytest-cov in /usr/local/lib/python3.12/dist-packages (from fpppy) (7.0.0)
Requirement already satisfied: scikit-learn in /usr/local/lib/python3.12/dist-packages (from fpppy) (1.6.1)
Requirement already satisfied: statsmodels in /usr/local/lib/python3.12/dist-packages (from fpppy) (0.14.5)
Requirement already satisfied: utilsforecast in /usr/local/lib/python3.12/dist-packages (from fpppy) (0.2.14)
Requirement already satisfied: contourpy&gt;=1.0.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (1.3.3)
Requirement already satisfied: cycler&gt;=0.10 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (4.60.1)
Requirement already satisfied: kiwisolver&gt;=1.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (1.4.9)
Requirement already satisfied: numpy&gt;=1.23 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (2.0.2)
Requirement already satisfied: packaging&gt;=20.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (25.0)
Requirement already satisfied: pillow&gt;=8 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (11.3.0)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (3.2.5)
Requirement already satisfied: python-dateutil&gt;=2.7 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (2.9.0.post0)
Requirement already satisfied: cfgv&gt;=2.0.0 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (3.4.0)
Requirement already satisfied: identify&gt;=1.0.0 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (2.6.15)
Requirement already satisfied: nodeenv&gt;=0.11.1 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (1.9.1)
Requirement already satisfied: pyyaml&gt;=5.1 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (6.0.3)
Requirement already satisfied: virtualenv&gt;=20.10.0 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (20.35.3)
Requirement already satisfied: iniconfig&gt;=1 in /usr/local/lib/python3.12/dist-packages (from pytest-&gt;fpppy) (2.1.0)
Requirement already satisfied: pluggy&lt;2,&gt;=1.5 in /usr/local/lib/python3.12/dist-packages (from pytest-&gt;fpppy) (1.6.0)
Requirement already satisfied: pygments&gt;=2.7.2 in /usr/local/lib/python3.12/dist-packages (from pytest-&gt;fpppy) (2.19.2)
Requirement already satisfied: coverage&gt;=7.10.6 in /usr/local/lib/python3.12/dist-packages (from coverage[toml]&gt;=7.10.6-&gt;pytest-cov-&gt;fpppy) (7.10.7)
Requirement already satisfied: scipy&gt;=1.6.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn-&gt;fpppy) (1.15.3)
Requirement already satisfied: joblib&gt;=1.2.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn-&gt;fpppy) (1.5.2)
Requirement already satisfied: threadpoolctl&gt;=3.1.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn-&gt;fpppy) (3.6.0)
Requirement already satisfied: pandas!=2.1.0,&gt;=1.4 in /usr/local/lib/python3.12/dist-packages (from statsmodels-&gt;fpppy) (2.2.2)
Requirement already satisfied: patsy&gt;=0.5.6 in /usr/local/lib/python3.12/dist-packages (from statsmodels-&gt;fpppy) (1.0.1)
Requirement already satisfied: pytz&gt;=2020.1 in /usr/local/lib/python3.12/dist-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels-&gt;fpppy) (2025.2)
Requirement already satisfied: tzdata&gt;=2022.7 in /usr/local/lib/python3.12/dist-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels-&gt;fpppy) (2025.2)
Requirement already satisfied: six&gt;=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil&gt;=2.7-&gt;matplotlib-&gt;fpppy) (1.17.0)
Requirement already satisfied: distlib&lt;1,&gt;=0.3.7 in /usr/local/lib/python3.12/dist-packages (from virtualenv&gt;=20.10.0-&gt;pre-commit-&gt;fpppy) (0.4.0)
Requirement already satisfied: filelock&lt;4,&gt;=3.12.2 in /usr/local/lib/python3.12/dist-packages (from virtualenv&gt;=20.10.0-&gt;pre-commit-&gt;fpppy) (3.20.0)
Requirement already satisfied: platformdirs&lt;5,&gt;=3.9.1 in /usr/local/lib/python3.12/dist-packages (from virtualenv&gt;=20.10.0-&gt;pre-commit-&gt;fpppy) (4.5.0)
• boxcox() function — OK
• boxcox_lambda() function — OK
• plot_series() utility — OK</code></pre>
</div>
</div>
<div id="cell-55" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys, subprocess</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pip_install(<span class="op">*</span>pkgs):</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    subprocess.run([sys.executable, <span class="st">"-m"</span>, <span class="st">"pip"</span>, <span class="st">"install"</span>, <span class="st">"-qU"</span>, <span class="op">*</span>pkgs], check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># tsfeatures is published by Nixtla. These are commonly used together:</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>pip_install(<span class="st">"tsfeatures"</span>, <span class="st">"statsforecast"</span>, <span class="st">"coreforecast"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-56" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load common libraries and settings</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ignore"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    category<span class="op">=</span><span class="pp">UserWarning</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    message<span class="op">=</span><span class="st">".*FigureCanvasAgg is non-interactive.*"</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"NIXTLA_ID_AS_COL"</span>] <span class="op">=</span> <span class="st">"true"</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(suppress<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"max_colwidth"</span>, <span class="dv">100</span>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.precision"</span>, <span class="dv">3</span>)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.plotting <span class="im">import</span> plot_series <span class="im">as</span> plot_series_utils</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"ggplot"</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.figsize"</span>: (<span class="dv">8</span>, <span class="dv">5</span>),</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.dpi"</span>: <span class="dv">100</span>,</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"savefig.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.constrained_layout.use"</span>: <span class="va">True</span>,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.titlesize"</span>: <span class="dv">12</span>,</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xtick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ytick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.fontsize"</span>: <span class="dv">9</span>,</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.title_fontsize"</span>: <span class="dv">10</span>,</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cycler <span class="im">import</span> cycler</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="co">#mpl.rcParams['axes.prop_cycle'] = cycler(color=["#000000", "#000000"])</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Then, once anywhere before plotting:</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">'axes.prop_cycle'</span>] <span class="op">=</span> mpl.rcParamsDefault[<span class="st">'axes.prop_cycle'</span>]</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fpppy.utils <span class="im">import</span> plot_series</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="introduction-1" class="level2">
<h2 class="anchored" data-anchor-id="introduction-1">Introduction</h2>
<p>Time series data often display <strong>multiple overlapping patterns</strong>, which can be better understood by <strong>decomposing</strong> the series into separate components representing distinct underlying behaviors.</p>
</section>
<section id="introduction-2" class="level2">
<h2 class="anchored" data-anchor-id="introduction-2">Introduction</h2>
<p>We typically identify three main pattern types:</p>
<ul>
<li><p><strong>Trend</strong> — long-term movement or direction.</p></li>
<li><p><strong>Seasonality</strong> — systematic, calendar-based fluctuations.</p></li>
<li><p><strong>Cycles</strong> — irregular long-term oscillations, often linked to economic or structural forces.</p></li>
</ul>
</section>
<section id="introduction-3" class="level2">
<h2 class="anchored" data-anchor-id="introduction-3">Introduction</h2>
<p>In decomposition, the <strong>trend and cycle</strong> are usually combined into a single <strong>trend–cycle component</strong> (commonly referred to simply as the <em>trend</em>). Thus, a time series can be expressed as consisting of:</p>
<ol type="1">
<li>A <strong>trend–cycle component</strong>,</li>
<li>A <strong>seasonal component</strong>, and</li>
<li>A <strong>remainder component</strong>, which captures random or irregular variations.</li>
</ol>
<p>For high-frequency data (e.g., daily observations), there may be <strong>multiple seasonal components</strong> corresponding to different periodicities (daily, weekly, annual, etc.).</p>
</section>
<section id="introduction-4" class="level2">
<h2 class="anchored" data-anchor-id="introduction-4">Introduction</h2>
<p>Decomposition serves two key purposes:</p>
<ul>
<li><p>To <strong>enhance interpretability</strong> by revealing structural elements of the data.</p></li>
<li><p>To <strong>improve forecasting accuracy</strong> by modeling each component separately.</p></li>
</ul>
<p>Before performing decomposition, it is often useful to <strong>transform or adjust</strong> the series to simplify interpretation and ensure that subsequent analyses are more reliable and stable.</p>
<div id="cell-61" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load additional libraries</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> calendar</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tsfeatures <span class="im">import</span> <span class="op">*</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> STL</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> coreforecast.scalers <span class="im">import</span> boxcox, boxcox_lambda</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> seasonal_decompose</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="time-series-components" class="level2">
<h2 class="anchored" data-anchor-id="time-series-components">Time Series Components</h2>
<p>In time series analysis, the data can be expressed as a combination of underlying components that represent different types of structure.</p>
<section id="additive-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="additive-decomposition"><strong>Additive Decomposition</strong></h3>
<p><span class="math display">\[
y_t = S_t + T_t + R_t,
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(y_t\)</span> = observed value at time <span class="math inline">\(t\)</span>,</li>
<li><span class="math inline">\(S_t\)</span> = seasonal component,</li>
<li><span class="math inline">\(T_t\)</span> = trend–cycle component,</li>
<li><span class="math inline">\(R_t\)</span> = remainder (irregular) component.</li>
</ul>
<p>The <strong>additive model</strong> is appropriate when the <strong>amplitude of seasonal and random variations remains constant</strong> regardless of the level of the series.</p>
</section>
<section id="multiplicative-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="multiplicative-decomposition"><strong>Multiplicative Decomposition</strong></h3>
<p><span class="math display">\[
y_t = S_t \times T_t \times R_t.
\]</span></p>
<p>The <strong>multiplicative model</strong> is suitable when <strong>seasonal or irregular variations increase or decrease proportionally</strong> with the level of the series — a pattern commonly observed in <strong>economic data</strong>.</p>
</section>
<section id="log-transformation-equivalence" class="level3">
<h3 class="anchored" data-anchor-id="log-transformation-equivalence"><strong>Log Transformation Equivalence</strong></h3>
<p>A multiplicative relationship can be converted into an additive one by applying a <strong>logarithmic transformation</strong>:</p>
<p><span class="math display">\[
y_t = S_t \times T_t \times R_t
\Longleftrightarrow
\log y_t = \log S_t + \log T_t + \log R_t.
\]</span></p>
<p>Thus, stabilizing variance via a transformation enables the use of <strong>additive decomposition</strong> even for series with <strong>proportional variability</strong>.</p>
</section>
<section id="example-employment-in-the-us-retail-sector" class="level3">
<h3 class="anchored" data-anchor-id="example-employment-in-the-us-retail-sector">Example: Employment in the US Retail Sector</h3>
<p>Before exploring specific decomposition methods for estimating the components <span class="math inline">\(S_t\)</span>, <span class="math inline">\(T_t\)</span>, and <span class="math inline">\(R_t\)</span>, it is useful to examine a concrete example.</p>
<p>The dataset under analysis represents the <strong>total monthly number of persons employed (in thousands)</strong> in the <strong>US retail sector</strong> since <strong>1990</strong>.</p>
<p>By decomposing this series (as illustrated in Figure), we can observe how:</p>
<ul>
<li><span class="math inline">\(T_t\)</span> captures the <strong>long-term employment trend</strong>,</li>
<li><span class="math inline">\(S_t\)</span> isolates <strong>recurring seasonal hiring patterns</strong>, and</li>
<li><span class="math inline">\(R_t\)</span> reflects <strong>irregular fluctuations</strong> not explained by the other components.</li>
</ul>
<p>This example provides a practical foundation for understanding how decomposition separates distinct sources of variation in time series data.</p>
<div id="cell-67" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:502}}" data-outputid="dcbe7905-90db-4a3f-ef79-da51b70bb5f2" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># US retail employment data and basic plot</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>us_employment <span class="op">=</span> pd.read_csv(<span class="st">"us_employment.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>us_retail_employment <span class="op">=</span> us_employment.query(<span class="st">'(unique_id == "Retail Trade") &amp; (ds &gt;= "1990-01-01")'</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>plot_series(us_retail_employment, xlabel<span class="op">=</span><span class="st">"Month [1M]"</span>, ylabel<span class="op">=</span><span class="st">"Persons (thousands)"</span>, title<span class="op">=</span><span class="st">"Total employment in US retail"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method" class="level3">
<h3 class="anchored" data-anchor-id="example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method">Example: Seasonal and Trend decomposition using Loess (STL) decomposition method</h3>
<div id="cell-69" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}}" data-outputid="8258307f-3b4d-4ed1-d81c-53869dd021f6" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># STL decomposition (default)</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>stl <span class="op">=</span> STL(us_retail_employment[<span class="st">"y"</span>], period<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> stl.fit()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>dcmp <span class="op">=</span> pd.DataFrame({</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ds"</span>: us_retail_employment[<span class="st">"ds"</span>],</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data"</span>: us_retail_employment[<span class="st">"y"</span>],</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend"</span>: res.trend,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seasonal"</span>: res.seasonal,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"remainder"</span>: res.resid</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>}).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>dcmp.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div id="df-e5b40960-1e7d-4f9c-8ebc-20dd3c3069a6" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">data</th>
<th data-quarto-table-cell-role="th">trend</th>
<th data-quarto-table-cell-role="th">seasonal</th>
<th data-quarto-table-cell-role="th">remainder</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1990-01-01</td>
<td>13255.8</td>
<td>13296.249</td>
<td>-3.700</td>
<td>-36.749</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1990-02-01</td>
<td>12966.3</td>
<td>13276.085</td>
<td>-288.398</td>
<td>-21.387</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1990-03-01</td>
<td>12938.2</td>
<td>13255.663</td>
<td>-306.658</td>
<td>-10.805</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1990-04-01</td>
<td>13012.3</td>
<td>13234.986</td>
<td>-235.775</td>
<td>13.089</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1990-05-01</td>
<td>13108.3</td>
<td>13214.071</td>
<td>-115.399</td>
<td>9.628</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-e5b40960-1e7d-4f9c-8ebc-20dd3c3069a6')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-e5b40960-1e7d-4f9c-8ebc-20dd3c3069a6 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-e5b40960-1e7d-4f9c-8ebc-20dd3c3069a6');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-032e2d7c-894c-4fa2-bafa-5a1886ec9b66">
      <button class="colab-df-quickchart" onclick="quickchart('df-032e2d7c-894c-4fa2-bafa-5a1886ec9b66')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-032e2d7c-894c-4fa2-bafa-5a1886ec9b66 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
</section>
<section id="example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-1" class="level3">
<h3 class="anchored" data-anchor-id="example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-1">Example: Seasonal and Trend decomposition using Loess (STL) decomposition method</h3>
<p>The output shows the components of an STL decomposition. The original data is shown (as data), followed by the estimated components.</p>
<p>The trend column (containing the trend-cycle <span class="math inline">\(T_t\)</span>) follows the overall movement of the series, ignoring any seasonality and random fluctuations.</p>
<div id="cell-71" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:528}}" data-outputid="ea40315a-bc20-49c1-ba5c-5a3c627593eb" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot trend vs data</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span><span class="st">"ds"</span>, y<span class="op">=</span><span class="st">"data"</span>, label<span class="op">=</span><span class="st">"Data"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span><span class="st">"ds"</span>, y<span class="op">=</span><span class="st">"trend"</span>, label<span class="op">=</span><span class="st">"Trend"</span>, color<span class="op">=</span><span class="st">"#D55E00"</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Total employment in US retail"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Month [1M]"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Persons (thousands)"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-2" class="level3">
<h3 class="anchored" data-anchor-id="example-seasonal-and-trend-decomposition-using-loess-stl-decomposition-method-2">Example: Seasonal and Trend decomposition using Loess (STL) decomposition method</h3>
<div id="cell-73" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:628}}" data-outputid="e92998d8-754c-4489-9565-f2796a13124d" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot all components</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">4</span>, ncols<span class="op">=</span><span class="dv">1</span>, sharex<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span>dcmp.index, y<span class="op">=</span><span class="st">"data"</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>])</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span>dcmp.index, y<span class="op">=</span><span class="st">"trend"</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>])</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span>dcmp.index, y<span class="op">=</span><span class="st">"seasonal"</span>, ax<span class="op">=</span>axes[<span class="dv">2</span>])</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span>dcmp.index, y<span class="op">=</span><span class="st">"remainder"</span>, ax<span class="op">=</span>axes[<span class="dv">3</span>])</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Employed"</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"trend"</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">"seasonal"</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">3</span>].set_ylabel(<span class="st">"remainder"</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"STL decomposition"</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>fig.subplots_adjust(top<span class="op">=</span><span class="fl">0.90</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="st">"Employed = trend + seasonal + remainder"</span>, ha<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">""</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-seasonal-and-trend-decomposition-using-loess-stl" class="level3">
<h3 class="anchored" data-anchor-id="example-seasonal-and-trend-decomposition-using-loess-stl">Example: Seasonal and Trend Decomposition Using Loess (STL)</h3>
<p>The <strong>STL decomposition method</strong> separates a time series into three main components — <strong>seasonal</strong>, <strong>trend–cycle</strong>, and <strong>remainder</strong> — which together reconstruct the original data.</p>
<p>In the figure, the <strong>bottom three panels</strong> display each component individually, while the <strong>top panel</strong> shows the <strong>original series</strong>.</p>
<p>Key observations:</p>
<ul>
<li>The <strong>seasonal component (<span class="math inline">\(S_t\)</span>)</strong> varies gradually over time — consecutive years exhibit similar patterns, but <strong>seasonality evolves</strong> when comparing distant years.</li>
<li>The <strong>trend–cycle component (<span class="math inline">\(T_t\)</span>)</strong> captures the <strong>underlying direction</strong> of the data, smoothing short-term fluctuations.</li>
<li>The <strong>remainder component (<span class="math inline">\(R_t\)</span>)</strong> represents <strong>unexplained irregularities</strong>, i.e., what remains after removing both the trend–cycle and seasonal effects.</li>
</ul>
<p>These components together illustrate how <strong>STL</strong> provides a flexible, data-driven approach to isolating dynamic seasonal and trend structures in time series data.</p>
</section>
</section>
<section id="seasonally-adjusted-data" class="level2">
<h2 class="anchored" data-anchor-id="seasonally-adjusted-data">Seasonally adjusted data</h2>
<p>If the seasonal component is removed from the original data, the resulting values are the “seasonally adjusted” data. For an additive decomposition, the seasonally adjusted data are given by <span class="math inline">\(y_t - S_t\)</span>, and for multiplicative data, the seasonally adjusted values are obtained using <span class="math inline">\(y_t / S_t\)</span>.</p>
<div id="cell-76" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:528}}" data-outputid="8b71bec7-ede9-4c4b-9a4a-269694ac9b7f" data-execution_count="21">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Seasonally adjusted series</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>dcmp[<span class="st">"season_adjust"</span>] <span class="op">=</span> dcmp[<span class="st">"data"</span>] <span class="op">-</span> dcmp[<span class="st">"seasonal"</span>]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span><span class="st">"ds"</span>, y<span class="op">=</span><span class="st">"data"</span>, label<span class="op">=</span><span class="st">"Data"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span><span class="st">"ds"</span>, y<span class="op">=</span><span class="st">"season_adjust"</span>, label<span class="op">=</span><span class="st">"Seasonally adjusted data"</span>, color<span class="op">=</span><span class="st">"#0072B2"</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Total employment in US retail"</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Month [1M]"</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Persons (thousands)"</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="seasonally-adjusted-data-1" class="level2">
<h2 class="anchored" data-anchor-id="seasonally-adjusted-data-1">Seasonally Adjusted Data</h2>
<p>When <strong>seasonal variation</strong> is not the focus of analysis, it is often useful to work with a <strong>seasonally adjusted series</strong>, which removes predictable seasonal effects.</p>
<p>For example, <strong>monthly unemployment figures</strong> are typically <strong>seasonally adjusted</strong> to reveal changes in the <strong>underlying economic conditions</strong> rather than regular seasonal patterns.</p>
<ul>
<li>An increase in unemployment due to <strong>school leavers entering the labor market</strong> represents <strong>seasonal variation</strong>.</li>
<li>An increase due to an <strong>economic recession</strong> reflects <strong>non-seasonal variation</strong>, which analysts seek to understand.</li>
</ul>
<p>Because of this distinction, many <strong>economic indicators</strong>, including employment data, are routinely <strong>seasonally adjusted</strong> before analysis.</p>
<section id="key-insight" class="level3">
<h3 class="anchored" data-anchor-id="key-insight">Key Insight</h3>
<p>A <strong>seasonally adjusted series</strong> combines the <strong>trend–cycle (<span class="math inline">\(T_t\)</span>)</strong> and <strong>remainder (<span class="math inline">\(R_t\)</span>)</strong> components:</p>
<p><span class="math display">\[
\text{Seasonally Adjusted Series} = T_t + R_t
\]</span></p>
<p>However, such data are <strong>not perfectly smooth</strong>, and <strong>short-term fluctuations</strong> may appear misleading.</p>
<ul>
<li>Use <strong>seasonally adjusted data</strong> to examine <strong>broad economic patterns</strong>.</li>
<li>Use the <strong>trend–cycle component</strong> to identify <strong>turning points</strong> or <strong>directional changes</strong> with greater reliability.</li>
</ul>
</section>
</section>
<section id="moving-averages" class="level2">
<h2 class="anchored" data-anchor-id="moving-averages">Moving Averages</h2>
<p>The <strong>classical method of time series decomposition</strong>, developed in the 1920s and widely used through the 1950s, remains foundational in modern decomposition techniques.</p>
<p>The first step in this classical approach is to estimate the <strong>trend–cycle component</strong> using a <strong>moving average</strong> method, which smooths out short-term fluctuations to reveal long-term patterns.</p>
<section id="moving-average-smoothing" class="level3">
<h3 class="anchored" data-anchor-id="moving-average-smoothing"><strong>Moving Average Smoothing</strong></h3>
<p>A <strong>moving average of order <span class="math inline">\(m\)</span></strong> is defined as:</p>
<p><span class="math display">\[
\hat{T}*t = \frac{1}{m}\sum*{j=-k}^{k} y_{t+j},
\]</span></p>
<p>where <span class="math inline">\(m = 2k + 1\)</span>.</p>
<p>This means that the estimated trend–cycle <span class="math inline">\(\hat{T}_t\)</span> at time <span class="math inline">\(t\)</span> is obtained by <strong>averaging observations within <span class="math inline">\(k\)</span> periods</strong> on either side of <span class="math inline">\(t\)</span>.</p>
</section>
<section id="interpretation" class="level3">
<h3 class="anchored" data-anchor-id="interpretation"><strong>Interpretation</strong></h3>
<ul>
<li><p>Nearby observations are typically <strong>similar in value</strong>, so averaging them <strong>reduces random noise</strong>.</p></li>
<li><p>The result is a <strong>smoothed version of the original series</strong>, emphasizing the <strong>underlying trend–cycle</strong>.</p></li>
<li><p>Such a moving average is referred to as an <strong><span class="math inline">\(m\)</span>-MA</strong>, or a moving average of order <span class="math inline">\(m\)</span>.</p></li>
</ul>
</section>
<section id="example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017" class="level3">
<h3 class="anchored" data-anchor-id="example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017">Example: Australian exports of goods and services (as % of GDP) from 1960–2017</h3>
<div id="cell-81" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:502}}" data-outputid="4a7b225b-9c31-4370-841a-641ec9fc3827" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Moving average smoothing example: Australian exports</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>global_economy <span class="op">=</span> pd.read_csv(<span class="st">"global_economy.csv"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>aus_exports <span class="op">=</span> global_economy.query(<span class="st">'unique_id == "Australia"'</span>)[[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"Exports"</span>]]</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>plot_series(aus_exports, target_col<span class="op">=</span><span class="st">"Exports"</span>, xlabel<span class="op">=</span><span class="st">"Year [1Y]"</span>, ylabel<span class="op">=</span><span class="st">"</span><span class="sc">% o</span><span class="st">f GDP"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"Total Australian exports"</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017-1" class="level3">
<h3 class="anchored" data-anchor-id="example-australian-exports-of-goods-and-services-as-of-gdp-from-19602017-1">Example: Australian exports of goods and services (as % of GDP) from 1960–2017</h3>
<div id="cell-83" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:582}}" data-outputid="74c22ed7-bcb5-4d68-c242-cb9650e8914b" data-execution_count="23">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Moving average smoothing example: Australian exports (table like the screenshot) ---</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep Australia, year, and exports</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>aus_exports <span class="op">=</span> (</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    global_economy</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">'unique_id == "Australia"'</span>)[[<span class="st">"ds"</span>, <span class="st">"Exports"</span>]]</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"ds"</span>: <span class="st">"Year"</span>})</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 5-term centered moving average</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>aus_exports[<span class="st">"5-MA"</span>] <span class="op">=</span> (</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    aus_exports[<span class="st">"Exports"</span>]</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    .rolling(window<span class="op">=</span><span class="dv">5</span>, center<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Round for display to match the printed table</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>tbl <span class="op">=</span> aus_exports.copy()</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>tbl[<span class="st">"Exports"</span>] <span class="op">=</span> tbl[<span class="st">"Exports"</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>tbl[<span class="st">"5-MA"</span>]    <span class="op">=</span> tbl[<span class="st">"5-MA"</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the same “head … tail” view shown in the chapter:</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>head_part <span class="op">=</span> tbl.iloc[:<span class="dv">8</span>]                      <span class="co"># 1960–1967</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>tail_part <span class="op">=</span> tbl.iloc[<span class="op">-</span><span class="dv">8</span>:]                     <span class="co"># 2010–2017</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Insert an ellipsis row between head and tail</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>ellipsis <span class="op">=</span> pd.DataFrame([{<span class="st">"Year"</span>: <span class="st">"…"</span>, <span class="st">"Exports"</span>: <span class="st">"…"</span>, <span class="st">"5-MA"</span>: <span class="st">"…"</span>}])</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>display_tbl <span class="op">=</span> pd.concat([head_part, ellipsis, tail_part], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns to match the header in the figure</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>display_tbl <span class="op">=</span> display_tbl.rename(columns<span class="op">=</span>{<span class="st">"5-MA"</span>: <span class="st">"5–MA"</span>})  <span class="co"># en-dash as in book</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the table</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>display_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div id="df-c6f5a8f1-c868-47bb-84cf-5a55513796e9" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Exports</th>
<th data-quarto-table-cell-role="th">5–MA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1960</td>
<td>12.99</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1961</td>
<td>12.4</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1962</td>
<td>13.94</td>
<td>13.46</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1963</td>
<td>13.01</td>
<td>13.5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1964</td>
<td>14.94</td>
<td>13.61</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>1965</td>
<td>13.22</td>
<td>13.4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>1966</td>
<td>12.93</td>
<td>13.25</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>1967</td>
<td>12.88</td>
<td>12.66</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2010</td>
<td>19.84</td>
<td>21.21</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2011</td>
<td>21.47</td>
<td>21.17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2012</td>
<td>21.52</td>
<td>20.78</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>2013</td>
<td>19.99</td>
<td>20.81</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>2014</td>
<td>21.08</td>
<td>20.37</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2015</td>
<td>20.01</td>
<td>20.32</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>2016</td>
<td>19.25</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>2017</td>
<td>21.27</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-c6f5a8f1-c868-47bb-84cf-5a55513796e9')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-c6f5a8f1-c868-47bb-84cf-5a55513796e9 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-c6f5a8f1-c868-47bb-84cf-5a55513796e9');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-54bf25ca-4032-45dc-83e9-b6e32841b98c">
      <button class="colab-df-quickchart" onclick="quickchart('df-54bf25ca-4032-45dc-83e9-b6e32841b98c')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-54bf25ca-4032-45dc-83e9-b6e32841b98c button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

  <div id="id_0f5805a3-176b-4706-a347-105563373d8e">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('display_tbl')" title="Generate code using this dataframe." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"></path>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_0f5805a3-176b-4706-a347-105563373d8e button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('display_tbl');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div>
</div>
</section>
<section id="example-australian-exports-of-goods-and-services-of-gdp-19602017" class="level3">
<h3 class="anchored" data-anchor-id="example-australian-exports-of-goods-and-services-of-gdp-19602017">Example: Australian Exports of Goods and Services (% of GDP), 1960–2017</h3>
<p>In this example, a <strong>moving average of order 5</strong> is used to estimate the <strong>trend–cycle</strong> component of Australia’s exports of goods and services as a percentage of GDP.</p>
<ul>
<li><p>Each entry in the <strong>5–MA column</strong> represents the <strong>average of five consecutive observations</strong>, centered on the corresponding year.</p></li>
<li><p>For example:</p>
<ul>
<li>The <strong>first 5–MA value</strong> averages data from <strong>1960–1964</strong>.</li>
<li>The <strong>second 5–MA value</strong> averages <strong>1961–1965</strong>, and so on.</li>
</ul></li>
<li><p>These values correspond to <span class="math inline">\(\hat{T}_t\)</span> with <strong><span class="math inline">\(k = 2\)</span></strong> and <strong><span class="math inline">\(m = 2k + 1 = 5\)</span></strong>.</p></li>
</ul>
<p>Because there are no observations two years before 1960 or two years after 2017, <strong>no moving averages can be computed at the series endpoints</strong>.</p>
</section>
<section id="example-australian-exports-of-goods-and-services-of-gdp-19602017-1" class="level3">
<h3 class="anchored" data-anchor-id="example-australian-exports-of-goods-and-services-of-gdp-19602017-1">Example: Australian Exports of Goods and Services (% of GDP), 1960–2017</h3>
<div id="cell-86" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:528}}" data-outputid="aed5b5f6-0c8b-44a5-f02f-951f3a0922d2" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Moving average smoothing example: Australian exports</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>global_economy <span class="op">=</span> pd.read_csv(<span class="st">"global_economy.csv"</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>aus_exports <span class="op">=</span> global_economy.query(<span class="st">'unique_id == "Australia"'</span>)[[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"Exports"</span>]]</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>plot_series(aus_exports, target_col<span class="op">=</span><span class="st">"Exports"</span>, xlabel<span class="op">=</span><span class="st">"Year [1Y]"</span>, ylabel<span class="op">=</span><span class="st">"</span><span class="sc">% o</span><span class="st">f GDP"</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"Total Australian exports"</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 5-MA</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>aus_exports[<span class="st">"5-MA"</span>] <span class="op">=</span> aus_exports[<span class="st">"Exports"</span>].rolling(window<span class="op">=</span><span class="dv">5</span>, center<span class="op">=</span><span class="va">True</span>).mean()</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>aus_exports, x<span class="op">=</span><span class="st">"ds"</span>, y<span class="op">=</span><span class="st">"Exports"</span>, label<span class="op">=</span><span class="st">"Exports"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>aus_exports, x<span class="op">=</span><span class="st">"ds"</span>, y<span class="op">=</span><span class="st">"5-MA"</span>, label<span class="op">=</span><span class="st">"5-MA"</span>, color<span class="op">=</span><span class="st">"#D55E00"</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Total Australian exports"</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Year"</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f GDP"</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-australian-exports-of-goods-and-services-of-gdp-19602017-2" class="level3">
<h3 class="anchored" data-anchor-id="example-australian-exports-of-goods-and-services-of-gdp-19602017-2">Example: Australian Exports of Goods and Services (% of GDP), 1960–2017</h3>
<p>The <strong>trend–cycle component</strong> (shown in orange) provides a <strong>smoothed representation</strong> of the original data, effectively capturing the <strong>main long-term movements</strong> while filtering out short-term noise.</p>
<p>Key insights:</p>
<ul>
<li><p>The <strong>trend–cycle</strong> is smoother than the raw series, emphasizing structural changes rather than random variation.</p></li>
<li><p>The <strong>order of the moving average (<span class="math inline">\(m\)</span>)</strong> determines the <strong>degree of smoothness</strong>:</p>
<ul>
<li>A <strong>larger <span class="math inline">\(m\)</span></strong> produces a <strong>smoother</strong> and more stable curve.</li>
<li>A <strong>smaller <span class="math inline">\(m\)</span></strong> retains <strong>more short-term variation</strong>.</li>
</ul></li>
<li><p>The Figure demonstrates how increasing the <strong>order of the moving average</strong> progressively smooths the Australian export series, clarifying the underlying trend in long-term trade performance.</p></li>
</ul>
</section>
<section id="example-australian-exports-of-goods-and-services-of-gdp-19602017-3" class="level3">
<h3 class="anchored" data-anchor-id="example-australian-exports-of-goods-and-services-of-gdp-19602017-3">Example: Australian Exports of Goods and Services (% of GDP), 1960–2017</h3>
<div id="cell-90" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:740}}" data-outputid="d23e79b7-6986-47d1-a92b-e08a6a368108" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Moving average smoothing example: Australian exports (3-, 5-, 7-, 9-MA panels) ---</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>global_economy <span class="op">=</span> pd.read_csv(<span class="st">"global_economy.csv"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>aus_exports <span class="op">=</span> global_economy.query(<span class="st">'unique_id == "Australia"'</span>)[[<span class="st">"ds"</span>, <span class="st">"Exports"</span>]].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute centered moving averages for odd windows</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> (<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">9</span>):</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    aus_exports[<span class="ss">f"</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">-MA"</span>] <span class="op">=</span> aus_exports[<span class="st">"Exports"</span>].rolling(window<span class="op">=</span>m, center<span class="op">=</span><span class="va">True</span>).mean()</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2x2 grid</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">13</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.ravel()</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, m <span class="kw">in</span> <span class="bu">zip</span>(axes, (<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">9</span>)):</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    sns.lineplot(data<span class="op">=</span>aus_exports, x<span class="op">=</span><span class="st">"ds"</span>, y<span class="op">=</span><span class="st">"Exports"</span>, ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"black"</span>, label<span class="op">=</span><span class="st">"Exports"</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    sns.lineplot(data<span class="op">=</span>aus_exports, x<span class="op">=</span><span class="st">"ds"</span>, y<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">-MA"</span>, ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"#D55E00"</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">-MA"</span>)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">-MA"</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">""</span>)  <span class="co"># set common label later</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">True</span>, which<span class="op">=</span><span class="st">"both"</span>, axis<span class="op">=</span><span class="st">"both"</span>)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Y labels only on left column</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f GDP"</span>)</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f GDP"</span>)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">""</span>)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">3</span>].set_ylabel(<span class="st">""</span>)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Common X label</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.04</span>, <span class="st">"Year"</span>, ha<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.04</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Simple moving averages such as these are usually of an odd order (e.g., 3, 5, 7, etc.). This is so they are symmetric: in a moving average of order <span class="math inline">\(m = 2k + 1\)</span>, the middle observation, and <span class="math inline">\(k\)</span> observations on either side, are averaged. But if <span class="math inline">\(m\)</span> was even, it would no longer be symmetric.</p>
</section>
</section>
<section id="classical-decomposition" class="level2">
<h2 class="anchored" data-anchor-id="classical-decomposition">Classical Decomposition</h2>
<p>The <strong>classical decomposition method</strong>, developed in the <strong>1920s</strong>, serves as the <strong>foundation for most modern time series decomposition techniques</strong>. It provides a straightforward framework for separating a time series into its underlying components.</p>
<p>There are two standard forms of classical decomposition:</p>
<ul>
<li><p><strong>Additive decomposition</strong>, where components are combined through addition.</p></li>
<li><p><strong>Multiplicative decomposition</strong>, where components interact proportionally through multiplication.</p></li>
</ul>
<p>For a time series with <strong>seasonal period <span class="math inline">\(m\)</span></strong>, typical examples include:</p>
<ul>
<li><span class="math inline">\(m = 4\)</span> for <strong>quarterly</strong> data,</li>
<li><span class="math inline">\(m = 12\)</span> for <strong>monthly</strong> data,</li>
<li><span class="math inline">\(m = 7\)</span> for <strong>daily</strong> data exhibiting a <strong>weekly cycle</strong>.</li>
</ul>
<p>In this approach, the <strong>seasonal component is assumed to be constant over time</strong>, repeating identically from year to year.</p>
<p>For <strong>multiplicative seasonality</strong>, the <span class="math inline">\(m\)</span> seasonal values are known as <strong>seasonal indices</strong>, representing the <strong>relative influence</strong> of each period within the seasonal cycle.</p>
<section id="additive-decomposition-1" class="level3">
<h3 class="anchored" data-anchor-id="additive-decomposition-1">Additive Decomposition</h3>
<p>The <strong>additive classical decomposition</strong> method separates a time series into <strong>trend–cycle</strong>, <strong>seasonal</strong>, and <strong>remainder</strong> components through a structured four-step process.</p>
<p><strong>Step 1 — Estimate the Trend–Cycle Component (<span class="math inline">\(\hat{T}_t\)</span>)</strong></p>
<ul>
<li>If the seasonal period <span class="math inline">\(m\)</span> is <strong>even</strong>, use a <strong><span class="math inline">\(2 \times m\)</span>–MA</strong>.</li>
<li>If <span class="math inline">\(m\)</span> is <strong>odd</strong>, use an <strong><span class="math inline">\(m\)</span>–MA</strong>. This moving average smooths short-term fluctuations to reveal the underlying trend–cycle.</li>
</ul>
<p><strong>Step 2 — Detrend the Series</strong> Compute the <strong>detrended values</strong>: <span class="math display">\[
y_t - \hat{T}_t
\]</span> This removes long-term movement, isolating seasonal and irregular variations.</p>
</section>
<section id="additive-decomposition-2" class="level3">
<h3 class="anchored" data-anchor-id="additive-decomposition-2">Additive Decomposition</h3>
<p><strong>Step 3 — Estimate the Seasonal Component (<span class="math inline">\(\hat{S}_t\)</span>)</strong> For each season (e.g., month or quarter), <strong>average the detrended values</strong> across years.</p>
<ul>
<li>Example: For monthly data, the March seasonal component equals the <strong>average of all detrended March values</strong>.</li>
<li>Adjust these averages to ensure they <strong>sum to zero</strong>.</li>
<li>Replicate the seasonal pattern across all years to obtain <span class="math inline">\(\hat{S}_t\)</span>.</li>
</ul>
<p><strong>Step 4 — Compute the Remainder Component (<span class="math inline">\(\hat{R}_t\)</span>)</strong> Subtract both estimated components from the original data: <span class="math display">\[
\hat{R}_t = y_t - \hat{T}_t - \hat{S}_t
\]</span></p>
<section id="example-a-classical-additive-decomposition-of-us-retail-employment" class="level4">
<h4 class="anchored" data-anchor-id="example-a-classical-additive-decomposition-of-us-retail-employment">Example: A classical additive decomposition of US retail employment</h4>
<div id="cell-96" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:797}}" data-outputid="672f08e0-e8c9-4216-e575-9a35266bc351" data-execution_count="26">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Classical additive decomposition of US retail employment (monthly, period=12) ---</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> seasonal_decompose</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Load &amp; filter series</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>us_employment <span class="op">=</span> pd.read_csv(<span class="st">"us_employment.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>us_retail <span class="op">=</span> (</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    us_employment</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">'(unique_id == "Retail Trade") &amp; (ds &gt;= "1990-01-01")'</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    .loc[:, [<span class="st">"ds"</span>, <span class="st">"y"</span>]]</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    .set_index(<span class="st">"ds"</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    .asfreq(<span class="st">"MS"</span>)              <span class="co"># ensure regular monthly frequency</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Classical decomposition (additive) using 2×m MA for trend internally</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co">#    period = 12 for monthly seasonality</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>decomp <span class="op">=</span> seasonal_decompose(</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    us_retail[<span class="st">"y"</span>],</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"additive"</span>,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    period<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    two_sided<span class="op">=</span><span class="va">True</span>,            <span class="co"># centered moving average</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    extrapolate_trend<span class="op">=</span><span class="st">"freq"</span>   <span class="co"># extends ends to plot the trend line</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Collect components</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>dcmp <span class="op">=</span> pd.DataFrame({</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data"</span>:     decomp.observed,</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend"</span>:    decomp.trend,</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seasonal"</span>: decomp.seasonal,</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random"</span>:   decomp.resid</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>}, index<span class="op">=</span>us_retail.index)</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Plot four panels to match the figure</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">4</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(dcmp.index, dcmp[<span class="st">"data"</span>], color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Employed"</span>)</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(dcmp.index, dcmp[<span class="st">"trend"</span>], color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"trend"</span>)</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].plot(dcmp.index, dcmp[<span class="st">"seasonal"</span>], color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">"seasonal"</span>)</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">3</span>].plot(dcmp.index, dcmp[<span class="st">"random"</span>], color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">3</span>].set_ylabel(<span class="st">"random"</span>)</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Classical additive decomposition of total US retail employment</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Employed = trend + seasonal + random"</span>, y<span class="op">=</span><span class="fl">0.97</span>)</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>axes[<span class="op">-</span><span class="dv">1</span>].set_xlabel(<span class="st">""</span>)  <span class="co"># figure has no explicit x-label in the book figure</span></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.95</span>])</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="multiplicative-decomposition-1" class="level3">
<h3 class="anchored" data-anchor-id="multiplicative-decomposition-1">Multiplicative Decomposition</h3>
<p>The <strong>classical multiplicative decomposition</strong> follows the same logical structure as the additive version, except that <strong>additions and subtractions are replaced by multiplications and divisions</strong>.</p>
<p><strong>Step 1 — Estimate the Trend–Cycle Component (<span class="math inline">\(\hat{T}_t\)</span>)</strong></p>
<ul>
<li>If the seasonal period <span class="math inline">\(m\)</span> is <strong>even</strong>, use a <strong><span class="math inline">\(2 \times m\)</span>–MA</strong>.</li>
<li>If <span class="math inline">\(m\)</span> is <strong>odd</strong>, use an <strong><span class="math inline">\(m\)</span>–MA</strong>. This smooths the data to estimate the underlying trend–cycle.</li>
</ul>
<p><strong>Step 2 — Detrend the Series</strong> Remove the estimated trend–cycle by <strong>division</strong>: <span class="math display">\[
\frac{y_t}{\hat{T}_t}
\]</span></p>
</section>
<section id="multiplicative-decomposition-2" class="level3">
<h3 class="anchored" data-anchor-id="multiplicative-decomposition-2">Multiplicative Decomposition</h3>
<p><strong>Step 3 — Estimate the Seasonal Component (<span class="math inline">\(\hat{S}_t\)</span>)</strong></p>
<ul>
<li>For each season (e.g., each month), compute the <strong>average of the detrended values</strong>.</li>
<li>Example: For monthly data, the <strong>seasonal index for March</strong> equals the <strong>average of all detrended March values</strong>.</li>
<li>Adjust the seasonal indexes so that their <strong>sum equals <span class="math inline">\(m\)</span></strong>.</li>
<li>Replicate the sequence across all years to form <span class="math inline">\(\hat{S}_t\)</span>.</li>
</ul>
<p><strong>Step 4 — Compute the Remainder Component (<span class="math inline">\(\hat{R}_t\)</span>)</strong> Remove both the trend–cycle and seasonal effects: <span class="math display">\[
\hat{R}_t = \frac{y_t}{\hat{T}_t \hat{S}_t}
\]</span></p>
</section>
</section>
<section id="comments-on-classical-decomposition" class="level2">
<h2 class="anchored" data-anchor-id="comments-on-classical-decomposition">Comments on Classical Decomposition</h2>
<p>While <strong>classical decomposition</strong> remains conceptually important and historically influential, it is <strong>not recommended for practical forecasting</strong> today. Modern techniques—such as <strong>STL decomposition</strong> and <strong>model-based approaches</strong>—offer <strong>greater flexibility, robustness, and accuracy</strong>.</p>
<p>For a deeper discussion, refer to <a href="https://otexts.com/fpppy/nbs/03-decomposition.html">Chapter 3 of <em>Forecasting: Principles and Practice, the Pythonic Way</em></a>.</p>
</section>
<section id="stl-decomposition" class="level2">
<h2 class="anchored" data-anchor-id="stl-decomposition">STL Decomposition</h2>
<p><strong>STL (Seasonal and Trend decomposition using Loess)</strong> is a <strong>flexible and robust method</strong> for decomposing time series into trend, seasonal, and remainder components.</p>
<p>Developed by <strong>Cleveland et al.&nbsp;(1990)</strong> and later extended by <strong>Bandara, Hyndman, and Bergmeir (2022)</strong>, it uses <strong>Loess smoothing</strong> to estimate nonlinear trends.</p>
<section id="key-advantages-of-stl" class="level3">
<h3 class="anchored" data-anchor-id="key-advantages-of-stl"><strong>Key Advantages of STL</strong></h3>
<ul>
<li>Handles <strong>any type of seasonality</strong>, not limited to monthly or quarterly data (unlike SEATS and X–11).</li>
<li>Allows the <strong>seasonal component to evolve over time</strong>, with user control over the rate of change.</li>
<li>Provides <strong>adjustable smoothness</strong> for the trend–cycle component.</li>
<li>Offers a <strong>robust decomposition option</strong>, making it resistant to outliers — unusual observations affect only the remainder component, not the trend or seasonality.</li>
</ul>
</section>
<section id="limitations-of-stl" class="level3">
<h3 class="anchored" data-anchor-id="limitations-of-stl"><strong>Limitations of STL</strong></h3>
<ul>
<li><p>Does <strong>not automatically adjust</strong> for <strong>trading-day or calendar effects</strong>.</p></li>
<li><p>Supports <strong>only additive decompositions</strong> directly.</p></li>
</ul>
</section>
<section id="transformations-for-alternative-forms" class="level3">
<h3 class="anchored" data-anchor-id="transformations-for-alternative-forms"><strong>Transformations for Alternative Forms</strong></h3>
<ul>
<li><p>A <strong>multiplicative decomposition</strong> can be obtained by applying a <strong>log transformation</strong> before STL and then <strong>back-transforming</strong> the components.</p></li>
<li><p>Intermediate decompositions can be created using a <strong>Box–Cox transformation</strong> with parameter <span class="math inline">\(0 &lt; \lambda &lt; 1\)</span>:</p>
<ul>
<li><span class="math inline">\(\lambda = 0\)</span> → multiplicative decomposition</li>
<li><span class="math inline">\(\lambda = 1\)</span> → additive decomposition</li>
</ul></li>
</ul>
</section>
<section id="practical-use" class="level3">
<h3 class="anchored" data-anchor-id="practical-use"><strong>Practical Use</strong></h3>
<p>The most effective way to master STL is through <strong>experimentation and visualization</strong>.</p>
<p>We will se it applied to <strong>US retail employment data</strong> and check an alternative decomposition where the <strong>trend–cycle is more flexible</strong>, the <strong>seasonal pattern is fixed</strong>, and the <strong>robust option</strong> is enabled to handle outliers.</p>
</section>
<section id="example-total-us-retail-employment-top-and-its-three-additive-components-obtained-from-a-robust-stl-decomposition-with-flexible-trend-cycle-and-fixed-seasonality." class="level3">
<h3 class="anchored" data-anchor-id="example-total-us-retail-employment-top-and-its-three-additive-components-obtained-from-a-robust-stl-decomposition-with-flexible-trend-cycle-and-fixed-seasonality.">Example: Total US retail employment (top) and its three additive components obtained from a robust STL decomposition with flexible trend-cycle and fixed seasonality.</h3>
<div id="cell-106" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:628}}" data-outputid="b0b99212-643f-4b36-d289-347b72bd87f2" data-execution_count="27">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust STL with flexible trend / fixed season</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>stl <span class="op">=</span> STL(us_retail_employment[<span class="st">"y"</span>], period<span class="op">=</span><span class="dv">12</span>, seasonal<span class="op">=</span><span class="dv">13</span>, trend<span class="op">=</span><span class="dv">21</span>, robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>res_stl <span class="op">=</span> stl.fit()</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>dcmp <span class="op">=</span> pd.DataFrame({</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ds"</span>: us_retail_employment[<span class="st">"ds"</span>],</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data"</span>: us_retail_employment[<span class="st">"y"</span>],</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend"</span>: res_stl.trend,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seasonal"</span>: res_stl.seasonal,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"remainder"</span>: res_stl.resid</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>}).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">4</span>, ncols<span class="op">=</span><span class="dv">1</span>, sharex<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span>dcmp.index, y<span class="op">=</span><span class="st">"data"</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>])</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span>dcmp.index, y<span class="op">=</span><span class="st">"trend"</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>])</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span>dcmp.index, y<span class="op">=</span><span class="st">"seasonal"</span>, ax<span class="op">=</span>axes[<span class="dv">2</span>])</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>dcmp, x<span class="op">=</span>dcmp.index, y<span class="op">=</span><span class="st">"remainder"</span>, ax<span class="op">=</span>axes[<span class="dv">3</span>])</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Employed"</span>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"trend"</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">"season_year"</span>)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">3</span>].set_ylabel(<span class="st">"remainder"</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"STL decomposition"</span>)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>fig.subplots_adjust(top<span class="op">=</span><span class="fl">0.90</span>)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="st">"Employed = trend + seasonal + random"</span>, ha<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">""</span>)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-total-us-retail-employment-and-its-stl-components" class="level3">
<h3 class="anchored" data-anchor-id="example-total-us-retail-employment-and-its-stl-components">Example: Total US Retail Employment and Its STL Components</h3>
<p>The figure shows the <strong>total US retail employment</strong> series (top) along with its <strong>three additive components</strong> — trend–cycle, seasonality, and remainder — obtained from a <strong>robust STL decomposition</strong> with a <strong>flexible trend–cycle</strong> and <strong>fixed seasonality</strong>.</p>
<section id="key-stl-parameters" class="level4">
<h4 class="anchored" data-anchor-id="key-stl-parameters"><strong>Key STL Parameters</strong></h4>
<p>When applying STL, two parameters must be defined:</p>
<ul>
<li><strong>Season:</strong> the length of the <strong>seasonal smoother</strong>, controlling how quickly the seasonal pattern can evolve.</li>
<li><strong>Trend:</strong> the length of the <strong>trend smoother</strong>, determining how flexibly the trend–cycle can adjust to structural changes.</li>
</ul>
<p>Both parameters must be <strong>odd numbers</strong>. Smaller values make the corresponding component <strong>more responsive</strong> to rapid fluctuations.</p>
</section>
<section id="interpretation-of-the-example" class="level4">
<h4 class="anchored" data-anchor-id="interpretation-of-the-example"><strong>Interpretation of the Example</strong></h4>
<p>In the default STL output, the <strong>trend window</strong> was too long, making the <strong>trend–cycle too rigid</strong>. This caused <strong>signal leakage</strong> — notably, the 2008 <strong>global financial crisis impact</strong> appeared in the <strong>remainder component</strong> instead of the trend. Adjusting to a <strong>shorter trend window</strong> (as in Figure 3.12) yields a more <strong>accurate and responsive trend–cycle estimate</strong>.</p>
</section>
</section>
</section>
</section>
<section id="some-simple-forecasting-methods" class="level1">
<h1>5 - Some simple forecasting methods</h1>
<blockquote class="blockquote">
<p>Source: Chapter 5 “The forecaster’s toolbox” (FPP, Pythonic Way).<br>
URL: https://otexts.com/fpppy/nbs/05-toolbox.html</p>
</blockquote>
<p>Some forecasting methods are extremely simple and surprisingly effective. We will use four simple forecasting methods as benchmarks throughout this book. To illustrate them, we will use quarterly Australian clay brick production between 1970 and 2004.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div id="cell-112" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="cd145419-c4c0-4abd-b689-8c85ba60016c" data-execution_count="28">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip <span class="op">-</span>q install utilsforecast statsmodels seaborn matplotlib cycler</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install fpppy</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure these are available:</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - boxcox() function — For applying Box–Cox transformations</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - boxcox_lambda() function — For finding optimal Box–Cox transformation parameters</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - plot_series() utility — For creating time series visualizations</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys, importlib, subprocess</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _pip_install(pkg):</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    subprocess.run([sys.executable, <span class="st">"-m"</span>, <span class="st">"pip"</span>, <span class="st">"install"</span>, <span class="st">"-qU"</span>, pkg], check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) coreforecast: boxcox, boxcox_lambda</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> coreforecast.scalers <span class="im">import</span> boxcox, boxcox_lambda</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    _pip_install(<span class="st">"coreforecast"</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> coreforecast.scalers <span class="im">import</span> boxcox, boxcox_lambda</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) plot_series utility: prefer fpppy.utils, fallback to utilsforecast.plotting</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> fpppy.utils <span class="im">import</span> plot_series  <span class="co"># if you have the FPP(Pythonic) helpers</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> utilsforecast.plotting <span class="im">import</span> plot_series  <span class="co"># fallback</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        _pip_install(<span class="st">"utilsforecast matplotlib pandas numpy"</span>)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> utilsforecast.plotting <span class="im">import</span> plot_series</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="co"># --- quick smoke test / confirmation ---</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _has_callable(obj):</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">callable</span>(obj)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"• boxcox() function —"</span>, <span class="st">"OK"</span> <span class="cf">if</span> _has_callable(boxcox) <span class="cf">else</span> <span class="st">"MISSING"</span>)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"• boxcox_lambda() function —"</span>, <span class="st">"OK"</span> <span class="cf">if</span> _has_callable(boxcox_lambda) <span class="cf">else</span> <span class="st">"MISSING"</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"• plot_series() utility —"</span>, <span class="st">"OK"</span> <span class="cf">if</span> _has_callable(plot_series) <span class="cf">else</span> <span class="st">"MISSING"</span>)</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: tiny demo to verify they actually run (safe no-op)</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.array([<span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">4.0</span>, <span class="fl">8.0</span>])</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>lam <span class="op">=</span> boxcox_lambda(y, method<span class="op">=</span><span class="st">"guerrero"</span>, season_length<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> boxcox(y, lam)  <span class="co"># should not error</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: fpppy in /usr/local/lib/python3.12/dist-packages (0.0.3)
Requirement already satisfied: matplotlib in /usr/local/lib/python3.12/dist-packages (from fpppy) (3.10.0)
Requirement already satisfied: pre-commit in /usr/local/lib/python3.12/dist-packages (from fpppy) (4.3.0)
Requirement already satisfied: pytest in /usr/local/lib/python3.12/dist-packages (from fpppy) (8.4.2)
Requirement already satisfied: pytest-cov in /usr/local/lib/python3.12/dist-packages (from fpppy) (7.0.0)
Requirement already satisfied: scikit-learn in /usr/local/lib/python3.12/dist-packages (from fpppy) (1.6.1)
Requirement already satisfied: statsmodels in /usr/local/lib/python3.12/dist-packages (from fpppy) (0.14.5)
Requirement already satisfied: utilsforecast in /usr/local/lib/python3.12/dist-packages (from fpppy) (0.2.14)
Requirement already satisfied: contourpy&gt;=1.0.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (1.3.3)
Requirement already satisfied: cycler&gt;=0.10 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (4.60.1)
Requirement already satisfied: kiwisolver&gt;=1.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (1.4.9)
Requirement already satisfied: numpy&gt;=1.23 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (2.0.2)
Requirement already satisfied: packaging&gt;=20.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (25.0)
Requirement already satisfied: pillow&gt;=8 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (11.3.0)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (3.2.5)
Requirement already satisfied: python-dateutil&gt;=2.7 in /usr/local/lib/python3.12/dist-packages (from matplotlib-&gt;fpppy) (2.9.0.post0)
Requirement already satisfied: cfgv&gt;=2.0.0 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (3.4.0)
Requirement already satisfied: identify&gt;=1.0.0 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (2.6.15)
Requirement already satisfied: nodeenv&gt;=0.11.1 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (1.9.1)
Requirement already satisfied: pyyaml&gt;=5.1 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (6.0.3)
Requirement already satisfied: virtualenv&gt;=20.10.0 in /usr/local/lib/python3.12/dist-packages (from pre-commit-&gt;fpppy) (20.35.3)
Requirement already satisfied: iniconfig&gt;=1 in /usr/local/lib/python3.12/dist-packages (from pytest-&gt;fpppy) (2.1.0)
Requirement already satisfied: pluggy&lt;2,&gt;=1.5 in /usr/local/lib/python3.12/dist-packages (from pytest-&gt;fpppy) (1.6.0)
Requirement already satisfied: pygments&gt;=2.7.2 in /usr/local/lib/python3.12/dist-packages (from pytest-&gt;fpppy) (2.19.2)
Requirement already satisfied: coverage&gt;=7.10.6 in /usr/local/lib/python3.12/dist-packages (from coverage[toml]&gt;=7.10.6-&gt;pytest-cov-&gt;fpppy) (7.10.7)
Requirement already satisfied: scipy&gt;=1.6.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn-&gt;fpppy) (1.15.3)
Requirement already satisfied: joblib&gt;=1.2.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn-&gt;fpppy) (1.5.2)
Requirement already satisfied: threadpoolctl&gt;=3.1.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn-&gt;fpppy) (3.6.0)
Requirement already satisfied: pandas!=2.1.0,&gt;=1.4 in /usr/local/lib/python3.12/dist-packages (from statsmodels-&gt;fpppy) (2.2.2)
Requirement already satisfied: patsy&gt;=0.5.6 in /usr/local/lib/python3.12/dist-packages (from statsmodels-&gt;fpppy) (1.0.1)
Requirement already satisfied: pytz&gt;=2020.1 in /usr/local/lib/python3.12/dist-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels-&gt;fpppy) (2025.2)
Requirement already satisfied: tzdata&gt;=2022.7 in /usr/local/lib/python3.12/dist-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels-&gt;fpppy) (2025.2)
Requirement already satisfied: six&gt;=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil&gt;=2.7-&gt;matplotlib-&gt;fpppy) (1.17.0)
Requirement already satisfied: distlib&lt;1,&gt;=0.3.7 in /usr/local/lib/python3.12/dist-packages (from virtualenv&gt;=20.10.0-&gt;pre-commit-&gt;fpppy) (0.4.0)
Requirement already satisfied: filelock&lt;4,&gt;=3.12.2 in /usr/local/lib/python3.12/dist-packages (from virtualenv&gt;=20.10.0-&gt;pre-commit-&gt;fpppy) (3.20.0)
Requirement already satisfied: platformdirs&lt;5,&gt;=3.9.1 in /usr/local/lib/python3.12/dist-packages (from virtualenv&gt;=20.10.0-&gt;pre-commit-&gt;fpppy) (4.5.0)
• boxcox() function — OK
• boxcox_lambda() function — OK
• plot_series() utility — OK</code></pre>
</div>
</div>
<div id="cell-113" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys, subprocess</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pip_install(<span class="op">*</span>pkgs):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    subprocess.run([sys.executable, <span class="st">"-m"</span>, <span class="st">"pip"</span>, <span class="st">"install"</span>, <span class="st">"-qU"</span>, <span class="op">*</span>pkgs], check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># tsfeatures is published by Nixtla. These are commonly used together:</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>pip_install(<span class="st">"tsfeatures"</span>, <span class="st">"statsforecast"</span>, <span class="st">"coreforecast"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-114" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:0}}" data-outputid="44a525a4-ff34-42c7-ea34-bf6d0b80f5fc" data-execution_count="30">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> HistoricAverage</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.plotting <span class="im">import</span> plot_series</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>production_df <span class="op">=</span> pd.read_csv(<span class="st">"aus_production_formatted.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>production_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div id="df-2e233d4d-1792-4698-9903-f3ca5a69cc19" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Beer</td>
<td>1956-03-01</td>
<td>284.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Beer</td>
<td>1956-06-01</td>
<td>213.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Beer</td>
<td>1956-09-01</td>
<td>227.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Beer</td>
<td>1956-12-01</td>
<td>308.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Beer</td>
<td>1957-03-01</td>
<td>262.0</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-2e233d4d-1792-4698-9903-f3ca5a69cc19')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-2e233d4d-1792-4698-9903-f3ca5a69cc19 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-2e233d4d-1792-4698-9903-f3ca5a69cc19');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-b3eeaf83-3d01-4aa6-84a2-00db5fa64956">
      <button class="colab-df-quickchart" onclick="quickchart('df-b3eeaf83-3d01-4aa6-84a2-00db5fa64956')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-b3eeaf83-3d01-4aa6-84a2-00db5fa64956 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
</section>
<section id="mean-method" class="level2">
<h2 class="anchored" data-anchor-id="mean-method">Mean method</h2>
<p>Here, the forecasts of all future values are equal to the average (or “mean”) of the historical data. If we let the historical data be denoted by <span class="math inline">\(y_1, \ldots, y_T\)</span>, then we can write the forecasts as</p>
<p><span class="math display">\[\hat{y}_{T+h\mid T} = \bar{y} = \frac{y_1 + \cdots + y_T}{T}.\]</span></p>
<p>The notation <span class="math inline">\(\hat{y}_{T+h\mid T}\)</span> is a short-hand for the estimate of <span class="math inline">\(y_{T+h}\)</span> based on the data <span class="math inline">\(y_1, \ldots, y_T\)</span>.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>avg_method <span class="op">=</span> HistoricAverage()</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[avg_method], freq<span class="op">=</span><span class="st">'QE'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="example-mean-or-average-forecasts-applied-to-clay-brick-production-in-australia." class="level3">
<h3 class="anchored" data-anchor-id="example-mean-or-average-forecasts-applied-to-clay-brick-production-in-australia.">Example: Mean (or average) forecasts applied to clay brick production in Australia.</h3>
<div id="cell-117" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:544}}" data-outputid="84e67e83-3a90-416d-a9bd-be7ffb2e7182" data-execution_count="31">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast Australian clay brick production (1956–2004) out to 2010</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach: StatsForecast with HistoricAverage(), quarterly frequency</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust to StatsForecast's column naming (uses model-name column)</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot without confidence intervals; y-axis optional</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> HistoricAverage</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.tseries.offsets <span class="im">import</span> MonthEnd</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and prepare quarterly data (quarter-end timestamps)</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"aus_production_formatted.csv"</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>bricks <span class="op">=</span> (</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    df.query(<span class="st">'unique_id == "Bricks"'</span>)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>      .loc[:, [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]]</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>      .sort_values(<span class="st">"ds"</span>)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>      .assign(ds<span class="op">=</span><span class="kw">lambda</span> d: d[<span class="st">"ds"</span>] <span class="op">+</span> MonthEnd(<span class="dv">0</span>))  <span class="co"># align to quarter-end so freq='QE' is consistent</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Training window (through 2004 inclusive, as in your code)</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> bricks.query(<span class="st">'ds &lt;= "2004-12-31"'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> train.empty:</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No Bricks observations found through 2004. Check the file and date ranges."</span>)</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>last_ds <span class="op">=</span> train[<span class="st">"ds"</span>].<span class="bu">max</span>()                 <span class="co"># last observed quarter-end in training</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>end_ds  <span class="op">=</span> pd.Timestamp(<span class="st">"2010-12-31"</span>)        <span class="co"># forecast end (quarter-end)</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizon (number of quarters to 2010Q4)</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>last_q <span class="op">=</span> last_ds.to_period(<span class="st">"Q"</span>)</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>end_q  <span class="op">=</span> end_ds.to_period(<span class="st">"Q"</span>)</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> (end_q.year <span class="op">-</span> last_q.year) <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> (end_q.quarter <span class="op">-</span> last_q.quarter)</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> h <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Computed horizon h &lt;= 0; verify last_ds and end_ds."</span>)</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a><span class="co"># StatsForecast: HistoricAverage</span></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>avg_method <span class="op">=</span> HistoricAverage()</span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[avg_method], freq<span class="op">=</span><span class="st">"QE"</span>)  <span class="co"># quarter-end</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>fcasts <span class="op">=</span> sf.forecast(df<span class="op">=</span>train, h<span class="op">=</span>h)</span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the forecast value column. Newer versions name it after the model.</span></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>value_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> fcasts.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>)]</span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> value_cols:</span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Forecast dataframe has columns </span><span class="sc">{</span><span class="bu">list</span>(fcasts.columns)<span class="sc">}</span><span class="ss"> but no value column. "</span></span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Expected a model-named column like 'HistoricAverage'."</span></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>yhat_col <span class="op">=</span> value_cols[<span class="dv">0</span>]   <span class="co"># e.g., 'HistoricAverage'</span></span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot history + historic-average forecast (ensure non-black colors)</span></span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset any global monochrome override some earlier cell may have set</span></span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">'axes.prop_cycle'</span>] <span class="op">=</span> mpl.rcParamsDefault[<span class="st">'axes.prop_cycle'</span>]</span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Use explicit non-cycle colors to be robust in Colab</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>train_label <span class="op">=</span> <span class="ss">f'Bricks (</span><span class="sc">{</span>train[<span class="st">"ds"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>year<span class="sc">}</span><span class="ss">–</span><span class="sc">{</span>train[<span class="st">"ds"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>year<span class="sc">}</span><span class="ss">)'</span></span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>ax.plot(train[<span class="st">"ds"</span>], train[<span class="st">"y"</span>], label<span class="op">=</span>train_label, linewidth<span class="op">=</span><span class="fl">1.6</span>, color<span class="op">=</span><span class="st">"tab:blue"</span>)</span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a>ax.plot(fcasts[<span class="st">"ds"</span>], fcasts[yhat_col], <span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">2.4</span>,</span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"HistoricAverage (StatsForecast)"</span>, color<span class="op">=</span><span class="st">"tab:orange"</span>)</span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Australian Clay Bricks: HistoricAverage Forecast to 2010 (freq='QE')"</span>)</span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Quarter"</span>)</span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Production (millions of bricks)"</span>)</span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a><span class="co"># ax.set_ylim(300, 600)  # optional bound if desired</span></span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">"best"</span>)</span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({</span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">"train_window"</span>: [train[<span class="st">"ds"</span>].<span class="bu">min</span>().date().isoformat(), train[<span class="st">"ds"</span>].<span class="bu">max</span>().date().isoformat()],</span>
<span id="cb36-85"><a href="#cb36-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_obs"</span>: <span class="bu">int</span>(<span class="bu">len</span>(train)),</span>
<span id="cb36-86"><a href="#cb36-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">"h_quarters"</span>: <span class="bu">int</span>(h),</span>
<span id="cb36-87"><a href="#cb36-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_training_quarter"</span>: <span class="bu">str</span>(last_q),</span>
<span id="cb36-88"><a href="#cb36-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">"forecast_end_quarter"</span>: <span class="bu">str</span>(end_q),</span>
<span id="cb36-89"><a href="#cb36-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"forecast_value_column"</span>: yhat_col</span>
<span id="cb36-90"><a href="#cb36-90" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'train_window': ['1956-03-31', '2004-12-31'], 'n_obs': 196, 'h_quarters': 24, 'last_training_quarter': '2004Q4', 'forecast_end_quarter': '2010Q4', 'forecast_value_column': 'HistoricAverage'}</code></pre>
</div>
</div>
</section>
</section>
<section id="naïve-method" class="level2">
<h2 class="anchored" data-anchor-id="naïve-method">Naïve method</h2>
<p>For naïve forecasts, we simply set all forecasts to be the value of the last observation. That is,</p>
<p><span class="math display">\[\hat{y}_{T+h\mid T}=y_T.\]</span></p>
<p>This method works remarkably well for many economic and financial time series.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>naive_method <span class="op">=</span> Naive()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[naive_method], freq<span class="op">=</span><span class="st">'QE'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="example-naïve-forecasts-applied-to-clay-brick-production-in-australia." class="level3">
<h3 class="anchored" data-anchor-id="example-naïve-forecasts-applied-to-clay-brick-production-in-australia.">Example: Naïve forecasts applied to clay brick production in Australia.</h3>
<div id="cell-120" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:544}}" data-outputid="332e9e0f-8fc2-4730-947e-29892d807fb4" data-execution_count="32">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast Australian clay brick production (1956–2004) out to 2010</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach: StatsForecast with Naive() at quarterly frequency</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot without confidence intervals; y-axis fixed to [300, 600]</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> Naive</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.tseries.offsets <span class="im">import</span> MonthEnd</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and prepare quarterly data (quarter-end timestamps)</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"aus_production_formatted.csv"</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>bricks <span class="op">=</span> (</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    df.query(<span class="st">'unique_id == "Bricks"'</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>      .loc[:, [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]]</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>      .sort_values(<span class="st">"ds"</span>)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>      .assign(ds<span class="op">=</span><span class="kw">lambda</span> d: d[<span class="st">"ds"</span>] <span class="op">+</span> MonthEnd(<span class="dv">0</span>))   <span class="co"># align to quarter-end</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Training window 1970–2004 inclusive</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="co"># train = bricks.query('ds &gt;= "1970-01-01" and ds &lt;= "2004-12-31"').reset_index(drop=True)</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> bricks.query(<span class="st">'ds &lt;= "2004-12-31"'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> train.empty:</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No Bricks observations found in 1970–2004. Check the file and date ranges."</span>)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>last_ds <span class="op">=</span> train[<span class="st">"ds"</span>].<span class="bu">max</span>()</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>end_ds  <span class="op">=</span> pd.Timestamp(<span class="st">"2010-12-31"</span>)</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizon (quarters from last_ds to 2010Q4)</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>last_q <span class="op">=</span> last_ds.to_period(<span class="st">"Q"</span>)</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>end_q  <span class="op">=</span> end_ds.to_period(<span class="st">"Q"</span>)</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> (end_q.year <span class="op">-</span> last_q.year) <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> (end_q.quarter <span class="op">-</span> last_q.quarter)</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> h <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Computed horizon h &lt;= 0; verify last_ds and end_ds."</span>)</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a><span class="co"># StatsForecast: Naive</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>nav_method <span class="op">=</span> Naive()</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[nav_method], freq<span class="op">=</span><span class="st">"QE"</span>)   <span class="co"># quarter-end frequency</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>fcasts <span class="op">=</span> sf.forecast(df<span class="op">=</span>train, h<span class="op">=</span>h)</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Model output column (StatsForecast names it after the model)</span></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>value_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> fcasts.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>)]</span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> value_cols:</span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Forecast dataframe has columns </span><span class="sc">{</span><span class="bu">list</span>(fcasts.columns)<span class="sc">}</span><span class="ss"> but no value column. "</span></span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Expected a model-named column like 'Naive'."</span></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>yhat_col <span class="op">=</span> value_cols[<span class="dv">0</span>]   <span class="co"># typically 'Naive'</span></span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot history + naive forecast (no intervals)</span></span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>ax.plot(train[<span class="st">"ds"</span>], train[<span class="st">"y"</span>], label<span class="op">=</span><span class="st">"Bricks (1956–2004)"</span>, linewidth<span class="op">=</span><span class="fl">1.6</span>)</span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>ax.plot(fcasts[<span class="st">"ds"</span>], fcasts[yhat_col], <span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Naive (StatsForecast)"</span>)</span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Australian Clay Bricks: Naive Forecast to 2010 (freq='QE')"</span>)</span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Quarter"</span>)</span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Production (millions of bricks)"</span>)</span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a><span class="co"># ax.set_ylim(300, 600)</span></span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">"best"</span>)</span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({</span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"train_window"</span>: [train[<span class="st">"ds"</span>].<span class="bu">min</span>().date().isoformat(), train[<span class="st">"ds"</span>].<span class="bu">max</span>().date().isoformat()],</span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_obs"</span>: <span class="bu">int</span>(<span class="bu">len</span>(train)),</span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"h_quarters"</span>: <span class="bu">int</span>(h),</span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_training_quarter"</span>: <span class="bu">str</span>(last_q),</span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"forecast_end_quarter"</span>: <span class="bu">str</span>(end_q),</span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"forecast_value_column"</span>: yhat_col</span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-34-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'train_window': ['1956-03-31', '2004-12-31'], 'n_obs': 196, 'h_quarters': 24, 'last_training_quarter': '2004Q4', 'forecast_end_quarter': '2010Q4', 'forecast_value_column': 'Naive'}</code></pre>
</div>
</div>
<p>Because a naïve forecast is optimal when data follow a random walk (see Section 9.1), these are also called random walk forecasts.</p>
</section>
</section>
<section id="seasonal-naïve-method-with-period-m" class="level2">
<h2 class="anchored" data-anchor-id="seasonal-naïve-method-with-period-m">Seasonal Naïve Method with Period <span class="math inline">\(m\)</span></h2>
<p>The <strong>seasonal naïve method</strong> is particularly effective for <strong>highly seasonal time series</strong>. It assumes that each observation repeats the value from the <strong>same season in the previous cycle</strong>.</p>
<p>Formally, the forecast for time <span class="math inline">\(T + h\)</span> is defined as:</p>
<p><span class="math display">\[
\hat{y}*{T+h \mid T} = y*{T + h - m(k+1)},
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(m\)</span> = seasonal period (e.g., 12 for monthly data, 4 for quarterly data),</li>
<li><span class="math inline">\(k\)</span> = integer part of <span class="math inline">\((h - 1)/m\)</span>, representing the <strong>number of complete seasons</strong> in the forecast horizon prior to <span class="math inline">\(T + h\)</span>.</li>
</ul>
<section id="interpretation-1" class="level3">
<h3 class="anchored" data-anchor-id="interpretation-1"><strong>Interpretation</strong></h3>
<ul>
<li>For <strong>monthly data</strong>, all future <strong>February</strong> forecasts equal the <strong>last observed February</strong> value.</li>
<li>For <strong>quarterly data</strong>, all future <strong>Q2</strong> forecasts equal the <strong>last observed Q2</strong> value.</li>
<li>The same logic extends to other seasonal periods.</li>
</ul>
</section>
<section id="example-seasonal-naïve-forecasts-applied-to-clay-brick-production-in-australia." class="level3">
<h3 class="anchored" data-anchor-id="example-seasonal-naïve-forecasts-applied-to-clay-brick-production-in-australia.">Example: Seasonal naïve forecasts applied to clay brick production in Australia.</h3>
<div id="cell-124" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:544}}" data-outputid="d6481748-2474-4a37-cbbb-0a34dc196b03" data-execution_count="33">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast Australian clay brick production (1970–2004) out to 2010</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach: StatsForecast SeasonalNaive (m=4, quarterly)</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot without confidence intervals; y-axis fixed to [300, 600]</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> SeasonalNaive</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.tseries.offsets <span class="im">import</span> MonthEnd</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and prepare quarterly data (quarter-end timestamps)</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"aus_production_formatted.csv"</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>bricks <span class="op">=</span> (</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    df.query(<span class="st">'unique_id == "Bricks"'</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>      .loc[:, [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]]</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>      .sort_values(<span class="st">"ds"</span>)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>      .assign(ds<span class="op">=</span><span class="kw">lambda</span> d: d[<span class="st">"ds"</span>] <span class="op">+</span> MonthEnd(<span class="dv">0</span>))   <span class="co"># align to quarter-end</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Training window 1970–2004 inclusive</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="co"># train = bricks.query('ds &gt;= "1970-01-01" and ds &lt;= "2004-12-31"').reset_index(drop=True)</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> bricks.query(<span class="st">'ds &lt;= "2004-12-31"'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> train.empty:</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No Bricks observations found in 1970–2004. Check the file and date ranges."</span>)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>last_ds <span class="op">=</span> train[<span class="st">"ds"</span>].<span class="bu">max</span>()</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>end_ds  <span class="op">=</span> pd.Timestamp(<span class="st">"2010-12-31"</span>)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizon (quarters from last_ds to 2010Q4)</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>last_q <span class="op">=</span> last_ds.to_period(<span class="st">"Q"</span>)</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>end_q  <span class="op">=</span> end_ds.to_period(<span class="st">"Q"</span>)</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> (end_q.year <span class="op">-</span> last_q.year) <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> (end_q.quarter <span class="op">-</span> last_q.quarter)</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> h <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Computed horizon h &lt;= 0; verify last_ds and end_ds."</span>)</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="co"># StatsForecast: Seasonal Naive (m = 4 for quarterly)</span></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>snaive <span class="op">=</span> SeasonalNaive(season_length<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[snaive], freq<span class="op">=</span><span class="st">"QE"</span>)   <span class="co"># quarter-end frequency</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>fcasts <span class="op">=</span> sf.forecast(df<span class="op">=</span>train, h<span class="op">=</span>h)</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Model output column (StatsForecast names it after the model)</span></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>value_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> fcasts.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>)]</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> value_cols:</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Forecast dataframe has columns </span><span class="sc">{</span><span class="bu">list</span>(fcasts.columns)<span class="sc">}</span><span class="ss"> but no value column. "</span></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Expected a model-named column like 'SeasonalNaive'."</span></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>yhat_col <span class="op">=</span> value_cols[<span class="dv">0</span>]   <span class="co"># typically 'SeasonalNaive'</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot history + seasonal naive forecast (no intervals)</span></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>ax.plot(train[<span class="st">"ds"</span>], train[<span class="st">"y"</span>], label<span class="op">=</span><span class="st">"Bricks (1956–2004)"</span>, linewidth<span class="op">=</span><span class="fl">1.6</span>)</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>ax.plot(fcasts[<span class="st">"ds"</span>], fcasts[yhat_col], <span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Seasonal Naïve (StatsForecast, m=4)"</span>)</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Australian Clay Bricks: Seasonal Naïve Forecast to 2010 (freq='QE')"</span>)</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Quarter"</span>)</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Production (millions of bricks)"</span>)</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a><span class="co"># ax.set_ylim(300, 600)</span></span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">"best"</span>)</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">"train_window"</span>: [train[<span class="st">"ds"</span>].<span class="bu">min</span>().date().isoformat(), train[<span class="st">"ds"</span>].<span class="bu">max</span>().date().isoformat()],</span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_obs"</span>: <span class="bu">int</span>(<span class="bu">len</span>(train)),</span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"h_quarters"</span>: <span class="bu">int</span>(h),</span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_training_quarter"</span>: <span class="bu">str</span>(last_q),</span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"forecast_end_quarter"</span>: <span class="bu">str</span>(end_q),</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"forecast_value_column"</span>: yhat_col</span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'train_window': ['1956-03-31', '2004-12-31'], 'n_obs': 196, 'h_quarters': 24, 'last_training_quarter': '2004Q4', 'forecast_end_quarter': '2010Q4', 'forecast_value_column': 'SeasonalNaive'}</code></pre>
</div>
</div>
</section>
</section>
<section id="drift-method" class="level2">
<h2 class="anchored" data-anchor-id="drift-method">Drift Method</h2>
<p>The <strong>drift method</strong> is a variation of the <strong>naïve forecasting approach</strong>, where forecasts are allowed to <strong>increase or decrease linearly over time</strong>. The rate of change, known as the <strong>drift</strong>, equals the <strong>average historical change</strong> between consecutive observations.</p>
<p>The forecast for time <span class="math inline">\(T + h\)</span> is given by:</p>
<p><span class="math display">\[
\hat{y}*{T+h \mid T} = y_T + \frac{h}{T - 1} \sum*{t=2}^{T}(y_t - y_{t-1}) = y_T + h \left( \frac{y_T - y_1}{T - 1} \right).
\]</span></p>
<section id="interpretation-2" class="level3">
<h3 class="anchored" data-anchor-id="interpretation-2"><strong>Interpretation</strong></h3>
<ul>
<li>The method effectively <strong>draws a straight line</strong> between the <strong>first and last observations</strong> of the series.</li>
<li>Future values are <strong>extrapolated linearly</strong>, assuming that the historical rate of change continues.</li>
<li>It captures simple <strong>trend behavior</strong> while maintaining the <strong>structure of a random walk</strong>.</li>
</ul>
<p>This approach is particularly useful for <strong>series with a steady trend</strong>, as it extends the historical direction of movement into the forecast horizon.</p>
</section>
<section id="example-drift-forecasts-applied-to-clay-brick-production-in-australia" class="level3">
<h3 class="anchored" data-anchor-id="example-drift-forecasts-applied-to-clay-brick-production-in-australia">Example: Drift forecasts applied to clay brick production in Australia</h3>
<div id="cell-127" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:544}}" data-outputid="95579287-fed8-4916-b2e0-084f5d8a9d10" data-execution_count="34">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast Australian clay brick production (1970–2004) out to 2010</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach: StatsForecast RandomWalkWithDrift() (a.k.a. naïve with drift)</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot without confidence intervals; y-axis fixed to [300, 600]</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> RandomWalkWithDrift</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.tseries.offsets <span class="im">import</span> MonthEnd</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and prepare quarterly data (quarter-end timestamps)</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"aus_production_formatted.csv"</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>bricks <span class="op">=</span> (</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    df.query(<span class="st">'unique_id == "Bricks"'</span>)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>      .loc[:, [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]]</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>      .sort_values(<span class="st">"ds"</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>      .assign(ds<span class="op">=</span><span class="kw">lambda</span> d: d[<span class="st">"ds"</span>] <span class="op">+</span> MonthEnd(<span class="dv">0</span>))   <span class="co"># align to quarter-end for 'QE'</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Training window 1970–2004 inclusive</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="co"># train = bricks.query('ds &gt;= "1970-01-01" and ds &lt;= "2004-12-31"').reset_index(drop=True)</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> bricks.query(<span class="st">'ds &lt;= "2004-12-31"'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> train.empty:</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No Bricks observations found in 1970–2004. Check the file and date ranges."</span>)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>last_ds <span class="op">=</span> train[<span class="st">"ds"</span>].<span class="bu">max</span>()</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>end_ds  <span class="op">=</span> pd.Timestamp(<span class="st">"2010-12-31"</span>)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizon (quarters from last_ds to 2010Q4)</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>last_q <span class="op">=</span> last_ds.to_period(<span class="st">"Q"</span>)</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>end_q  <span class="op">=</span> end_ds.to_period(<span class="st">"Q"</span>)</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> (end_q.year <span class="op">-</span> last_q.year) <span class="op">*</span> <span class="dv">4</span> <span class="op">+</span> (end_q.quarter <span class="op">-</span> last_q.quarter)</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> h <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Computed horizon h &lt;= 0; verify last_ds and end_ds."</span>)</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a><span class="co"># StatsForecast: Random Walk with Drift</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>drift_method <span class="op">=</span> RandomWalkWithDrift()</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[drift_method], freq<span class="op">=</span><span class="st">"QE"</span>)   <span class="co"># quarter-end frequency</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>fcasts <span class="op">=</span> sf.forecast(df<span class="op">=</span>train, h<span class="op">=</span>h)                    <span class="co"># columns: unique_id, ds, RandomWalkWithDrift</span></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the forecast value column (named after the model)</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>value_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> fcasts.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>)]</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> value_cols:</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unexpected forecast columns: </span><span class="sc">{</span><span class="bu">list</span>(fcasts.columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>yhat_col <span class="op">=</span> value_cols[<span class="dv">0</span>]  <span class="co"># typically 'RandomWalkWithDrift'</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot history + drift forecast</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>ax.plot(train[<span class="st">"ds"</span>], train[<span class="st">"y"</span>], label<span class="op">=</span><span class="st">"Bricks (1956–2004)"</span>, linewidth<span class="op">=</span><span class="fl">1.6</span>)</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>ax.plot(fcasts[<span class="st">"ds"</span>], fcasts[yhat_col], <span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Naïve with Drift (StatsForecast)"</span>)</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Australian Clay Bricks: Naïve-with-Drift Forecast to 2010 (freq='QE')"</span>)</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Quarter"</span>)</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Production (millions of bricks)"</span>)</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a><span class="co"># ax.set_ylim(300, 600)</span></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">"best"</span>)</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({</span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"train_window"</span>: [train[<span class="st">"ds"</span>].<span class="bu">min</span>().date().isoformat(), train[<span class="st">"ds"</span>].<span class="bu">max</span>().date().isoformat()],</span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_obs"</span>: <span class="bu">int</span>(<span class="bu">len</span>(train)),</span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">"h_quarters"</span>: <span class="bu">int</span>(h),</span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_training_quarter"</span>: <span class="bu">str</span>(last_q),</span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"forecast_end_quarter"</span>: <span class="bu">str</span>(end_q),</span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"forecast_value_column"</span>: yhat_col</span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'train_window': ['1956-03-31', '2004-12-31'], 'n_obs': 196, 'h_quarters': 24, 'last_training_quarter': '2004Q4', 'forecast_end_quarter': '2010Q4', 'forecast_value_column': 'RWD'}</code></pre>
</div>
</div>
</section>
</section>
<section id="example-australian-quarterly-beer-production" class="level2">
<h2 class="anchored" data-anchor-id="example-australian-quarterly-beer-production">Example: Australian Quarterly Beer Production</h2>
<p>The figure illustrates the application of the <strong>first three forecasting methods</strong> — <strong>naïve</strong>, <strong>seasonal naïve</strong>, and <strong>drift</strong> — to <strong>Australian quarterly beer production</strong> data covering the period <strong>1992–2006</strong>.</p>
<p>The <strong>forecasts</strong> generated by each method are compared with the <strong>actual observations</strong> over the <strong>subsequent 3.5 years</strong>, providing a clear visualization of how each approach captures trend and seasonality in the data.</p>
<p>This example highlights the differences in performance between the methods when dealing with <strong>seasonal patterns</strong> and <strong>gradual trends</strong> in quarterly production data.</p>
<p>In this case, only the seasonal naïve forecasts are close to the observed values from 2007 onwards.</p>
<div id="cell-129" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:507}}" data-outputid="d16052ee-310b-4a71-d3de-11824b2c1260" data-execution_count="35">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecasts for quarterly beer production (1992–2006) with 3.5-year holdout</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Models: Naïve, Mean (HistoricAverage), Seasonal Naïve</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot forecasts against actuals for the next 14 quarters with distinct colors</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.tseries.offsets <span class="im">import</span> MonthEnd, QuarterEnd</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> Naive, HistoricAverage, SeasonalNaive</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data and prepare quarterly timestamps</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"aus_production_formatted.csv"</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>beer <span class="op">=</span> (</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    df.query(<span class="st">'unique_id == "Beer"'</span>)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>      .loc[:, [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]]</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>      .sort_values(<span class="st">"ds"</span>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>      .assign(ds<span class="op">=</span><span class="kw">lambda</span> d: d[<span class="st">"ds"</span>] <span class="op">+</span> MonthEnd(<span class="dv">0</span>))  <span class="co"># align to quarter-end for freq='QE'</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Train window and horizon</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> beer.query(<span class="st">'ds &gt;= "1992-01-01" and ds &lt;= "2006-12-31"'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> train.empty:</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No Beer observations found in 1992–2006."</span>)</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>last_train_ds <span class="op">=</span> train[<span class="st">"ds"</span>].<span class="bu">max</span>()   <span class="co"># 2006Q4 quarter-end</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> <span class="dv">14</span>                              <span class="co"># 3.5 years = 14 quarters</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>end_ds <span class="op">=</span> last_train_ds <span class="op">+</span> QuarterEnd(h)</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a><span class="co"># StatsForecast models</span></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>[Naive(), HistoricAverage(), SeasonalNaive(season_length<span class="op">=</span><span class="dv">4</span>)],</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="st">"QE"</span></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>fcasts <span class="op">=</span> sf.forecast(df<span class="op">=</span>train, h<span class="op">=</span>h)</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize model column names</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>rename_map <span class="op">=</span> {}</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> fcasts.columns:</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>):</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>    cl <span class="op">=</span> c.lower()</span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"historicaverage"</span> <span class="kw">in</span> cl <span class="kw">or</span> cl <span class="op">==</span> <span class="st">"mean"</span>:</span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>        rename_map[c] <span class="op">=</span> <span class="st">"Mean"</span></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> cl <span class="op">==</span> <span class="st">"naive"</span>:</span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>        rename_map[c] <span class="op">=</span> <span class="st">"Naïve"</span></span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">"seasonalnaive"</span> <span class="kw">in</span> cl:</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>        rename_map[c] <span class="op">=</span> <span class="st">"Seasonal naïve"</span></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>fcasts <span class="op">=</span> fcasts.rename(columns<span class="op">=</span>rename_map)</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Actuals in holdout horizon</span></span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>actual_future <span class="op">=</span> beer.query(<span class="st">'ds &gt; @last_train_ds and ds &lt;= @end_ds'</span>)</span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Historical and holdout actuals in black</span></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>ax.plot(train[<span class="st">"ds"</span>], train[<span class="st">"y"</span>], color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">1.6</span>)</span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> actual_future.empty:</span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>    ax.plot(actual_future[<span class="st">"ds"</span>], actual_future[<span class="st">"y"</span>], color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">1.6</span>)</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecasts with distinct colors</span></span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>ax.plot(fcasts[<span class="st">"ds"</span>], fcasts[<span class="st">"Mean"</span>],           color<span class="op">=</span><span class="st">"tab:orange"</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="st">"Mean"</span>)</span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>ax.plot(fcasts[<span class="st">"ds"</span>], fcasts[<span class="st">"Naïve"</span>],          color<span class="op">=</span><span class="st">"tab:blue"</span>,   linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="st">"Naïve"</span>)</span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a>ax.plot(fcasts[<span class="st">"ds"</span>], fcasts[<span class="st">"Seasonal naïve"</span>], color<span class="op">=</span><span class="st">"tab:green"</span>,  linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="st">"Seasonal naïve"</span>)</span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Forecasts for quarterly beer production"</span>)</span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Quarter"</span>)</span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Megalitres"</span>)</span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">"Forecast"</span>, loc<span class="op">=</span><span class="st">"best"</span>, frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-googles-daily-closing-stock-price" class="level2">
<h2 class="anchored" data-anchor-id="example-googles-daily-closing-stock-price">Example: Google’s Daily Closing Stock Price</h2>
<p>The <strong>non-seasonal forecasting methods</strong> are applied to <strong>Google’s daily closing stock prices</strong> for the year <strong>2015</strong>, generating <strong>one-month-ahead forecasts</strong>.</p>
<p>Because <strong>stock prices are recorded only on trading days</strong>, not on calendar days, the analysis begins by creating a <strong>custom time index</strong> aligned with the <strong>sequence of trading days</strong>.</p>
<p>This ensures that temporal spacing in the data reflects <strong>actual market activity</strong>, allowing the forecasting models to properly capture short-term price dynamics without distortion from non-trading days.</p>
<div id="cell-131" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:507}}" data-outputid="4f852451-57f2-4d64-b264-1220af699b17" data-execution_count="36">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GOOG daily close in 2015 → non-seasonal forecasts (Mean, Naive, Drift) one month ahead</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust to StatsForecast variants where RandomWalkWithDrift column is named 'RWD'</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.tseries.offsets <span class="im">import</span> MonthEnd</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> HistoricAverage, Naive, RandomWalkWithDrift</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and subset Google Close</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"gafa_stock.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>goog <span class="op">=</span> (</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    df.query(<span class="st">'unique_id == "GOOG_Close"'</span>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>      .loc[:, [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]]</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>      .sort_values(<span class="st">"ds"</span>)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>      .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Training window: 2015 trading days</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> goog.query(<span class="st">'ds &gt;= "2015-01-01" and ds &lt;= "2015-12-31"'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> train.empty:</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No GOOG_Close observations in 2015."</span>)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>last_train_date <span class="op">=</span> train[<span class="st">"ds"</span>].<span class="bu">max</span>()</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Horizon: trading days in the next calendar month (after last training day)</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>next_month_end <span class="op">=</span> last_train_date <span class="op">+</span> MonthEnd(<span class="dv">1</span>)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>future_dates <span class="op">=</span> goog.loc[(goog[<span class="st">"ds"</span>] <span class="op">&gt;</span> last_train_date) <span class="op">&amp;</span> (goog[<span class="st">"ds"</span>] <span class="op">&lt;=</span> next_month_end), <span class="st">"ds"</span>].tolist()</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(future_dates) <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># fallback if needed</span></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>    future_dates <span class="op">=</span> goog.loc[goog[<span class="st">"ds"</span>] <span class="op">&gt;</span> last_train_date, <span class="st">"ds"</span>].head(<span class="dv">21</span>).tolist()</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> <span class="bu">len</span>(future_dates)</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Trading-day index for StatsForecast (freq=1)</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>train_idx <span class="op">=</span> train.copy()</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>train_idx[<span class="st">"ds"</span>] <span class="op">=</span> np.arange(<span class="bu">len</span>(train_idx), dtype<span class="op">=</span><span class="bu">int</span>)  <span class="co"># 0..N-1</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Models and forecast</span></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>avg_method   <span class="op">=</span> HistoricAverage()</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>naive_method <span class="op">=</span> Naive()</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>drift_method <span class="op">=</span> RandomWalkWithDrift()</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[drift_method, avg_method, naive_method], freq<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>fcasts <span class="op">=</span> sf.forecast(df<span class="op">=</span>train_idx, h<span class="op">=</span>h)  <span class="co"># columns: unique_id, ds, &lt;drift&gt;, HistoricAverage, Naive</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Map forecast step index back to real trading dates</span></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>fcasts_plot <span class="op">=</span> fcasts.copy()</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>fcasts_plot[<span class="st">"ds"</span>] <span class="op">=</span> future_dates[:<span class="bu">len</span>(fcasts_plot)]</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust rename of model columns</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>rename <span class="op">=</span> {}</span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> fcasts_plot.columns:</span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>):</span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>    lc <span class="op">=</span> c.lower()</span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"randomwalkwithdrift"</span> <span class="kw">in</span> lc) <span class="kw">or</span> (<span class="st">"rw"</span> <span class="kw">in</span> lc <span class="kw">and</span> <span class="st">"d"</span> <span class="kw">in</span> lc) <span class="kw">or</span> (lc <span class="op">==</span> <span class="st">"rwd"</span>) <span class="kw">or</span> (<span class="st">"drift"</span> <span class="kw">in</span> lc):</span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>        rename[c] <span class="op">=</span> <span class="st">"Drift"</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">"historicaverage"</span> <span class="kw">in</span> lc <span class="kw">or</span> lc <span class="op">==</span> <span class="st">"mean"</span>:</span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>        rename[c] <span class="op">=</span> <span class="st">"Mean"</span></span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> lc <span class="op">==</span> <span class="st">"naive"</span>:</span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>        rename[c] <span class="op">=</span> <span class="st">"Naive"</span></span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a>fcasts_plot <span class="op">=</span> fcasts_plot.rename(columns<span class="op">=</span>rename)</span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a><span class="co"># If a short alias like 'RWD' remains unmapped, catch it</span></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"Drift"</span> <span class="kw">not</span> <span class="kw">in</span> fcasts_plot.columns:</span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>    drift_like <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> fcasts_plot.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"Mean"</span>, <span class="st">"Naive"</span>)]</span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> drift_like:</span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a>        fcasts_plot <span class="op">=</span> fcasts_plot.rename(columns<span class="op">=</span>{drift_like[<span class="dv">0</span>]: <span class="st">"Drift"</span>})</span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Actuals within the forecast month (for comparison)</span></span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a>actual_future <span class="op">=</span> goog.loc[goog[<span class="st">"ds"</span>].isin(future_dates)].copy()</span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Actuals (2015 train + next month)</span></span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a>ax.plot(train[<span class="st">"ds"</span>], train[<span class="st">"y"</span>], color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">1.4</span>, label<span class="op">=</span><span class="st">"Actuals"</span>)</span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> actual_future.empty:</span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a>    ax.plot(actual_future[<span class="st">"ds"</span>], actual_future[<span class="st">"y"</span>], color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast lines (distinct colors)</span></span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"Mean"</span> <span class="kw">in</span> fcasts_plot:</span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a>    ax.plot(fcasts_plot[<span class="st">"ds"</span>], fcasts_plot[<span class="st">"Mean"</span>],  color<span class="op">=</span><span class="st">"tab:orange"</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="st">"Mean"</span>)</span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"Naive"</span> <span class="kw">in</span> fcasts_plot:</span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a>    ax.plot(fcasts_plot[<span class="st">"ds"</span>], fcasts_plot[<span class="st">"Naive"</span>], color<span class="op">=</span><span class="st">"tab:blue"</span>,   linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="st">"Naive"</span>)</span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"Drift"</span> <span class="kw">in</span> fcasts_plot:</span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a>    ax.plot(fcasts_plot[<span class="st">"ds"</span>], fcasts_plot[<span class="st">"Drift"</span>], color<span class="op">=</span><span class="st">"tab:green"</span>,  linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="st">"Drift"</span>)</span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Google daily closing stock prices (Jan 2015-Jan 2016)"</span>)</span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Date (trading days)"</span>)</span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Closing Price (USD)"</span>)</span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">"Method"</span>, loc<span class="op">=</span><span class="st">"best"</span>, frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="benchmark-role-of-simple-forecasting-methods" class="level2">
<h2 class="anchored" data-anchor-id="benchmark-role-of-simple-forecasting-methods">Benchmark Role of Simple Forecasting Methods</h2>
<p>In some situations, one of these <strong>simple forecasting methods</strong> may provide the <strong>most effective and practical solution</strong> available.</p>
<p>However, in most applications, these methods primarily serve as <strong>benchmark models</strong>. Any newly developed forecasting technique should be <strong>evaluated against these benchmarks</strong> to confirm its added value.</p>
<p>If a new model does <strong>not outperform</strong> these simple alternatives, it is <strong>not justified for use</strong>, regardless of its complexity.</p>
<p>Establishing such benchmarks ensures that <strong>model development remains grounded in empirical performance</strong> rather than unnecessary sophistication.</p>
</section>
</section>
<section id="forecasting-with-decomposition" class="level1">
<h1>6 – Forecasting with Decomposition</h1>
<p><strong>Time series decomposition</strong> is often a valuable step in generating accurate forecasts by separating the data into interpretable components.</p>
<section id="additive-decomposition-3" class="level3">
<h3 class="anchored" data-anchor-id="additive-decomposition-3"><strong>Additive Decomposition</strong></h3>
<p>When an <strong>additive structure</strong> is assumed:</p>
<p><span class="math display">\[
y_t = \hat{S}_t + \hat{A}_t,
\]</span></p>
<p>where <span class="math inline">\(\hat{A}_t = \hat{T}_t + \hat{R}_t\)</span> represents the <strong>seasonally adjusted component</strong>.</p>
</section>
<section id="multiplicative-decomposition-3" class="level3">
<h3 class="anchored" data-anchor-id="multiplicative-decomposition-3"><strong>Multiplicative Decomposition</strong></h3>
<p>For a <strong>multiplicative structure</strong>:</p>
<p><span class="math display">\[
y_t = \hat{S}_t \hat{A}_t,
\]</span></p>
<p>where <span class="math inline">\(\hat{A}_t = \hat{T}_t \hat{R}_t\)</span>.</p>
<blockquote class="blockquote">
<p><strong>Source:</strong> Chapter 5 – <em>“The Forecaster’s Toolbox”</em> (FPP, Pythonic Way) <strong>URL:</strong> <a href="https://otexts.com/fpppy/nbs/05-toolbox.html">https://otexts.com/fpppy/nbs/05-toolbox.html</a></p>
</blockquote>
</section>
<section id="forecasting-strategy" class="level3">
<h3 class="anchored" data-anchor-id="forecasting-strategy"><strong>Forecasting Strategy</strong></h3>
<p>To forecast a decomposed series:</p>
<ol type="1">
<li><p><strong>Seasonal Component (<span class="math inline">\(\hat{S}_t\)</span>):</strong></p>
<ul>
<li>Typically assumed to be <strong>stable</strong> or changing <strong>very slowly</strong>.</li>
<li>Forecast using a <strong>seasonal naïve method</strong>, i.e., repeating the <strong>last year’s estimated seasonal pattern</strong>.</li>
</ul></li>
<li><p><strong>Seasonally Adjusted Component (<span class="math inline">\(\hat{A}_t\)</span>):</strong></p>
<ul>
<li><p>Forecast using any <strong>non-seasonal forecasting method</strong>, such as:</p>
<ul>
<li>The <strong>drift method</strong></li>
<li><strong>Holt’s method</strong> (FPPPY Chapter 8, not covered here)</li>
<li>A <strong>non-seasonal ARIMA model</strong> (FPPPY Chapter 9, not covered here)</li>
</ul></li>
</ul></li>
</ol>
<p>This combined approach leverages decomposition to isolate stable seasonal patterns while applying more sophisticated forecasting methods to the adjusted trend and remainder components.</p>
</section>
<section id="load-additional-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-additional-libraries">Load additional libraries</h2>
<div id="cell-136" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ignore"</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    category<span class="op">=</span><span class="pp">UserWarning</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    message<span class="op">=</span><span class="st">".*FigureCanvasAgg is non-interactive.*"</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"NIXTLA_ID_AS_COL"</span>] <span class="op">=</span> <span class="st">"true"</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(suppress<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"max_colwidth"</span>, <span class="dv">100</span>)</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.precision"</span>, <span class="dv">3</span>)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.plotting <span class="im">import</span> plot_series <span class="im">as</span> plot_series_utils</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"ggplot"</span>)</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.figsize"</span>: (<span class="dv">8</span>, <span class="dv">5</span>),</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.dpi"</span>: <span class="dv">100</span>,</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"savefig.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.constrained_layout.use"</span>: <span class="va">True</span>,</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.titlesize"</span>: <span class="dv">12</span>,</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xtick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ytick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.fontsize"</span>: <span class="dv">9</span>,</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.title_fontsize"</span>: <span class="dv">10</span>,</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cycler <span class="im">import</span> cycler</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">'axes.prop_cycle'</span>] <span class="op">=</span> cycler(color<span class="op">=</span>[<span class="st">"#000000"</span>, <span class="st">"#000000"</span>])</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fpppy.utils <span class="im">import</span> plot_series</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-137" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> STL</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.graphics.tsaplots <span class="im">import</span> plot_acf</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.stats.diagnostic <span class="im">import</span> acorr_ljungbox</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.evaluation <span class="im">import</span> evaluate</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.feature_engineering <span class="im">import</span> pipeline, trend</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co"># from utilsforecast.losses import rmse, mae, mape as _mape, mase, quantile_loss, mq</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.losses <span class="im">import</span> rmse, mae, mape <span class="im">as</span> _mape, mase, quantile_loss</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mape(df, models, id_col <span class="op">=</span> <span class="st">"unique_id"</span>, target_col <span class="op">=</span> <span class="st">"y"</span>):</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    df_mape <span class="op">=</span> _mape(df, models, id_col<span class="op">=</span>id_col, target_col<span class="op">=</span>target_col)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    df_mape.loc[:, df_mape.select_dtypes(include<span class="op">=</span><span class="st">'number'</span>).columns] <span class="op">*=</span> <span class="dv">100</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_mape</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> SklearnModel</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.utils <span class="im">import</span> ConformalIntervals</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> (</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    WindowAverage,</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    Naive,</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    SeasonalNaive,</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    RandomWalkWithDrift,</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>    HistoricAverage,</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fpppy.models <span class="im">import</span> LinearRegression</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="example-naïve-forecasts-of-the-seasonally-adjusted-data-obtained-from-an-stl-decomposition-of-the-total-us-retail-employment." class="level2">
<h2 class="anchored" data-anchor-id="example-naïve-forecasts-of-the-seasonally-adjusted-data-obtained-from-an-stl-decomposition-of-the-total-us-retail-employment.">Example: Naïve forecasts of the seasonally adjusted data obtained from an STL decomposition of the total US retail employment.</h2>
<div id="cell-139" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:507}}" data-outputid="065bf828-c9aa-44b6-a58f-b32daa4f96ef" data-execution_count="39">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Seasonally adjust US retail employment, forecast the adjusted series with Naive(),</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and plot with Matplotlib. Fix: pass a *single* 'y' column to StatsForecast</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (avoid duplicate 'y' caused by keeping both raw and adjusted series).</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> STL</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> Naive</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load &amp; filter</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>us_employment_df <span class="op">=</span> pd.read_csv(<span class="st">"us_employment_formatted.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">"ds"</span>])</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>us_retail_employment_df <span class="op">=</span> (</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    us_employment_df.query(<span class="st">"Title == 'Retail Trade' and ds.dt.year &gt;= 1992"</span>)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"ds"</span>)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    .drop(columns<span class="op">=</span>[<span class="st">"Title"</span>])</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="co"># STL seasonal adjustment (monthly -&gt; period=12)</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>stl <span class="op">=</span> STL(us_retail_employment_df[<span class="st">"y"</span>].to_numpy(), period<span class="op">=</span><span class="dv">12</span>, robust<span class="op">=</span><span class="va">True</span>, trend_deg<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> stl.fit()</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>us_retail_employment_df[<span class="st">"seasonal"</span>] <span class="op">=</span> res.seasonal</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>us_retail_employment_df[<span class="st">"y_adjusted"</span>] <span class="op">=</span> (</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    us_retail_employment_df[<span class="st">"y"</span>] <span class="op">-</span> us_retail_employment_df[<span class="st">"seasonal"</span>]</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the dataframe for StatsForecast with a SINGLE 'y' column</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>adj_train <span class="op">=</span> (</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>    us_retail_employment_df.loc[:, [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y_adjusted"</span>]]</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"y_adjusted"</span>: <span class="st">"y"</span>})</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast the seasonally-adjusted series with Naive</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[Naive()], freq<span class="op">=</span><span class="st">"M"</span>)</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>adj_fc <span class="op">=</span> sf.forecast(df<span class="op">=</span>adj_train, h<span class="op">=</span><span class="dv">24</span>, level<span class="op">=</span>[<span class="dv">80</span>, <span class="dv">95</span>], fitted<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>fitted_vals <span class="op">=</span> sf.forecast_fitted_values()</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect model column (e.g., 'Naive')</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>model_col <span class="op">=</span> <span class="bu">next</span>(c <span class="cf">for</span> c <span class="kw">in</span> adj_fc.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>))</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: rename back for clarity in plotting variables</span></span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>yhat <span class="op">=</span> adj_fc[model_col]</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>lo80, hi80 <span class="op">=</span> adj_fc.get(<span class="ss">f"</span><span class="sc">{</span>model_col<span class="sc">}</span><span class="ss">-lo-80"</span>), adj_fc.get(<span class="ss">f"</span><span class="sc">{</span>model_col<span class="sc">}</span><span class="ss">-hi-80"</span>)</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>lo95, hi95 <span class="op">=</span> adj_fc.get(<span class="ss">f"</span><span class="sc">{</span>model_col<span class="sc">}</span><span class="ss">-lo-95"</span>), adj_fc.get(<span class="ss">f"</span><span class="sc">{</span>model_col<span class="sc">}</span><span class="ss">-hi-95"</span>)</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot with Matplotlib</span></span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">5</span>))</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Historical seasonally-adjusted series</span></span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>ax.plot(</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>    us_retail_employment_df[<span class="st">"ds"</span>],</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>    us_retail_employment_df[<span class="st">"y_adjusted"</span>],</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">1.6</span>,</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Adjusted (history)"</span>,</span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction intervals (if present)</span></span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> lo95 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> hi95 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a>    ax.fill_between(adj_fc[<span class="st">"ds"</span>], lo95, hi95, alpha<span class="op">=</span><span class="fl">0.18</span>, label<span class="op">=</span><span class="st">"95% PI"</span>)</span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> lo80 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> hi80 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>    ax.fill_between(adj_fc[<span class="st">"ds"</span>], lo80, hi80, alpha<span class="op">=</span><span class="fl">0.28</span>, label<span class="op">=</span><span class="st">"80% PI"</span>)</span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Point forecast</span></span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a>ax.plot(adj_fc[<span class="st">"ds"</span>], yhat, <span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">2.2</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_col<span class="sc">}</span><span class="ss"> forecast"</span>)</span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"US retail employment (seasonally adjusted)"</span>)</span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Month"</span>)</span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Number of people"</span>)</span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">"best"</span>, frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="forecasting-with-stl-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="forecasting-with-stl-decomposition">Forecasting with STL Decomposition</h3>
<p>The Figure presents <strong>naïve forecasts</strong> of the <strong>seasonally adjusted US retail employment data</strong>.</p>
<p>These forecasts are then <strong>“reseasonalised”</strong> by adding the <strong>seasonal naïve forecasts</strong> of the seasonal component, effectively reconstructing the full series.</p>
</section>
<section id="automated-forecasting-with-stl" class="level3">
<h3 class="anchored" data-anchor-id="automated-forecasting-with-stl"><strong>Automated Forecasting with <code>STL()</code></strong></h3>
<p>The <strong><code>STL()</code> function</strong> in <code>statsmodels</code> simplifies this process by:</p>
<ul>
<li>Allowing forecasts from <strong>any additive decomposition</strong>.</li>
<li>Letting users specify <strong>different forecasting models</strong> for each component.</li>
<li>Automatically applying <strong><code>SeasonalNaive()</code></strong> for the seasonal component if no alternative is provided.</li>
<li>Performing the <strong>reseasonalisation automatically</strong>, ensuring that forecasts of the <strong>original series</strong> are recovered correctly.</li>
</ul>
<p>The next Figure illustrates the <strong>final reseasonalised forecasts</strong>, showing how the STL framework integrates decomposition and forecasting into a cohesive, automated workflow.</p>
</section>
<section id="example-forecasts-of-the-total-us-retail-employment-data-based-on-a-naïve-forecast-of-the-seasonally-adjusted-data-and-a-seasonal-naïve-forecast-of-the-seasonal-component-after-an-stl-decomposition-of-the-data." class="level3">
<h3 class="anchored" data-anchor-id="example-forecasts-of-the-total-us-retail-employment-data-based-on-a-naïve-forecast-of-the-seasonally-adjusted-data-and-a-seasonal-naïve-forecast-of-the-seasonal-component-after-an-stl-decomposition-of-the-data.">Example: Forecasts of the total US retail employment data based on a naïve forecast of the seasonally adjusted data and a seasonal naïve forecast of the seasonal component, after an STL decomposition of the data.</h3>
<div id="cell-142" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:507}}" data-outputid="5e4776f7-8f1a-4a31-bd86-305440735110" data-execution_count="40">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-seasonalise the adjusted forecast by adding a SeasonalNaive forecast of the seasonal component</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and PLOT with Matplotlib.</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> Naive, SeasonalNaive   <span class="co"># &lt;-- Naive was missing</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --- helper: keep unique column names (avoids target being returned as a DataFrame) ---</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _dedupe_cols(df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df.columns.duplicated().<span class="bu">any</span>():</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.loc[:, <span class="op">~</span>df.columns.duplicated()]</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Seasonally-adjusted level -&gt; Naive</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>adj_train <span class="op">=</span> (</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    us_retail_employment_df[[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>]].copy()</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    .assign(y<span class="op">=</span>us_retail_employment_df[<span class="st">"y_adjusted"</span>])</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>adj_train <span class="op">=</span> _dedupe_cols(adj_train)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>adj_train[<span class="st">"y"</span>] <span class="op">=</span> pd.to_numeric(adj_train[<span class="st">"y"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>adj_train <span class="op">=</span> adj_train.dropna(subset<span class="op">=</span>[<span class="st">"y"</span>])</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>sf_adj <span class="op">=</span> StatsForecast(models<span class="op">=</span>[Naive()], freq<span class="op">=</span><span class="st">"M"</span>)</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>adjusted_fcasts <span class="op">=</span> sf_adj.forecast(df<span class="op">=</span>adj_train, h<span class="op">=</span><span class="dv">24</span>, level<span class="op">=</span>[<span class="dv">80</span>, <span class="dv">95</span>], fitted<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>adjusted_fcasts_fitted <span class="op">=</span> sf_adj.forecast_fitted_values()</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Seasonal component -&gt; SeasonalNaive</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>seas_train <span class="op">=</span> (</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    us_retail_employment_df[[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>]].copy()</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    .assign(y<span class="op">=</span>us_retail_employment_df[<span class="st">"seasonal"</span>])</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>seas_train <span class="op">=</span> _dedupe_cols(seas_train)</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>seas_train[<span class="st">"y"</span>] <span class="op">=</span> pd.to_numeric(seas_train[<span class="st">"y"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>seas_train <span class="op">=</span> seas_train.dropna(subset<span class="op">=</span>[<span class="st">"y"</span>])</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>sf_seas <span class="op">=</span> StatsForecast(models<span class="op">=</span>[SeasonalNaive(season_length<span class="op">=</span><span class="dv">12</span>)], freq<span class="op">=</span><span class="st">"M"</span>)</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>seasonal_fcasts <span class="op">=</span> sf_seas.forecast(df<span class="op">=</span>seas_train, h<span class="op">=</span><span class="dv">24</span>, level<span class="op">=</span>[<span class="dv">80</span>, <span class="dv">95</span>], fitted<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>seasonal_fitted <span class="op">=</span> sf_seas.forecast_fitted_values()</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Combine (re-seasonalise): detect the model-value columns</span></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>adj_col <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> adjusted_fcasts.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>) <span class="kw">and</span> <span class="st">"-lo-"</span> <span class="kw">not</span> <span class="kw">in</span> c <span class="kw">and</span> <span class="st">"-hi-"</span> <span class="kw">not</span> <span class="kw">in</span> c][<span class="dv">0</span>]</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>sea_col <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> seasonal_fcasts.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>) <span class="kw">and</span> <span class="st">"-lo-"</span> <span class="kw">not</span> <span class="kw">in</span> c <span class="kw">and</span> <span class="st">"-hi-"</span> <span class="kw">not</span> <span class="kw">in</span> c][<span class="dv">0</span>]</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> adjusted_fcasts.merge(seasonal_fcasts, on<span class="op">=</span>[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>final_df <span class="op">=</span> merged[[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>]].copy()</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>final_df[<span class="st">"combined"</span>] <span class="op">=</span> merged[adj_col] <span class="op">+</span> merged[sea_col]</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a <span class="kw">in</span> (<span class="dv">80</span>, <span class="dv">95</span>):</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>    final_df[<span class="ss">f"combined-lo-</span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> merged[<span class="ss">f"</span><span class="sc">{</span>adj_col<span class="sc">}</span><span class="ss">-lo-</span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">"</span>] <span class="op">+</span> merged[<span class="ss">f"</span><span class="sc">{</span>sea_col<span class="sc">}</span><span class="ss">-lo-</span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>    final_df[<span class="ss">f"combined-hi-</span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> merged[<span class="ss">f"</span><span class="sc">{</span>adj_col<span class="sc">}</span><span class="ss">-hi-</span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">"</span>] <span class="op">+</span> merged[<span class="ss">f"</span><span class="sc">{</span>sea_col<span class="sc">}</span><span class="ss">-hi-</span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 3b) Residuals (align lengths by merging back, not assigning by position)</span></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>merged_fitted <span class="op">=</span> (</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>    adjusted_fcasts_fitted.merge(seasonal_fitted, on<span class="op">=</span>[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>    .merge(us_retail_employment_df[[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]], on<span class="op">=</span>[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>resids <span class="op">=</span> merged_fitted.assign(</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>    resid <span class="op">=</span> merged_fitted[<span class="st">"y"</span>] <span class="op">-</span> merged_fitted[adj_col] <span class="op">-</span> merged_fitted[sea_col]</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>)[[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"resid"</span>]]</span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a><span class="co"># attach residuals (left-join) to the full dataset; rows without fitted values get NaN</span></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>us_retail_employment_df <span class="op">=</span> us_retail_employment_df.merge(resids, on<span class="op">=</span>[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Plot with Matplotlib</span></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">5</span>))</span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a><span class="co"># History (original, not adjusted)</span></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>ax.plot(</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a>    us_retail_employment_df[<span class="st">"ds"</span>], us_retail_employment_df[<span class="st">"y"</span>],</span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">1.6</span>, label<span class="op">=</span><span class="st">"History"</span></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Bands</span></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>ax.fill_between(</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>    final_df[<span class="st">"ds"</span>], final_df[<span class="st">"combined-lo-95"</span>], final_df[<span class="st">"combined-hi-95"</span>],</span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.18</span>, label<span class="op">=</span><span class="st">"95% PI"</span></span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a>ax.fill_between(</span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>    final_df[<span class="st">"ds"</span>], final_df[<span class="st">"combined-lo-80"</span>], final_df[<span class="st">"combined-hi-80"</span>],</span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.28</span>, label<span class="op">=</span><span class="st">"80% PI"</span></span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Point forecast</span></span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a>ax.plot(</span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a>    final_df[<span class="st">"ds"</span>], final_df[<span class="st">"combined"</span>],</span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">2.2</span>, label<span class="op">=</span><span class="st">"Re-seasonalised forecast"</span></span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"US retail employment (reseasonalised forecasts)"</span>)</span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Month"</span>)</span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Number of people"</span>)</span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">"best"</span>, frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="prediction-intervals-and-residual-analysis" class="level3">
<h3 class="anchored" data-anchor-id="prediction-intervals-and-residual-analysis">Prediction Intervals and Residual Analysis</h3>
<p>The <strong>prediction intervals</strong> in this figure above are generated using the <strong>same reseasonalisation process</strong> as the <strong>point forecasts</strong>.</p>
<ul>
<li><p>The <strong>upper and lower bounds</strong> of the intervals for the <strong>seasonally adjusted series</strong> are <strong>reseasonalised</strong> by adding the corresponding <strong>seasonal component forecasts</strong>.</p></li>
<li><p>This ensures that both <strong>point forecasts</strong> and <strong>interval forecasts</strong> reflect the same <strong>seasonal dynamics</strong> of the original data.</p></li>
</ul>
</section>
<section id="residual-diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="residual-diagnostics"><strong>Residual Diagnostics</strong></h3>
<p>The <strong>ACF of the residuals</strong> (Figure 5.21) reveals <strong>significant autocorrelation</strong>, indicating that:</p>
<ul>
<li>The <strong>naïve method</strong> fails to capture the <strong>evolving trend</strong> in the <strong>seasonally adjusted series</strong>.</li>
<li>This persistence in the residuals suggests that a <strong>more advanced forecasting model</strong> is required to account for the <strong>underlying trend changes</strong> and reduce serial dependence.</li>
</ul>
<p>A convenient shortcut for producing these residual diagnostic graphs is the plot_diagnostics() function, which will produce a time plot, ACF plot and histogram of the residuals.</p>
<div id="cell-145" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_diagnostics(data):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> fig.add_subplot(<span class="dv">2</span>, <span class="dv">2</span>, (<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    ax1.plot(data[<span class="st">'ds'</span>], data[<span class="st">"resid"</span>])</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="st">"Innovation Residuals"</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> fig.add_subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    plot_acf(data[<span class="st">"resid"</span>].dropna(), ax<span class="op">=</span>ax2, zero<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>             bartlett_confint<span class="op">=</span><span class="va">False</span>, auto_ylims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">"ACF Plot"</span>)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'lag[1]'</span>)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> fig.add_subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    ax3.hist(data[<span class="st">"resid"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">"Histogram"</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    ax3.set_xlabel(<span class="st">".resid"</span>)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-146" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:507}}" data-outputid="8b3c5b3e-1545-4545-a3b2-276314e0eb64" data-execution_count="42">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Build a diagnostics-ready training dataframe with residuals ---</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals that we already computed on the fitted window</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># (keys: ['unique_id','ds','resid'])</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># resids = merged_fitted.assign(</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     resid = merged_fitted["y"] - merged_fitted[adj_col] - merged_fitted[sea_col]</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># )[["unique_id", "ds", "resid"]]</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co"># keep only training rows (the ones you modeled)</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> (</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    us_retail_employment_df.loc[:, [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]]   <span class="co"># base training info</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    .merge(resids, on<span class="op">=</span>[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>], how<span class="op">=</span><span class="st">"left"</span>)         <span class="co"># attach residuals by key</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"resid"</span>])                                  <span class="co"># keep rows that have residuals</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># (Optional) make sure types are numeric</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">"y"</span>] <span class="op">=</span> pd.to_numeric(train_df[<span class="st">"y"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">"resid"</span>] <span class="op">=</span> pd.to_numeric(train_df[<span class="st">"resid"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="co"># now this has a 'resid' column and will work with your diagnostic plotter</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>plot_diagnostics(train_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-44-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="evaluating-point-forecast-accuracy" class="level1">
<h1>7 - Evaluating Point Forecast Accuracy</h1>
<section id="training-and-test-sets" class="level2">
<h2 class="anchored" data-anchor-id="training-and-test-sets">Training and Test Sets</h2>
<p>To properly evaluate <strong>forecast accuracy</strong>, it is essential to assess model performance on <strong>genuine forecasts</strong>, not on the residuals from the fitted model.</p>
<p>Residuals reflect <strong>in-sample fit</strong>, which may underestimate the magnitude of <strong>true forecast errors</strong>. Reliable accuracy assessment requires testing the model on <strong>unseen data</strong>.</p>
<section id="data-partitioning-for-model-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="data-partitioning-for-model-evaluation"><strong>Data Partitioning for Model Evaluation</strong></h3>
<p>It is standard practice to divide the available data into two segments:</p>
<ol type="1">
<li><p><strong>Training Set:</strong></p>
<ul>
<li>Used to <strong>fit the model</strong> and <strong>estimate parameters</strong>.</li>
</ul></li>
<li><p><strong>Test Set:</strong></p>
<ul>
<li>Used exclusively to <strong>evaluate forecast performance</strong> on data <strong>not used</strong> during model fitting.</li>
</ul></li>
</ol>
<p>Because the <strong>test data</strong> are withheld from model training, performance metrics calculated on this portion offer a <strong>realistic measure of out-of-sample accuracy</strong> — indicating how well the model generalizes to <strong>future observations</strong>.</p>
</section>
<section id="data-partitioning-for-model-evaluation-1" class="level3">
<h3 class="anchored" data-anchor-id="data-partitioning-for-model-evaluation-1"><strong>Data Partitioning for Model Evaluation</strong></h3>
<center>
<div>
<p><img src="https://raw.githubusercontent.com/davi-moreira/2025F_predictive_analytics_purdue_MGMT474/main/lecture_slides/figs/train_test_split.png" width="200"></p>
</div>
</center>
<p>XXX include figure train_test_split XXX</p>
</section>
</section>
<section id="test-set-size-and-key-considerations" class="level2">
<h2 class="anchored" data-anchor-id="test-set-size-and-key-considerations">Test Set Size and Key Considerations</h2>
<p>The <strong>test set</strong> typically represents about <strong>20% of the total sample</strong>, though the exact proportion depends on:</p>
<ul>
<li>The <strong>length of the dataset</strong>, and</li>
<li>The <strong>forecast horizon</strong> of interest.</li>
</ul>
<p>Ideally, the test set should be <strong>at least as long</strong> as the <strong>maximum forecast horizon</strong> being evaluated.</p>
<section id="important-guidelines" class="level3">
<h3 class="anchored" data-anchor-id="important-guidelines"><strong>Important Guidelines</strong></h3>
<ul>
<li>A model that <strong>fits the training data well</strong> does <strong>not guarantee good forecast performance</strong>.</li>
<li>A <strong>perfect in-sample fit</strong> can always be achieved with enough parameters — but this leads to <strong>overfitting</strong>.</li>
<li><strong>Overfitting</strong> is as detrimental as <strong>underfitting</strong>, as it captures noise rather than genuine patterns.</li>
</ul>
</section>
</section>
<section id="percentage-errors" class="level2">
<h2 class="anchored" data-anchor-id="percentage-errors">Percentage Errors</h2>
<p>The <strong>percentage error</strong> is defined as:</p>
<p><span class="math display">\[
p_t = 100 \frac{e_t}{y_t},
\]</span></p>
<p>where <span class="math inline">\(e_t\)</span> is the forecast error.</p>
<p>Percentage errors are <strong>unit-free</strong>, allowing for easy comparison of forecasting performance across different datasets.</p>
<section id="mean-absolute-percentage-error-mape" class="level4">
<h4 class="anchored" data-anchor-id="mean-absolute-percentage-error-mape"><strong>Mean Absolute Percentage Error (MAPE)</strong></h4>
<p><span class="math display">\[
\text{MAPE} = \text{mean}(|p_t|).
\]</span></p>
<p><strong>Limitations:</strong></p>
<ul>
<li>Undefined when <span class="math inline">\(y_t = 0\)</span> and unstable when <span class="math inline">\(y_t\)</span> is close to zero.</li>
<li>Assumes a <strong>meaningful zero point</strong> in the measurement scale (not applicable for temperatures in °C or °F).</li>
<li><strong>Penalizes negative errors more heavily</strong> than positive ones.</li>
</ul>
</section>
<section id="symmetric-mean-absolute-percentage-error-smape" class="level4">
<h4 class="anchored" data-anchor-id="symmetric-mean-absolute-percentage-error-smape"><strong>Symmetric Mean Absolute Percentage Error (sMAPE)</strong></h4>
<p>Proposed by Armstrong (1978): <span class="math display">\[
\text{sMAPE} = \text{mean}\left(200 \frac{|y_t - \hat{y}_t|}{y_t + \hat{y}_t}\right).
\]</span></p>
<p>However:</p>
<ul>
<li>Still unstable for small <span class="math inline">\(y_t\)</span> and <span class="math inline">\(\hat{y}_t\)</span>.</li>
<li>Can produce <strong>negative values</strong>.</li>
<li>Hyndman and Koehler (2006) <strong>recommend avoiding sMAPE</strong> due to these issues.</li>
</ul>
</section>
</section>
<section id="scaled-errors" class="level2">
<h2 class="anchored" data-anchor-id="scaled-errors">Scaled Errors</h2>
<p>To overcome the limitations of percentage errors, <strong>scaled errors</strong> (Hyndman &amp; Koehler, 2006) standardize forecast errors relative to a simple <strong>benchmark method</strong> (typically the naïve forecast).</p>
<section id="non-seasonal-scaled-error" class="level3">
<h3 class="anchored" data-anchor-id="non-seasonal-scaled-error"><strong>Non-Seasonal Scaled Error</strong></h3>
<p><span class="math display">\[
q_j = \frac{e_j}
{\dfrac{1}{T-1} \sum_{t=2}^{T} |y_t - y_{t-1}| }.
\]</span></p>
<ul>
<li>Independent of the data scale.</li>
<li><span class="math inline">\(|q_j| &lt; 1\)</span> indicates a <strong>better forecast</strong> than the average one-step naïve forecast.</li>
<li><span class="math inline">\(|q_j| &gt; 1\)</span> indicates a <strong>worse forecast</strong>.</li>
</ul>
</section>
<section id="scaled-errors-for-seasonal-time-series" class="level3">
<h3 class="anchored" data-anchor-id="scaled-errors-for-seasonal-time-series">Scaled Errors for Seasonal Time Series</h3>
<p>For <strong>seasonal data</strong>, define the scaled error as: <span class="math display">\[
q_j =
\frac{e_j}
{\dfrac{1}{T - m} \sum_{t = m + 1}^{T} |y_t - y_{t - m}| }.
\]</span></p>
</section>
<section id="mean-absolute-scaled-error-mase" class="level3">
<h3 class="anchored" data-anchor-id="mean-absolute-scaled-error-mase"><strong>Mean Absolute Scaled Error (MASE)</strong></h3>
<p><span class="math display">\[
\text{MASE} = \text{mean}(|q_j|).
\]</span></p>
</section>
<section id="root-mean-squared-scaled-error-rmsse" class="level3">
<h3 class="anchored" data-anchor-id="root-mean-squared-scaled-error-rmsse"><strong>Root Mean Squared Scaled Error (RMSSE)</strong></h3>
<p><span class="math display">\[
\text{RMSSE} = \sqrt{\text{mean}(q_j^2)},
\]</span></p>
<p>where <span class="math display">\[
q_j^2 =
\frac{e_j^2}
{\dfrac{1}{T - m} \sum_{t = m + 1}^{T} (y_t - y_{t - m})^2 }.
\]</span></p>
<p>For <strong>non-seasonal data</strong>, set <span class="math inline">\(m = 1\)</span>.</p>
<p>Scaled errors like <strong>MASE</strong> and <strong>RMSSE</strong> provide <strong>reliable, comparable, and scale-independent</strong> measures of forecast accuracy across different datasets and models.</p>
</section>
</section>
<section id="example-forecasts-of-australian-quarterly-beer-production-using-data-up-to-the-end-of-2007" class="level2">
<h2 class="anchored" data-anchor-id="example-forecasts-of-australian-quarterly-beer-production-using-data-up-to-the-end-of-2007">Example: Forecasts of Australian quarterly beer production using data up to the end of 2007</h2>
<div id="cell-158" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:507}}" data-outputid="40c214ab-9796-4c26-8442-9d0415e1ab3f" data-execution_count="43">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecasts for quarterly beer production (train ≤ 2007; test &gt; 2007)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Each method plotted with a distinct color. Actuals rendered in gray dashed style.</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> HistoricAverage, Naive, RandomWalkWithDrift, SeasonalNaive</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure default color cycle (in case a global monochrome was set earlier)</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>mpl.rcParams[<span class="st">'axes.prop_cycle'</span>] <span class="op">=</span> mpl.rcParamsDefault[<span class="st">'axes.prop_cycle'</span>]</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>beers_df <span class="op">=</span> beer</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> beers_df.query(<span class="st">"ds.dt.year &lt;= 2007"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>test_df  <span class="op">=</span> beers_df.query(<span class="st">"ds.dt.year &gt; 2007"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>mean_method   <span class="op">=</span> HistoricAverage()</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>naive_method  <span class="op">=</span> Naive()</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>drift_method  <span class="op">=</span> RandomWalkWithDrift()</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>seasonal_nav  <span class="op">=</span> SeasonalNaive(season_length<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[drift_method, mean_method, naive_method, seasonal_nav], freq<span class="op">=</span><span class="st">"Q"</span>)</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> sf.forecast(df<span class="op">=</span>train_df, h<span class="op">=</span><span class="bu">len</span>(test_df)).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>preds[<span class="st">"y_actual"</span>] <span class="op">=</span> test_df[<span class="st">"y"</span>].to_numpy()</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust mapping from model columns to legend labels</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>label_map <span class="op">=</span> {</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RandomWalkWithDrift"</span>: <span class="st">"Drift"</span>, <span class="st">"RWD"</span>: <span class="st">"Drift"</span>,</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HistoricAverage"</span>: <span class="st">"Mean"</span>,</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Naive"</span>: <span class="st">"Naïve"</span>,</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SeasonalNaive"</span>: <span class="st">"Seasonal naïve"</span>,</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Palette to force non-black method colors</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>palette <span class="op">=</span> {</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Drift"</span>: <span class="st">"tab:orange"</span>,</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mean"</span>: <span class="st">"tab:blue"</span>,</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Naïve"</span>: <span class="st">"tab:green"</span>,</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Seasonal naïve"</span>: <span class="st">"tab:purple"</span>,</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>model_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> preds.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y_actual"</span>)]</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Actuals in gray, dashed (applies to full history line)</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>ax.plot(</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>    beers_df[<span class="st">"ds"</span>], beers_df[<span class="st">"y"</span>],</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">#color="0.45", linestyle="--", linewidth=1.6, label="Actuals", zorder=1</span></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"0.45"</span>, linestyle<span class="op">=</span><span class="st">"-"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">"Actuals"</span>, zorder<span class="op">=</span><span class="dv">1</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecasts with explicit colors</span></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> model_cols:</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>    lbl <span class="op">=</span> label_map.get(c, c)</span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>        preds[<span class="st">"ds"</span>], preds[c],</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">2.4</span>, color<span class="op">=</span>palette.get(lbl, <span class="va">None</span>), label<span class="op">=</span>lbl, zorder<span class="op">=</span><span class="dv">2</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: overlay test actuals (same gray/dashed, no extra legend entry)</span></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a><span class="co">#ax.plot(test_df["ds"], test_df["y"], color="0.45", linestyle="--", linewidth=1.6, zorder=1)</span></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>ax.plot(test_df[<span class="st">"ds"</span>], test_df[<span class="st">"y"</span>], color<span class="op">=</span><span class="st">"0.45"</span>, linewidth<span class="op">=</span><span class="fl">1.6</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Forecasts for quarterly beer production"</span>)</span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Quarter"</span>)</span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Megalitres"</span>)</span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">"Forecast"</span>, loc<span class="op">=</span><span class="st">"best"</span>, frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="example-forecast-accuracy-measures-for-the-four-forecast-methods-applied-to-the-quarterly-australian-beer-production" class="level3">
<h3 class="anchored" data-anchor-id="example-forecast-accuracy-measures-for-the-four-forecast-methods-applied-to-the-quarterly-australian-beer-production">Example: Forecast accuracy measures for the four forecast methods applied to the quarterly Australian beer production</h3>
<div id="cell-160" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}}" data-outputid="b588ac02-434b-4b00-925c-b1fdee0468c5" data-execution_count="44">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Prepare predictions frame</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>preds_eval <span class="op">=</span> preds.copy()</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Your frame likely has the actuals in 'y_actual'; rename to 'y' if needed</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"y"</span> <span class="kw">not</span> <span class="kw">in</span> preds_eval <span class="kw">and</span> <span class="st">"y_actual"</span> <span class="kw">in</span> preds_eval:</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    preds_eval <span class="op">=</span> preds_eval.rename(columns<span class="op">=</span>{<span class="st">"y_actual"</span>: <span class="st">"y"</span>})</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify model columns (everything except id/time/actuals)</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>fixed_cols <span class="op">=</span> {<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>}</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>model_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> preds_eval.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> fixed_cols]</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Helper: groupwise metrics</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _rmse(y, yhat):</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.sqrt(np.mean((y <span class="op">-</span> yhat) <span class="op">**</span> <span class="dv">2</span>)))</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _mae(y, yhat):</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.mean(np.<span class="bu">abs</span>(y <span class="op">-</span> yhat)))</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _mape(y, yhat):</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> np.asarray(y, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    yhat <span class="op">=</span> np.asarray(yhat, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> y <span class="op">!=</span> <span class="dv">0</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.mean(np.<span class="bu">abs</span>((y[mask] <span class="op">-</span> yhat[mask]) <span class="op">/</span> y[mask])) <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _mase(y_true, y_hat, y_train, seasonality: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="co">    Mean Absolute Scaled Error</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a><span class="co">    MASE = MAE(y_true, y_hat) / MAE of seasonal naive on training set</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.asarray(y_true, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    y_hat  <span class="op">=</span> np.asarray(y_hat,  dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> np.asarray(y_train, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> <span class="bu">int</span>(seasonality)</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> m <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> <span class="bu">len</span>(y_train) <span class="op">&lt;=</span> m:</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>    denom <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(y_train[m:] <span class="op">-</span> y_train[:<span class="op">-</span>m]))</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> denom <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> <span class="kw">not</span> np.isfinite(denom):</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.mean(np.<span class="bu">abs</span>(y_true <span class="op">-</span> y_hat)) <span class="op">/</span> denom)</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-compute MASE denominators per series (id)</span></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>seasonality <span class="op">=</span> <span class="dv">4</span>  <span class="co"># quarterly; set to 1 for non-seasonal data</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>train_mae_denom <span class="op">=</span> (</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>    train_df.sort_values([<span class="st">"unique_id"</span>, <span class="st">"ds"</span>])</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>            .groupby(<span class="st">"unique_id"</span>, as_index<span class="op">=</span><span class="va">True</span>)[<span class="st">"y"</span>]</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>            .<span class="bu">apply</span>(<span class="kw">lambda</span> y: np.mean(np.<span class="bu">abs</span>(y.values[seasonality:] <span class="op">-</span> y.values[:<span class="op">-</span>seasonality]))</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">if</span> <span class="bu">len</span>(y) <span class="op">&gt;</span> seasonality <span class="cf">else</span> np.nan)</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>            .to_dict()</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Compute metrics per model</span></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model <span class="kw">in</span> model_cols:</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># group by series id and aggregate; average (weighted by number of obs) across ids</span></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>    per_id <span class="op">=</span> []</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> uid, g <span class="kw">in</span> preds_eval.groupby(<span class="st">"unique_id"</span>):</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> g[<span class="st">"y"</span>].values</span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>        y_hat  <span class="op">=</span> g[model].values</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>        rmse_i <span class="op">=</span> _rmse(y_true, y_hat)</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>        mae_i  <span class="op">=</span> _mae(y_true, y_hat)</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>        mape_i <span class="op">=</span> _mape(y_true, y_hat)</span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>        denom  <span class="op">=</span> train_mae_denom.get(uid, np.nan)</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>        mase_i <span class="op">=</span> (mae_i <span class="op">/</span> denom) <span class="cf">if</span> denom <span class="kw">and</span> np.isfinite(denom) <span class="cf">else</span> np.nan</span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>        per_id.append((<span class="bu">len</span>(g), rmse_i, mae_i, mape_i, mase_i))</span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># length-weighted average across ids</span></span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">sum</span>(k[<span class="dv">0</span>] <span class="cf">for</span> k <span class="kw">in</span> per_id)</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>    rmse_w <span class="op">=</span> <span class="bu">sum</span>(k[<span class="dv">0</span>]<span class="op">*</span>k[<span class="dv">1</span>] <span class="cf">for</span> k <span class="kw">in</span> per_id) <span class="op">/</span> n</span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>    mae_w  <span class="op">=</span> <span class="bu">sum</span>(k[<span class="dv">0</span>]<span class="op">*</span>k[<span class="dv">2</span>] <span class="cf">for</span> k <span class="kw">in</span> per_id) <span class="op">/</span> n</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>    mape_w <span class="op">=</span> <span class="bu">sum</span>(k[<span class="dv">0</span>]<span class="op">*</span>k[<span class="dv">3</span>] <span class="cf">for</span> k <span class="kw">in</span> per_id) <span class="op">/</span> n</span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>    mase_w <span class="op">=</span> (<span class="bu">sum</span>(k[<span class="dv">0</span>]<span class="op">*</span>k[<span class="dv">4</span>] <span class="cf">for</span> k <span class="kw">in</span> per_id <span class="cf">if</span> np.isfinite(k[<span class="dv">4</span>])) <span class="op">/</span></span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>              <span class="bu">sum</span>(k[<span class="dv">0</span>]       <span class="cf">for</span> k <span class="kw">in</span> per_id <span class="cf">if</span> np.isfinite(k[<span class="dv">4</span>]))) <span class="cf">if</span> <span class="bu">any</span>(np.isfinite(k[<span class="dv">4</span>]) <span class="cf">for</span> k <span class="kw">in</span> per_id) <span class="cf">else</span> np.nan</span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a>    rows.append({<span class="st">"model"</span>: model, <span class="st">"rmse"</span>: rmse_w, <span class="st">"mae"</span>: mae_w, <span class="st">"mape"</span>: mape_w, <span class="st">"mase"</span>: mase_w})</span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a>evaluation <span class="op">=</span> pd.DataFrame(rows).set_index(<span class="st">"model"</span>).sort_index()</span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>evaluation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div id="df-bbb18600-6d03-4a75-8f94-65f975275f48" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rmse</th>
<th data-quarto-table-cell-role="th">mae</th>
<th data-quarto-table-cell-role="th">mape</th>
<th data-quarto-table-cell-role="th">mase</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">HistoricAverage</td>
<td>36.484</td>
<td>24.414</td>
<td>5.521</td>
<td>1.543</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Naive</td>
<td>62.693</td>
<td>57.400</td>
<td>14.184</td>
<td>3.629</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">RWD</td>
<td>66.978</td>
<td>60.230</td>
<td>14.938</td>
<td>3.808</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SeasonalNaive</td>
<td>14.311</td>
<td>13.400</td>
<td>3.169</td>
<td>0.847</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-bbb18600-6d03-4a75-8f94-65f975275f48')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-bbb18600-6d03-4a75-8f94-65f975275f48 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-bbb18600-6d03-4a75-8f94-65f975275f48');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-85067b65-8a41-4908-bad0-828034d18c28">
      <button class="colab-df-quickchart" onclick="quickchart('df-85067b65-8a41-4908-bad0-828034d18c28')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-85067b65-8a41-4908-bad0-828034d18c28 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

  <div id="id_bc4e1075-f639-4a95-ba02-b5d0f16855b7">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('evaluation')" title="Generate code using this dataframe." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"></path>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_bc4e1075-f639-4a95-ba02-b5d0f16855b7 button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('evaluation');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div>
</div>
</section>
<section id="evaluating-forecast-accuracy" class="level3">
<h3 class="anchored" data-anchor-id="evaluating-forecast-accuracy">Evaluating Forecast Accuracy</h3>
<p>The <strong><code>evaluate()</code></strong> function automatically selects the <strong>relevant time periods</strong> from the data (e.g., production values) to align with the corresponding <strong>forecast horizon</strong> when calculating multiple <strong>accuracy metrics</strong>.</p>
</section>
<section id="comparing-forecasting-methods" class="level3">
<h3 class="anchored" data-anchor-id="comparing-forecasting-methods"><strong>Comparing Forecasting Methods</strong></h3>
<p>From the analysis:</p>
<ul>
<li><p>The <strong>seasonal naïve method</strong> provides the <strong>best performance</strong> for these data, as clearly shown in the graph.</p></li>
<li><p>Although effective, this method can still be <strong>refined further</strong> for improved accuracy.</p></li>
<li><p>In some cases, <strong>different accuracy measures</strong> may yield <strong>different rankings</strong> of forecasting methods.</p>
<ul>
<li>Here, however, <strong>all measures consistently identify</strong> the <strong>seasonal naïve approach</strong> as the best among the four tested methods.</li>
</ul></li>
</ul>
</section>
<section id="example-non-seasonal-example-google-stock-price" class="level3">
<h3 class="anchored" data-anchor-id="example-non-seasonal-example-google-stock-price">Example: Non-Seasonal Example — Google Stock Price</h3>
<p>A separate example uses <strong>Google’s daily closing stock prices from 2015</strong>, with <strong>forecasts for January 2016</strong> generated from <strong>three non-seasonal methods</strong>.</p>
<p>The results illustrate how <strong>forecast accuracy evaluation</strong> helps identify which approach best captures short-term market movements in <strong>non-seasonal data</strong>.</p>
<div id="cell-163" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:407}}" data-outputid="1b714660-1f50-4a26-e533-3c6c188182f3" data-execution_count="45">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Select all of 2015 and January 2016 (inclusive)</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (goog[<span class="st">"ds"</span>] <span class="op">&gt;=</span> <span class="st">"2015-01-01"</span>) <span class="op">&amp;</span> (goog[<span class="st">"ds"</span>] <span class="op">&lt;=</span> <span class="st">"2016-01-31"</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>goog_df <span class="op">=</span> goog.loc[mask].sort_values(<span class="st">"ds"</span>).copy()</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>ax.plot(goog_df[<span class="st">"ds"</span>], goog_df[<span class="st">"y"</span>], linewidth<span class="op">=</span><span class="fl">1.6</span>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Google daily closing stock prices: 2015 and Jan 2016"</span>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"$USD"</span>)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-47-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-non-seasonal-example-google-stock-price-1" class="level3">
<h3 class="anchored" data-anchor-id="example-non-seasonal-example-google-stock-price-1">Example: Non-Seasonal Example — Google Stock Price</h3>
<div id="cell-165" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:507}}" data-outputid="06c57105-d444-4f1f-a1f9-3db2ae325c88" data-execution_count="46">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Google — 2015 train, Jan 2016 test; show forecasts in color (not black)</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix: avoid pandas .query with .dt accessors; use boolean masks instead.</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> HistoricAverage, Naive, RandomWalkWithDrift</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>goog_df <span class="op">=</span> goog.loc[(goog[<span class="st">"ds"</span>] <span class="op">&gt;=</span> <span class="st">"2015-01-01"</span>) <span class="op">&amp;</span> (goog[<span class="st">"ds"</span>] <span class="op">&lt;=</span> <span class="st">"2016-01-31"</span>)].copy()</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Prepare contiguous trading-day index for plotting ---</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> (</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    goog_df.loc[goog_df[<span class="st">"ds"</span>].dt.year <span class="op">==</span> <span class="dv">2015</span>, [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]]</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> (</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    goog_df.loc[(goog_df[<span class="st">"ds"</span>].dt.year <span class="op">==</span> <span class="dv">2016</span>) <span class="op">&amp;</span> (goog_df[<span class="st">"ds"</span>].dt.month <span class="op">==</span> <span class="dv">1</span>),</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>                [<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]]</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a><span class="co"># integer index for StatsForecast</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">"ds"</span>] <span class="op">=</span> np.arange(<span class="bu">len</span>(train_df), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="co"># align test dates right after the training window for plotting/overlay</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">"ds"</span>] <span class="op">=</span> np.arange(<span class="bu">len</span>(train_df), <span class="bu">len</span>(train_df) <span class="op">+</span> <span class="bu">len</span>(test_df), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Fit models &amp; forecast for the Jan 2016 horizon ---</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[RandomWalkWithDrift(), HistoricAverage(), Naive()], freq<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> sf.forecast(df<span class="op">=</span>train_df, h<span class="op">=</span><span class="bu">len</span>(test_df))</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Add actual Jan 2016 values for reference (optional)</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> preds.merge(test_df[[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>]], on<span class="op">=</span>[<span class="st">"unique_id"</span>, <span class="st">"ds"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize (model) column names across StatsForecast versions</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>model_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> preds.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"unique_id"</span>, <span class="st">"ds"</span>, <span class="st">"y"</span>)]</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>rename <span class="op">=</span> {}</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> model_cols:</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>    cl <span class="op">=</span> c.lower()</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cl <span class="kw">in</span> (<span class="st">"rwd"</span>, <span class="st">"randomwalkwithdrift"</span>): rename[c] <span class="op">=</span> <span class="st">"Drift"</span></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">"historicaverage"</span> <span class="kw">in</span> cl <span class="kw">or</span> cl <span class="op">==</span> <span class="st">"mean"</span>: rename[c] <span class="op">=</span> <span class="st">"Mean"</span></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> cl <span class="op">==</span> <span class="st">"naive"</span>: rename[c] <span class="op">=</span> <span class="st">"Naive"</span></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> preds.rename(columns<span class="op">=</span>rename)</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Plot (actuals in gray; forecasts in color) ---</span></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Training and holdout actuals</span></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>ax.plot(train_df[<span class="st">"ds"</span>], train_df[<span class="st">"y"</span>], color<span class="op">=</span><span class="st">"0.45"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">1.6</span>, label<span class="op">=</span><span class="st">"Actuals (2015)"</span>)</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>ax.plot(test_df[<span class="st">"ds"</span>],  test_df[<span class="st">"y"</span>],  color<span class="op">=</span><span class="st">"0.45"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">1.6</span>, label<span class="op">=</span><span class="st">"Actuals (Jan 2016)"</span>)</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Colored forecasts</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {<span class="st">"Drift"</span>: <span class="st">"tab:orange"</span>, <span class="st">"Mean"</span>: <span class="st">"tab:blue"</span>, <span class="st">"Naive"</span>: <span class="st">"tab:green"</span>}</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, color <span class="kw">in</span> color_map.items():</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> name <span class="kw">in</span> preds.columns:</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>        ax.plot(preds[<span class="st">"ds"</span>], preds[name], linewidth<span class="op">=</span><span class="fl">2.4</span>, label<span class="op">=</span>name, color<span class="op">=</span>color)</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Google closing stock prices: 2015 (train) and Jan 2016 (test)"</span>)</span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"day index"</span>)</span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"$US"</span>)</span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">"Forecast"</span>, loc<span class="op">=</span><span class="st">"best"</span>, frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-48-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-non-seasonal-example-google-stock-price-2" class="level3">
<h3 class="anchored" data-anchor-id="example-non-seasonal-example-google-stock-price-2">Example: Non-Seasonal Example — Google Stock Price</h3>
<div id="cell-167" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:143}}" data-outputid="9bfbda1c-646b-494a-da35-dddbc04c1b17" data-execution_count="47">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Accuracy table for 2016 holdout (RMSE, MAE, MAPE, MASE) ---</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only the 2016 horizon</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>h_start, h_end <span class="op">=</span> test_df[<span class="st">"ds"</span>].<span class="bu">min</span>(), test_df[<span class="st">"ds"</span>].<span class="bu">max</span>()</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>holdout <span class="op">=</span> preds.loc[(preds[<span class="st">"ds"</span>] <span class="op">&gt;=</span> h_start) <span class="op">&amp;</span> (preds[<span class="st">"ds"</span>] <span class="op">&lt;=</span> h_end)].copy()</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Map model display names to whatever column name exists in `preds`</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>method_columns <span class="op">=</span> {</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RWD"</span>: [<span class="st">"RWD"</span>, <span class="st">"RandomWalkWithDrift"</span>, <span class="st">"Drift"</span>],</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HistoricAverage"</span>: [<span class="st">"HistoricAverage"</span>, <span class="st">"Mean"</span>],</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Naive"</span>: [<span class="st">"Naive"</span>],</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>resolved_cols <span class="op">=</span> {}</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> disp, candidates <span class="kw">in</span> method_columns.items():</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> c <span class="kw">in</span> candidates:</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> c <span class="kw">in</span> holdout.columns:</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>            resolved_cols[disp] <span class="op">=</span> c</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a><span class="co"># In-sample denominator for MASE (m=1 for daily prices)</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>y_tr <span class="op">=</span> train_df[<span class="st">"y"</span>].to_numpy()</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>mase_denom <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(y_tr[<span class="dv">1</span>:] <span class="op">-</span> y_tr[:<span class="op">-</span><span class="dv">1</span>]))</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _rmse(y, yhat):</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.sqrt(np.mean((y <span class="op">-</span> yhat) <span class="op">**</span> <span class="dv">2</span>)))</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _mae(y, yhat):</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.mean(np.<span class="bu">abs</span>(y <span class="op">-</span> yhat)))</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _mape(y, yhat):</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># guard (not needed for prices, but keeps it robust)</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>    y_safe <span class="op">=</span> np.where(y <span class="op">==</span> <span class="dv">0</span>, np.nan, y)</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.nanmean(np.<span class="bu">abs</span>((y <span class="op">-</span> yhat) <span class="op">/</span> y_safe)) <span class="op">*</span> <span class="fl">100.0</span>)</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> holdout[<span class="st">"y"</span>].to_numpy()</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> disp_name <span class="kw">in</span> [<span class="st">"RWD"</span>, <span class="st">"HistoricAverage"</span>, <span class="st">"Naive"</span>]:</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> disp_name <span class="kw">not</span> <span class="kw">in</span> resolved_cols:</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>    yhat <span class="op">=</span> holdout[resolved_cols[disp_name]].to_numpy()</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> _mae(y_true, yhat)</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> {</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Method"</span>: disp_name,</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"RMSE"</span>: _rmse(y_true, yhat),</span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MAE"</span>: mae,</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MAPE"</span>: _mape(y_true, yhat),</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MASE"</span>: mae <span class="op">/</span> mase_denom <span class="cf">if</span> mase_denom <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan,</span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>    rows.append(row)</span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>acc_df <span class="op">=</span> pd.DataFrame(rows, columns<span class="op">=</span>[<span class="st">"Method"</span>, <span class="st">"RMSE"</span>, <span class="st">"MAE"</span>, <span class="st">"MAPE"</span>, <span class="st">"MASE"</span>])</span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Format to 3 decimals to match the screenshot</span></span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>acc_df[[<span class="st">"RMSE"</span>, <span class="st">"MAE"</span>, <span class="st">"MAPE"</span>, <span class="st">"MASE"</span>]] <span class="op">=</span> acc_df[[<span class="st">"RMSE"</span>, <span class="st">"MAE"</span>, <span class="st">"MAPE"</span>, <span class="st">"MASE"</span>]].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a><span class="co"># (Optional) pretty print similar to the attachment</span></span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>acc_df_style <span class="op">=</span> (</span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>    acc_df.style</span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>    .hide(axis<span class="op">=</span><span class="st">"index"</span>)</span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">format</span>({<span class="st">"RMSE"</span>: <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>, <span class="st">"MAE"</span>: <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>, <span class="st">"MAPE"</span>: <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>, <span class="st">"MASE"</span>: <span class="st">"</span><span class="sc">{:.3f}</span><span class="st">"</span>})</span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a>    .set_table_styles(</span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"selector"</span>: <span class="st">"th"</span>, <span class="st">"props"</span>: [(<span class="st">"background-color"</span>, <span class="st">"#8c8c8c"</span>), (<span class="st">"color"</span>, <span class="st">"white"</span>), (<span class="st">"font-weight"</span>, <span class="st">"bold"</span>)]},</span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"selector"</span>: <span class="st">"td"</span>, <span class="st">"props"</span>: [(<span class="st">"background-color"</span>, <span class="st">"#f6f6f6"</span>)]}</span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a>        overwrite<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a>acc_df, acc_df_style  <span class="co"># display(acc_df_style) in notebooks</span></span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a>display(acc_df_style)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">


<table id="T_427a5" class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_427a5_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Method</th>
<th id="T_427a5_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">RMSE</th>
<th id="T_427a5_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">MAE</th>
<th id="T_427a5_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">MAPE</th>
<th id="T_427a5_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">MASE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_427a5_row0_col0" class="data row0 col0">RWD</td>
<td id="T_427a5_row0_col1" class="data row0 col1">53.070</td>
<td id="T_427a5_row0_col2" class="data row0 col2">49.824</td>
<td id="T_427a5_row0_col3" class="data row0 col3">6.992</td>
<td id="T_427a5_row0_col4" class="data row0 col4">6.990</td>
</tr>
<tr class="even">
<td id="T_427a5_row1_col0" class="data row1 col0">HistoricAverage</td>
<td id="T_427a5_row1_col1" class="data row1 col1">118.032</td>
<td id="T_427a5_row1_col2" class="data row1 col2">116.945</td>
<td id="T_427a5_row1_col3" class="data row1 col3">16.235</td>
<td id="T_427a5_row1_col4" class="data row1 col4">16.406</td>
</tr>
<tr class="odd">
<td id="T_427a5_row2_col0" class="data row2 col0">Naive</td>
<td id="T_427a5_row2_col1" class="data row2 col1">43.432</td>
<td id="T_427a5_row2_col2" class="data row2 col2">40.384</td>
<td id="T_427a5_row2_col3" class="data row2 col3">5.673</td>
<td id="T_427a5_row2_col4" class="data row2 col4">5.666</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
</section>
<section id="time-series-cross-validation" class="level1">
<h1>8 – Time Series Cross-Validation</h1>
<p><strong>Time series cross-validation</strong> is a more advanced and reliable approach than the traditional single <strong>training/test split</strong> for evaluating forecasting models.</p>
<section id="concept" class="level3">
<h3 class="anchored" data-anchor-id="concept"><strong>Concept</strong></h3>
<ul>
<li>The data are divided into a <strong>sequence of training and test sets</strong>.</li>
<li>Each <strong>test set</strong> contains <strong>one observation</strong>, and its corresponding <strong>training set</strong> includes <strong>only past observations</strong> — ensuring <strong>no future information leakage</strong>.</li>
<li>Because accurate forecasts require sufficient historical data, the <strong>earliest observations</strong> are <strong>not used as test cases</strong>.</li>
</ul>
<p>This iterative approach enables a <strong>comprehensive evaluation</strong> of model performance across multiple forecast origins, providing a <strong>more robust measure of predictive accuracy</strong> for time-dependent data.</p>
</section>
<section id="time-series-cross-validation-1" class="level3">
<h3 class="anchored" data-anchor-id="time-series-cross-validation-1">Time Series Cross-Validation</h3>
<center>
<div>
<p><img src="https://raw.githubusercontent.com/davi-moreira/2025F_predictive_analytics_purdue_MGMT474/main/lecture_slides/figs/time_series_cv1.png" width="200"></p>
</div>
</center>
<p>XXX incluir figura time_series_cv1 XXX</p>
</section>
<section id="forecast-accuracy-and-rolling-forecasting-origin" class="level3">
<h3 class="anchored" data-anchor-id="forecast-accuracy-and-rolling-forecasting-origin">Forecast Accuracy and Rolling Forecasting Origin</h3>
<p>The <strong>forecast accuracy</strong> in time series cross-validation is obtained by <strong>averaging the forecast errors</strong> across all <strong>test sets</strong>.</p>
<p>This approach is often referred to as <strong>“evaluation on a rolling forecasting origin”</strong>, because the <strong>forecast origin</strong> — the point from which predictions are made — <strong>moves forward through time</strong>.</p>
</section>
<section id="multi-step-forecast-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="multi-step-forecast-evaluation">Multi-Step Forecast Evaluation</h3>
<p>In many applications, <strong>multi-step forecasts</strong> (e.g., predicting several periods ahead) are more informative than one-step forecasts. The <strong>rolling-origin cross-validation</strong> method can be extended to evaluate <strong>multi-step errors</strong>, ensuring that performance is measured over the desired forecast horizon.</p>
<p>For instance, if the goal is to assess <strong>4-step-ahead forecast accuracy</strong>, each iteration uses the available data up to time <span class="math inline">\(t\)</span> to forecast up to <strong><span class="math inline">\(t + 4\)</span></strong>, and errors are computed accordingly — as illustrated in the diagram below.</p>
</section>
<section id="time-series-cross-validation-with-multi-step-models." class="level3">
<h3 class="anchored" data-anchor-id="time-series-cross-validation-with-multi-step-models.">Time series cross-validation with multi-step models.</h3>
<center>
<div>
<p><img src="https://raw.githubusercontent.com/davi-moreira/2025F_predictive_analytics_purdue_MGMT474/main/lecture_slides/figs/time_series_cv_multistep.png" width="200"></p>
</div>
</center>
<p>XXX incluir figura time_series_cv_multistep XXX</p>
</section>
<section id="comparing-residual-accuracy-and-cross-validation-accuracy" class="level3">
<h3 class="anchored" data-anchor-id="comparing-residual-accuracy-and-cross-validation-accuracy">Comparing Residual Accuracy and Cross-Validation Accuracy</h3>
<p>In this example, we compare <strong>forecast accuracy</strong> obtained from <strong>time series cross-validation</strong> with that derived from <strong>in-sample residuals</strong>.</p>
<p>The <strong><code>cross_validation()</code></strong> function is used to generate <strong>multiple training and test sets</strong>, enabling robust out-of-sample evaluation.</p>
<p>Here, the procedure creates <strong>249 validation windows</strong>, each corresponding to <strong>one time step ahead</strong>. This setup allows for a systematic comparison between:</p>
<ul>
<li><strong>Residual-based accuracy</strong>, which measures in-sample fit, and</li>
<li><strong>Cross-validation accuracy</strong>, which evaluates true out-of-sample performance.</li>
</ul>
<p>Such comparison highlights how <strong>cross-validation provides a more realistic assessment</strong> of forecasting model reliability.</p>
<div id="cell-174" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}}" data-outputid="9aa09e26-e646-4436-dd3e-b53f0f06687e" data-execution_count="48">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>goog_2015 <span class="op">=</span> goog_df.query(<span class="st">"ds.dt.year == 2015"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>drift_method <span class="op">=</span> RandomWalkWithDrift()</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[drift_method], freq<span class="op">=</span><span class="st">"B"</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>cv_df <span class="op">=</span> sf.cross_validation(h<span class="op">=</span><span class="dv">1</span>, df<span class="op">=</span>goog_2015, step_size<span class="op">=</span><span class="dv">1</span>, test_size<span class="op">=</span><span class="dv">249</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>cv_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<div id="df-bf201efa-48c0-4f67-9b0e-9d6e6d4dda79" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">cutoff</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">RWD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>GOOG_Close</td>
<td>2015-01-07</td>
<td>2015-01-06</td>
<td>498.358</td>
<td>487.850</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>GOOG_Close</td>
<td>2015-01-08</td>
<td>2015-01-07</td>
<td>499.929</td>
<td>490.497</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>GOOG_Close</td>
<td>2015-01-09</td>
<td>2015-01-08</td>
<td>493.454</td>
<td>494.427</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>GOOG_Close</td>
<td>2015-01-12</td>
<td>2015-01-09</td>
<td>489.854</td>
<td>487.758</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>GOOG_Close</td>
<td>2015-01-13</td>
<td>2015-01-12</td>
<td>493.464</td>
<td>484.507</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-bf201efa-48c0-4f67-9b0e-9d6e6d4dda79')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-bf201efa-48c0-4f67-9b0e-9d6e6d4dda79 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-bf201efa-48c0-4f67-9b0e-9d6e6d4dda79');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-ad020694-7495-4423-b22c-c1ad2a346ca9">
      <button class="colab-df-quickchart" onclick="quickchart('df-ad020694-7495-4423-b22c-c1ad2a346ca9')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-ad020694-7495-4423-b22c-c1ad2a346ca9 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
</section>
<section id="comparing-residual-accuracy-and-cross-validation-accuracy-1" class="level3">
<h3 class="anchored" data-anchor-id="comparing-residual-accuracy-and-cross-validation-accuracy-1">Comparing Residual Accuracy and Cross-Validation Accuracy</h3>
<p>The evaluate() function can be used to evaluate the forecast accuracy across the training sets.</p>
<div id="cell-176" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast <span class="im">import</span> StatsForecast</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsforecast.models <span class="im">import</span> RandomWalkWithDrift</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.evaluation <span class="im">import</span> evaluate</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.losses <span class="im">import</span> rmse, mae, mape, mase</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co"># -------- Data (business-day dates; keep as datetimes) --------</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>goog_2015 <span class="op">=</span> goog_df.query(<span class="st">"ds.dt.year == 2015"</span>).copy().sort_values(<span class="st">"ds"</span>)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="co"># -------- 1) Cross-validation (h=1) --------</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>sf_cv <span class="op">=</span> StatsForecast(models<span class="op">=</span>[RandomWalkWithDrift()], freq<span class="op">=</span><span class="st">"B"</span>)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>cv_df <span class="op">=</span> sf_cv.cross_validation(h<span class="op">=</span><span class="dv">1</span>, df<span class="op">=</span>goog_2015, step_size<span class="op">=</span><span class="dv">1</span>, test_size<span class="op">=</span><span class="dv">249</span>)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>cv_eval <span class="op">=</span> evaluate(</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    cv_df,</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>[rmse, mae, mape, partial(mase, seasonality<span class="op">=</span><span class="dv">1</span>)],</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>[<span class="st">"RWD"</span>],</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    train_df<span class="op">=</span>goog_2015,</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a><span class="co"># -------- 2) In-sample 1-step fitted forecasts --------</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>sf_tr <span class="op">=</span> StatsForecast(models<span class="op">=</span>[RandomWalkWithDrift()], freq<span class="op">=</span><span class="st">"B"</span>)</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> sf_tr.forecast(df<span class="op">=</span>goog_2015, h<span class="op">=</span><span class="dv">1</span>, fitted<span class="op">=</span><span class="va">True</span>)  <span class="co"># populate fitted store</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>fitted <span class="op">=</span> sf_tr.forecast_fitted_values()</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>train_eval <span class="op">=</span> evaluate(</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>    fitted,</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>[rmse, mae, mape, partial(mase, seasonality<span class="op">=</span><span class="dv">1</span>)],</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>[<span class="st">"RWD"</span>],</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>    train_df<span class="op">=</span>goog_2015,</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-177" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:125}}" data-outputid="ca51026a-3c22-4941-e130-ca20a792fb97" data-execution_count="50">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the "Method / RMSE / MAE / MAPE / MASE" table from evaluate() outputs</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _eval_row(eval_df: pd.DataFrame, label: <span class="bu">str</span>, model_col: <span class="bu">str</span> <span class="op">=</span> <span class="st">"RWD"</span>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reshape: rows -&gt; metrics, pick the model column (RWD)</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> (eval_df.set_index(<span class="st">"metric"</span>)[model_col].astype(<span class="bu">float</span>))</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># normalize keys</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    tmp.index <span class="op">=</span> tmp.index.<span class="bu">str</span>.lower()</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if MAPE is reported as a fraction, convert to %</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    mape_val <span class="op">=</span> tmp.get(<span class="st">"mape"</span>)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.notna(mape_val) <span class="kw">and</span> mape_val <span class="op">&lt;</span> <span class="dv">1</span>:</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>        mape_val <span class="op">=</span> mape_val <span class="op">*</span> <span class="fl">100.0</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series(</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Method"</span>: label,</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"RMSE"</span>:  tmp.get(<span class="st">"rmse"</span>, np.nan),</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"MAE"</span>:   tmp.get(<span class="st">"mae"</span>,  np.nan),</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"MAPE"</span>:  mape_val,</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"MASE"</span>:  tmp.get(<span class="st">"mase"</span>, np.nan),</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>cv_row    <span class="op">=</span> _eval_row(cv_eval,    <span class="st">"Cross-validation - ['RWD']"</span>)</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>train_row <span class="op">=</span> _eval_row(train_eval, <span class="st">"Training - ['RWD']"</span>)</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>final_tbl <span class="op">=</span> (</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame([cv_row, train_row])</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>      .assign(</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>          RMSE<span class="op">=</span><span class="kw">lambda</span> d: d[<span class="st">"RMSE"</span>].<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>          MAE <span class="op">=</span><span class="kw">lambda</span> d: d[<span class="st">"MAE"</span>].<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>          MAPE<span class="op">=</span><span class="kw">lambda</span> d: d[<span class="st">"MAPE"</span>].<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>          MASE<span class="op">=</span><span class="kw">lambda</span> d: d[<span class="st">"MASE"</span>].<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>      )[[<span class="st">"Method"</span>,<span class="st">"RMSE"</span>,<span class="st">"MAE"</span>,<span class="st">"MAPE"</span>,<span class="st">"MASE"</span>]]</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>final_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<div id="df-898a269a-3adc-4b06-905a-fe138fc97b58" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Method</th>
<th data-quarto-table-cell-role="th">RMSE</th>
<th data-quarto-table-cell-role="th">MAE</th>
<th data-quarto-table-cell-role="th">MAPE</th>
<th data-quarto-table-cell-role="th">MASE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Cross-validation - ['RWD']</td>
<td>11.27</td>
<td>7.26</td>
<td>1.19</td>
<td>1.02</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Training - ['RWD']</td>
<td>11.15</td>
<td>7.16</td>
<td>1.18</td>
<td>1.00</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-898a269a-3adc-4b06-905a-fe138fc97b58')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-898a269a-3adc-4b06-905a-fe138fc97b58 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-898a269a-3adc-4b06-905a-fe138fc97b58');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-f46d3601-062a-4f7e-bf7a-61ebca477846">
      <button class="colab-df-quickchart" onclick="quickchart('df-f46d3601-062a-4f7e-bf7a-61ebca477846')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-f46d3601-062a-4f7e-bf7a-61ebca477846 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

  <div id="id_cd12f359-8281-4d24-a731-7ead442bc894">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('final_tbl')" title="Generate code using this dataframe." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"></path>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_cd12f359-8281-4d24-a731-7ead442bc894 button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('final_tbl');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div>
</div>
</section>
<section id="interpreting-forecast-accuracy-results" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-forecast-accuracy-results">Interpreting Forecast Accuracy Results</h3>
<p>As expected, <strong>accuracy measures based on residuals</strong> are <strong>smaller</strong> because these “forecasts” are derived from a <strong>model fitted to the entire dataset</strong>, not from genuine out-of-sample predictions.</p>
<p>In contrast, <strong>time series cross-validation</strong> provides a <strong>more realistic evaluation</strong> of model performance on unseen data.</p>
</section>
<section id="model-selection-criterion" class="level3">
<h3 class="anchored" data-anchor-id="model-selection-criterion"><strong>Model Selection Criterion</strong></h3>
<p>A reliable strategy for choosing the <strong>best forecasting model</strong> is to select the one with the <strong>lowest Root Mean Squared Error (RMSE)</strong> computed using <strong>time series cross-validation</strong>.</p>
<p>This approach ensures that the selected model generalizes well and performs effectively for <strong>future forecasting scenarios</strong>.</p>
</section>
<section id="example-forecast-horizon-accuracy-with-cross-validation" class="level2">
<h2 class="anchored" data-anchor-id="example-forecast-horizon-accuracy-with-cross-validation">Example: Forecast Horizon Accuracy with Cross-Validation</h2>
<p>The <strong><code>google_2015</code></strong> subset of the <strong><code>gafa_stock</code></strong> dataset contains <strong>daily closing stock prices</strong> for <strong>Google Inc.</strong> from the <strong>NASDAQ exchange</strong> throughout <strong>2015</strong>.</p>
<p>In this example, the code evaluates the <strong>forecasting performance</strong> of <strong>drift forecasts</strong> across <strong>1- to 8-step-ahead horizons</strong> using <strong>time series cross-validation</strong>.</p>
<p>Here, <strong>horizons</strong> are the <strong>lead times</strong> we are evaluating—i.e., the number of <strong>business days ahead</strong> each forecast targets, given <code>freq="B"</code> and a daily rolling origin.</p>
</section>
<section id="example-forecast-horizon-accuracy-with-cross-validation-1" class="level2">
<h2 class="anchored" data-anchor-id="example-forecast-horizon-accuracy-with-cross-validation-1">Example: Forecast Horizon Accuracy with Cross-Validation</h2>
<p>Concretely:</p>
<ul>
<li><code>h = 1</code> → next-business-day forecasts (e.g., cutoff 2015-01-06 → predict ds 2015-01-07).</li>
<li><code>h = 2</code> → two-business-days-ahead forecasts (cutoff t → predict ds t+2B).</li>
<li>…</li>
<li><code>h = 8</code> → eight-business-days-ahead forecasts.</li>
</ul>
<p>For each <code>h</code> in <code>np.arange(1, 9)</code>, <code>cross_validation(h=h, step_size=1, test_size=249)</code> rolls the origin one business day at a time across 2015, computes all <strong>h-step-ahead</strong> predictions with <code>RandomWalkWithDrift</code>, and <code>evaluate(..., metrics=[rmse])</code> aggregates the RMSE across those folds for that specific horizon. The scatter then plots <strong>RMSE vs.&nbsp;forecast horizon (1–8 business days ahead)</strong>.</p>
<p>The resulting plot demonstrates that <strong>forecast error increases with the forecast horizon</strong>, which is the expected outcome — as <strong>longer-term forecasts</strong> naturally accumulate more <strong>uncertainty</strong> and <strong>modeling error</strong> over time.</p>
<div id="cell-181" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:528}}" data-outputid="cbfe6753-b870-4f9c-fee7-46c6b188b6bb" data-execution_count="51">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>rmses <span class="op">=</span> []</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>drift_model <span class="op">=</span> RandomWalkWithDrift()</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>horizons <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="dv">9</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> horizon <span class="kw">in</span> horizons:</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    sf <span class="op">=</span> StatsForecast(models<span class="op">=</span>[drift_model], freq<span class="op">=</span><span class="st">"B"</span>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    cv_df <span class="op">=</span> sf.cross_validation(h<span class="op">=</span>horizon, df<span class="op">=</span>goog_2015, step_size<span class="op">=</span><span class="dv">1</span>, test_size<span class="op">=</span><span class="dv">249</span>)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    cv_evaluation <span class="op">=</span> evaluate(cv_df, metrics<span class="op">=</span>[rmse], models<span class="op">=</span>[<span class="st">"RWD"</span>])</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    rmses.append(cv_evaluation[<span class="st">"RWD"</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>ax.scatter(horizons, rmses)</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"h"</span>)</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"RMSE"</span>)</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"RMSE vs horizon for drift method (Google 2015)"</span>)</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-53-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="end-to-end-workflow" class="level1">
<h1>9 - End-to-End Workflow</h1>
<div id="cell-183" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="2ef16814-4da2-4f71-91ce-528de5bad77d" data-execution_count="52">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install sktime scikit<span class="op">-</span>learn pandas numpy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: sktime in /usr/local/lib/python3.12/dist-packages (0.39.0)
Requirement already satisfied: scikit-learn in /usr/local/lib/python3.12/dist-packages (1.6.1)
Requirement already satisfied: pandas in /usr/local/lib/python3.12/dist-packages (2.2.2)
Requirement already satisfied: numpy in /usr/local/lib/python3.12/dist-packages (2.0.2)
Requirement already satisfied: joblib&lt;1.6,&gt;=1.2.0 in /usr/local/lib/python3.12/dist-packages (from sktime) (1.5.2)
Requirement already satisfied: packaging in /usr/local/lib/python3.12/dist-packages (from sktime) (25.0)
Requirement already satisfied: scikit-base&lt;0.13.0,&gt;=0.6.1 in /usr/local/lib/python3.12/dist-packages (from sktime) (0.12.6)
Requirement already satisfied: scipy&lt;2.0.0,&gt;=1.2 in /usr/local/lib/python3.12/dist-packages (from sktime) (1.15.3)
Requirement already satisfied: threadpoolctl&gt;=3.1.0 in /usr/local/lib/python3.12/dist-packages (from scikit-learn) (3.6.0)
Requirement already satisfied: python-dateutil&gt;=2.8.2 in /usr/local/lib/python3.12/dist-packages (from pandas) (2.9.0.post0)
Requirement already satisfied: pytz&gt;=2020.1 in /usr/local/lib/python3.12/dist-packages (from pandas) (2025.2)
Requirement already satisfied: tzdata&gt;=2022.7 in /usr/local/lib/python3.12/dist-packages (from pandas) (2025.2)
Requirement already satisfied: six&gt;=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil&gt;=2.8.2-&gt;pandas) (1.17.0)</code></pre>
</div>
</div>
<div id="cell-184" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment setup and imports.</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Install these locally if missing:</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># pip install sktime scikit-learn pandas numpy</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.model_selection <span class="im">import</span> temporal_train_test_split</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.naive <span class="im">import</span> NaiveForecaster</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.performance_metrics.forecasting <span class="im">import</span> mean_absolute_percentage_error</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> Ridge</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.compose <span class="im">import</span> make_reduction</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.model_selection <span class="im">import</span> SlidingWindowSplitter, ForecastingGridSearchCV</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">474</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="synthetic-time-series-for-demonstration" class="level2">
<h2 class="anchored" data-anchor-id="synthetic-time-series-for-demonstration">Synthetic Time Series for Demonstration</h2>
<p>We create a simple seasonal signal with noise to illustrate temporal splits, naive baselines, direct/recursive reduction, and rolling backtests.</p>
<p>Synthetic data and seasonal period</p>
<ul>
<li><p>The series is daily and length 400.</p></li>
<li><p>Signal = sinusoid <span class="math inline">\(+;\)</span> noise <span class="math inline">\(+;\)</span> linear trend:</p>
<p><span class="math display">\[
y_t=\sin(t/12)+0.1,\varepsilon_t+0.01,t,
\]</span></p>
<p>which creates a smooth seasonal‐like cycle and a mild upward trend.</p></li>
<li><p><code>SP = 75</code> is the assumed season length (approximately the sinusoid’s cycle in days).</p></li>
</ul>
<div id="cell-187" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="a959f910-6083-488e-b581-da06ed842e93" data-execution_count="54">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Synthetic data</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">400</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> pd.date_range(<span class="st">"2015-01-01"</span>, periods<span class="op">=</span>n, freq<span class="op">=</span><span class="st">"D"</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.Series(</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    np.sin(np.arange(n) <span class="op">/</span> <span class="fl">12.0</span>) <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> np.random.randn(n) <span class="op">+</span> <span class="fl">0.01</span> <span class="op">*</span> np.arange(n),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>idx,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"y"</span>,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>SP <span class="op">=</span> <span class="dv">75</span>  <span class="co"># seasonal period</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>y.head(), y.tail()</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>(2015-01-01    0.104
 2015-01-02    0.026
 2015-01-03    0.298
 2015-01-04    0.206
 2015-01-05    0.350
 Freq: D, Name: y, dtype: float64,
 2016-01-31    4.970
 2016-02-01    4.902
 2016-02-02    4.751
 2016-02-03    5.126
 2016-02-04    5.009
 Freq: D, Name: y, dtype: float64)</code></pre>
</div>
</div>
<div id="cell-188" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:623}}" data-outputid="8c30840b-667a-4c3f-d824-8b3837832ef1" data-execution_count="55">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>y)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Synthetic Time Series Data (y)"</span>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Value"</span>)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-57-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="temporal-split-and-naive-benchmark" class="level2">
<h2 class="anchored" data-anchor-id="temporal-split-and-naive-benchmark">Temporal Split and Naive Benchmark</h2>
<p>We use a last-value naive forecaster as a baseline and compute MAPE on a 30-step horizon.</p>
<p><strong>Goal</strong> Set up a fair, time-aware test for forecasting. Start with an easy-to-understand baseline (the “last value” forecast) and measure how far off it is using MAPE.</p>
<p><strong>1) Split by time (no leakage)</strong></p>
<ul>
<li><code>temporal_train_test_split(y, test_size=30)</code> cuts the series into two parts <strong>in order</strong>: <strong>train</strong> = everything up to the split; <strong>test</strong> = the last 30 points.</li>
<li>We never let the model see the test part while training. This prevents <strong>look-ahead bias</strong> (using future info to predict the future).</li>
</ul>
<p><strong>2) Tell the model how far ahead to predict (the horizon <code>fh</code>)</strong></p>
<ul>
<li><code>fh = np.arange(1, len(y_test) + 1)</code> creates the steps we want: 1, 2, …, 30 days ahead.</li>
<li>This is a <strong>relative horizon</strong>: “from the last training day, predict 1 step ahead, then 2, …”. It works regardless of whether the index is dates or simple integers.</li>
</ul>
<p><strong>3) Baseline forecast: “last value”</strong></p>
<ul>
<li><code>NaiveForecaster(strategy="last")</code> always predicts the <strong>last value from the training set</strong> for every future step.</li>
<li><code>fit(y_train)</code> just remembers that last value; no parameters are learned.</li>
<li><code>predict(fh)</code> returns a flat line (same number repeated for all 30 steps).</li>
<li>Why use it? It’s a <strong>sanity check</strong>. If a fancy model can’t beat this, it’s not adding value.</li>
</ul>
<p><strong>4) How we score it: MAPE</strong></p>
<ul>
<li><code>mean_absolute_percentage_error(y_test, y_pred_last)</code> computes MAPE = average of <span class="math inline">\(|y_t - \hat y_t| / |y_t| \times 100%\)</span>.</li>
<li>Interpretation: on average, how many percent off are our forecasts on the 30 test points?</li>
<li>Caution: if any true value is 0 (or very close), MAPE can blow up. In those cases also report MAE or RMSE, or use sMAPE.</li>
</ul>
<p><strong>5) Why this setup matters</strong></p>
<ul>
<li><strong>Fairness</strong>: time-ordered split avoids peeking into the future.</li>
<li><strong>Benchmarking</strong>: gives a clear bar to beat (<code>mape_last</code>).</li>
<li><strong>Reproducibility</strong>: explicit horizon + explicit metric = results others can replicate.</li>
</ul>
<p><strong>6) Helpful variations</strong></p>
<ul>
<li><strong>Seasonal data</strong>: <code>NaiveForecaster(strategy="seasonal_last", sp=m)</code> uses the last value from the same season (e.g., same month last year if <code>m=12</code>).</li>
<li><strong>Trend</strong>: <code>strategy="drift"</code> extrapolates a straight line from the first to the last training points.</li>
<li><strong>Diagnostics</strong>: check error <strong>by step ahead</strong> (1-step vs 30-step) to see where accuracy decays.</li>
</ul>
<p><strong>Bottom line</strong> You build a clean time-based test, create a simple carry-forward forecast, and compute its MAPE. Any model you try next must deliver a <strong>lower MAPE</strong> than this baseline to be worth using.</p>
<div id="cell-191" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="14136fd7-e4c3-4718-9ce0-f50f38b70dce" data-execution_count="56">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Temporal split</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>y_train, y_test <span class="op">=</span> temporal_train_test_split(y, test_size<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>fh <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="bu">len</span>(y_test) <span class="op">+</span> <span class="dv">1</span>)  <span class="co"># forecast horizon steps ahead</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Naive benchmark</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>f_last <span class="op">=</span> NaiveForecaster(strategy<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>f_last.fit(y_train)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>y_pred_last <span class="op">=</span> f_last.predict(fh)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>mape_last <span class="op">=</span> mean_absolute_percentage_error(y_test, y_pred_last)</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>mape_last</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>np.float64(0.2887089356544459)</code></pre>
</div>
</div>
<div id="cell-192" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:240}}" data-outputid="b473c872-1066-4976-b238-d49f691c0d71" data-execution_count="57">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>y_train.tail()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016-01-01</td>
<td>2.753</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016-01-02</td>
<td>2.904</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016-01-03</td>
<td>2.848</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016-01-04</td>
<td>3.204</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016-01-05</td>
<td>2.989</td>
</tr>
</tbody>
</table>

</div><br><label><b>dtype:</b> float64</label>
</div>
</div>
<div id="cell-193" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:240}}" data-outputid="7e674578-a310-4be2-a12e-dfd3a2adf35c" data-execution_count="58">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>y_test.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016-01-06</td>
<td>3.227</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016-01-07</td>
<td>3.189</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016-01-08</td>
<td>3.468</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016-01-09</td>
<td>3.215</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016-01-10</td>
<td>3.306</td>
</tr>
</tbody>
</table>

</div><br><label><b>dtype:</b> float64</label>
</div>
</div>
<div id="cell-194" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:240}}" data-outputid="dc985b7d-7ab6-459e-8edf-44f9a0d1e3eb" data-execution_count="59">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>y_pred_last.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016-01-06</td>
<td>2.989</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016-01-07</td>
<td>2.989</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016-01-08</td>
<td>2.989</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016-01-09</td>
<td>2.989</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2016-01-10</td>
<td>2.989</td>
</tr>
</tbody>
</table>

</div><br><label><b>dtype:</b> float64</label>
</div>
</div>
<div id="cell-195" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:407}}" data-outputid="a6cfe269-d724-4cb4-b2d7-64e7640ae6de" data-execution_count="60">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Actual vs Predicted time series plot</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.utils.plotting <span class="im">import</span> plot_series</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure forecast is indexed on the test horizon (safe for any forecaster)</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>y_pred_last <span class="op">=</span> pd.Series(y_pred_last, index<span class="op">=</span>y_test.index, name<span class="op">=</span><span class="st">"Predicted"</span>)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Pure matplotlib</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>y_train.plot(ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">"Train"</span>)</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>y_test.plot(ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">"Actual"</span>)</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>y_pred_last.plot(ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">"Predicted"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Actual vs Predicted"</span>)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Time"</span>)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"y"</span>)</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-62-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="theta-forecasting-model" class="level2">
<h2 class="anchored" data-anchor-id="theta-forecasting-model">Theta forecasting model</h2>
<p>The code fits a <strong>Theta</strong> forecasting model (without deseasonalizing) and compares it to a <strong>naïve</strong> baseline using <strong>MAPE</strong> on a held-out test window. It avoids “multiplicative seasonality” because the series can take zero/negative values (multiplicative seasonal models require strictly positive data).</p>
<hr>
<section id="key-objects-assumed-from-earlier-cells" class="level3">
<h3 class="anchored" data-anchor-id="key-objects-assumed-from-earlier-cells">Key objects assumed from earlier cells</h3>
<ul>
<li><code>y_train</code>, <code>y_test</code>: time-ordered split of the original series (<code>y</code>), typically produced by <code>temporal_train_test_split</code>.</li>
<li><code>fh</code>: the <strong>forecasting horizon</strong>, e.g., <code>fh = [1,2,…,H]</code>, indicating how many steps ahead to predict from the end of <code>y_train</code>.</li>
<li><code>y_pred_last</code>, <code>mape_last</code>: predictions and MAPE from the naïve benchmark (carry-forward “last value”).</li>
</ul>
<p><strong>Why split by time?</strong> We must preserve ordering to avoid look-ahead bias. Training uses only past data; evaluation is on future points.</p>
<hr>
</section>
<section id="baseline-metric-mape" class="level3">
<h3 class="anchored" data-anchor-id="baseline-metric-mape">Baseline metric: MAPE</h3>
<p>The mean absolute percentage error is</p>
<p><span class="math display">\[
\text{MAPE} = \frac{100%}{H}\sum_{h=1}^{H}\left|\frac{y_{T+h}-\hat y_{T+h}}{y_{T+h}}\right|,
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(T\)</span> = last index in the training set,</li>
<li><span class="math inline">\(H = |fh|\)</span> = number of forecast steps,</li>
<li><span class="math inline">\(y_{T+h}\)</span> = actual value (h) steps ahead,</li>
<li><span class="math inline">\(\hat{y}_{T+h}\)</span> = forecast.</li>
</ul>
<p>Lower is better. MAPE becomes unstable if any (y_{T+h}).</p>
<hr>
</section>
<section id="why-multiplicative-seasonality-is-problematic-here" class="level3">
<h3 class="anchored" data-anchor-id="why-multiplicative-seasonality-is-problematic-here">Why “multiplicative seasonality” is problematic here</h3>
<p>A seasonal component can enter a model <strong>additively</strong> or <strong>multiplicatively</strong>:</p>
<ul>
<li>Additive: <span class="math inline">\(y_t = \text{level}_t + \text{trend}_t + s_t + \varepsilon_t\)</span></li>
<li>Multiplicative: <span class="math inline">\(y_t = \text{level}_t \times \text{trend}_t \times s_t \times (1+\varepsilon_t)\)</span></li>
</ul>
<p>Multiplicative seasonality needs strictly positive (y_t). If the series can be zero/negative (common after centering or with noise), statsmodels raises the error you saw. The code therefore <strong>does not</strong> use multiplicative deseasonalization.</p>
<hr>
</section>
<section id="model-a-thetaforecaster-no-deseasonalization" class="level3">
<h3 class="anchored" data-anchor-id="model-a-thetaforecaster-no-deseasonalization">Model A — ThetaForecaster (no deseasonalization)</h3>
<div class="sourceCode" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> ThetaForecaster(sp<span class="op">=</span><span class="dv">1</span>, deseasonalize<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>theta.fit(y_train)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>y_pred_theta <span class="op">=</span> theta.predict(fh)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>mape_theta <span class="op">=</span> mean_absolute_percentage_error(y_test, y_pred_theta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>What is the Theta method?</strong> The Theta method (Assimakopoulos &amp; Nikolopoulos, 2000) modifies the local curvature of the series by applying <strong>theta lines</strong> to the second differences. It blends two extrapolations:</p>
<ol type="1">
<li>A <strong>local level/trend</strong> component (similar to Simple Exponential Smoothing with drift),</li>
<li>A <strong>long-term mean reversion</strong> component.</li>
</ol>
<p>A useful way to view Theta is its equivalence (under conditions) to <strong>SES with drift</strong> (Hyndman &amp; Billah, 2003):</p>
<ul>
<li><p>SES update:</p>
<p><span class="math display">\[
\ell_t = \alpha y_t + (1-\alpha)\ell_{t-1}
\]</span></p></li>
<li><p>(h)-step forecast with drift:</p>
<p><span class="math display">\[
\hat y_{t+h|t} = \ell_t + d\cdot h,
\]</span></p>
<p>where (d) is a data-driven drift term capturing trend.</p></li>
</ul>
<p>Setting <code>sp=1</code> tells <code>ThetaForecaster</code> that there is <strong>no seasonal period</strong> to remove internally. <code>deseasonalize=False</code> ensures the model does <strong>not</strong> attempt multiplicative/seasonal decomposition (the source of the earlier error). The forecaster then extrapolates level + trend only.</p>
<p><strong>Intuition:</strong></p>
<p>Theta smooths the series to estimate a stable current level and a gentle slope, then projects that slope forward. It’s robust for many series with mild trends.</p>
<hr>
</section>
<section id="comparing-models-and-choosing-the-winner" class="level3">
<h3 class="anchored" data-anchor-id="comparing-models-and-choosing-the-winner">Comparing models and choosing the winner</h3>
<div class="sourceCode" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({<span class="st">"MAPE_last"</span>: <span class="bu">float</span>(mape_last), <span class="st">"MAPE_theta"</span>: <span class="bu">float</span>(mape_theta)})</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>best_name, best_mape, best_pred <span class="op">=</span> <span class="bu">min</span>(</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">"naive"</span>, mape_last, y_pred_last), (<span class="st">"theta_nodeseason"</span>, mape_theta, y_pred_theta)],</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>]</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({<span class="st">"best_model"</span>: best_name, <span class="st">"best_mape"</span>: <span class="bu">float</span>(best_mape)})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>We report the baseline error (<code>MAPE_last</code>) and Theta’s error (<code>MAPE_theta</code>).</li>
<li>We select the model with the <strong>lower</strong> MAPE. If Theta &lt; naïve, we have demonstrated value over a trivial benchmark.</li>
</ul>
<hr>
</section>
<section id="where-ets-fits-conceptually-mentioned-in-comments" class="level3">
<h3 class="anchored" data-anchor-id="where-ets-fits-conceptually-mentioned-in-comments">Where ETS fits conceptually (mentioned in comments)</h3>
<p>Although not executed in this snippet, <strong>Exponential Smoothing (ETS)</strong> models combine:</p>
<ul>
<li><strong>Error</strong> type (additive/multiplicative),</li>
<li><strong>Trend</strong> (none/additive/damped),</li>
<li><strong>Seasonality</strong> (none/additive/multiplicative) with period (s).</li>
</ul>
<p>A common additive ETS specification is:</p>
<p><span class="math display">\[
\begin{aligned}
y_t &amp;= \ell_{t-1} + b_{t-1} + s_{t-s} + \varepsilon_t,\
\ell_t &amp;= \ell_{t-1} + b_{t-1} + \alpha \varepsilon_t,\
b_t &amp;= b_{t-1} + \beta \varepsilon_t,\
s_t &amp;= s_{t-s} + \gamma \varepsilon_t,
\end{aligned}
\]</span></p>
<p>with smoothing parameters (,,(0,1)). ETS is appropriate for additive seasonality and can complement Theta by explicitly modeling seasonal cycles.</p>
<hr>
</section>
<section id="practical-checklist" class="level3">
<h3 class="anchored" data-anchor-id="practical-checklist">Practical checklist</h3>
<ol type="1">
<li><strong>Always</strong> build a naïve baseline and compute its MAPE.</li>
<li>Use time-ordered splits and an explicit horizon.</li>
<li>If your series can be zero/negative, <strong>avoid multiplicative seasonality</strong>. Prefer additive seasonality or set <code>sp=1</code> and handle trend only.</li>
<li>Compare models on the <strong>same</strong> horizon and <strong>same</strong> test window.</li>
<li>Visualize actuals vs.&nbsp;forecasts and inspect step-ahead errors to understand where accuracy degrades.</li>
</ol>
<p><strong>Takeaway:</strong> the code fits a trend-focused Theta model that sidesteps multiplicative-seasonality restrictions, evaluates it with MAPE on a proper time split, and programmatically selects the better performer relative to the naïve standard.</p>
<div id="cell-197" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="8906b60f-b215-41f4-e27b-2e466b74564e" data-execution_count="61">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust alternative that avoids the multiplicative-seasonality error.</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use non-deseasonalized Theta (trend-focused) plus ETS with additive seasonality.</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.model_selection <span class="im">import</span> temporal_train_test_split</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.base <span class="im">import</span> ForecastingHorizon</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.naive <span class="im">import</span> NaiveForecaster</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.performance_metrics.forecasting <span class="im">import</span> mean_absolute_percentage_error</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.theta <span class="im">import</span> ThetaForecaster</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.exp_smoothing <span class="im">import</span> ExponentialSmoothing</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ----- Model A: Theta without internal deseasonalization (avoids multiplicative issue) -----</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Focuses on level/trend; we'll let ETS handle seasonality.</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> ThetaForecaster(sp<span class="op">=</span><span class="dv">1</span>, deseasonalize<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>theta.fit(y_train)</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>y_pred_theta <span class="op">=</span> theta.predict(fh)</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>mape_theta <span class="op">=</span> mean_absolute_percentage_error(y_test, y_pred_theta)</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MAPE_last"</span>: <span class="bu">float</span>(mape_last),</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MAPE_theta"</span>: <span class="bu">float</span>(mape_theta),</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose the better of the two candidate models</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>best_name, best_mape, best_pred <span class="op">=</span> <span class="bu">min</span>(</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">"naive"</span>, mape_last, y_pred_last), (<span class="st">"theta_nodeseason"</span>, mape_theta, y_pred_theta)],</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>]</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({<span class="st">"best_model"</span>: best_name, <span class="st">"best_mape"</span>: <span class="bu">float</span>(best_mape)})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'MAPE_last': 0.2887089356544459, 'MAPE_theta': 0.2658110643420696}
{'best_model': 'theta_nodeseason', 'best_mape': 0.2658110643420696}</code></pre>
</div>
</div>
<div id="cell-198" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:407}}" data-outputid="c3351239-589b-444d-d295-8e75490b73ca" data-execution_count="62">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot actuals and forecasts (naive, theta, ETS) with distinct colors/styles</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure all forecasts are Series aligned to the test index</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>y_pred_last  <span class="op">=</span> pd.Series(y_pred_last,  index<span class="op">=</span>y_test.index, name<span class="op">=</span><span class="st">"Naive"</span>)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>y_pred_theta <span class="op">=</span> pd.Series(y_pred_theta, index<span class="op">=</span>y_test.index, name<span class="op">=</span><span class="st">"Theta"</span>)</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Actuals</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>y_train.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"0.7"</span>, label<span class="op">=</span><span class="st">"Train"</span>)</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>y_test.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Actual"</span>)</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>y_pred_last.plot(ax<span class="op">=</span>ax,  color<span class="op">=</span><span class="st">"#1f77b4"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"Naive"</span>)</span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>y_pred_theta.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"#ff7f0e"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"Theta"</span>)</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Split marker</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>ax.axvline(y_test.index[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"0.5"</span>, linestyle<span class="op">=</span><span class="st">":"</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Actual vs Forecasts (Naive, Theta)"</span>)</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Time"</span>)</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"y"</span>)</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">"best"</span>, ncols<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-64-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="exponential-smoothing-ets-model" class="level2">
<h2 class="anchored" data-anchor-id="exponential-smoothing-ets-model">Exponential Smoothing (ETS) model</h2>
<p><strong>What this code does</strong> Fits an Exponential Smoothing (ETS) model with <strong>additive trend</strong> and <strong>additive seasonality</strong> to the training data, generates multi-step forecasts for the test horizon, evaluates accuracy with MAPE, and programmatically selects the better model between <strong>Theta</strong> and <strong>ETS</strong> based on the lower MAPE.</p>
<hr>
<section id="why-ets-here" class="level3">
<h3 class="anchored" data-anchor-id="why-ets-here">Why ETS here</h3>
<p>The data have a smooth sinusoidal pattern (seasonality) plus a slow upward drift (trend). ETS explicitly models <strong>level</strong>, <strong>trend</strong>, and <strong>seasonality</strong> with exponential smoothing updates. The configuration</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>ExponentialSmoothing(trend<span class="op">=</span><span class="st">"add"</span>, seasonal<span class="op">=</span><span class="st">"add"</span>, sp<span class="op">=</span><span class="dv">75</span>, damped_trend<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>means:</p>
<ul>
<li><strong>trend=“add”</strong>: an <strong>additive</strong> trend component (<span class="math inline">\(+\)</span> slope).</li>
<li><strong>seasonal=“add”</strong>: <strong>additive</strong> seasonal pattern (appropriate when seasonal amplitude does not scale with the level).</li>
<li><strong>sp=75</strong>: seasonal period of 75 time steps (daily data with a ~75-day cycle).</li>
<li><strong>damped_trend=True</strong>: trend impact decays over the forecast horizon via a damping factor <span class="math inline">\(\phi \in (0,1)\)</span>, preventing unrealistic runaway growth.</li>
</ul>
<hr>
</section>
<section id="the-etsaaa-with-damping-state-space-equations" class="level3">
<h3 class="anchored" data-anchor-id="the-etsaaa-with-damping-state-space-equations">The ETS(A,A,A) with damping: state-space equations</h3>
<p>An additive error/additive trend/additive seasonality model with damping (often denoted ETS(A,Ad,A)) has latent states:</p>
<ul>
<li>Level: <span class="math inline">\(\ell_t\)</span></li>
<li>Trend (slope): <span class="math inline">\(b_t\)</span></li>
<li>Seasonality: <span class="math inline">\(s_t\)</span> with period <span class="math inline">\(s=\text{sp}\)</span></li>
</ul>
<p><strong>Observation (data) equation</strong> <span class="math display">\[
y_t = \ell_{t-1} + \phi b_{t-1} + s_{t-s} + \varepsilon_t,
\]</span> where <span class="math inline">\(\varepsilon_t\)</span> is the one-step-ahead error.</p>
<p><strong>State update equations</strong> <span class="math display">\[
\ell_t = \ell_{t-1} + \phi b_{t-1} + \alpha \varepsilon_t,
\]</span> <span class="math display">\[
b_t = \phi b_{t-1} + \beta \varepsilon_t,
\]</span> <span class="math display">\[
s_t = s_{t-s} + \gamma \varepsilon_t,
\]</span> with smoothing parameters <span class="math inline">\(\alpha,\beta,\gamma \in (0,1)\)</span> estimated from the data, and damping <span class="math inline">\(\phi \in (0,1)\)</span>.</p>
<p><strong><span class="math inline">\(h\)</span>-step-ahead forecast</strong> (produced by <code>predict(fh)</code>) <span class="math display">\[
\hat y_{t+h|t} = \ell_t + \left(\sum_{j=1}^{h} \phi^j\right) b_t + s_{t+h-s\left\lfloor\frac{h-1}{s}\right\rfloor}.
\]</span> When <span class="math inline">\(\phi&lt;1\)</span>, the contribution of the trend term <span class="math inline">\(\sum_{j=1}^{h}\phi^j\)</span> tapers off as <span class="math inline">\(h\)</span> increases (damped trend).</p>
<p><strong>Additive vs.&nbsp;multiplicative</strong></p>
<ul>
<li><em>Additive</em> seasonality adds a fixed seasonal effect: <span class="math inline">\(+,s_{t-s}\)</span>.</li>
<li><em>Multiplicative</em> seasonality scales with level: <span class="math inline">\(\times,s_{t-s}\)</span> (requires strictly positive values; not used here).</li>
</ul>
<hr>
</section>
<section id="fit-forecast-and-horizon" class="level3">
<h3 class="anchored" data-anchor-id="fit-forecast-and-horizon">Fit, forecast, and horizon</h3>
<div class="sourceCode" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>ets.fit(y_train)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>y_pred_ets <span class="op">=</span> ets.predict(fh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>fit(y_train)</code> estimates <span class="math inline">\(\alpha,\beta,\gamma,\phi\)</span> and initializes <span class="math inline">\(\ell_t, b_t, s_t\)</span> using only the training portion (no leakage).</li>
<li><code>fh</code> is the <strong>forecasting horizon</strong> (e.g., steps 1…30 ahead from the training endpoint). <code>predict(fh)</code> produces the corresponding vector <span class="math inline">\({\hat y_{T+1|T},\dots,\hat y_{T+H|T}}\)</span>.</li>
</ul>
<hr>
</section>
<section id="accuracy-metric-mape" class="level3">
<h3 class="anchored" data-anchor-id="accuracy-metric-mape">Accuracy metric: MAPE</h3>
<div class="sourceCode" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>mape_ets <span class="op">=</span> mean_absolute_percentage_error(y_test, y_pred_ets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Mean Absolute Percentage Error: <span class="math display">\[
\text{MAPE} = \frac{100%}{H}\sum_{h=1}^{H}\left|\frac{y_{T+h}-\hat y_{T+h}}{y_{T+h}}\right|.
\]</span></p>
<ul>
<li>Interprets error in percent terms (lower is better).</li>
<li>Be careful when <span class="math inline">\(y_{T+h}\)</span> is zero or very small (instability).</li>
</ul>
<p>The printout compares:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">"MAPE_last"</span>: ..., <span class="st">"MAPE_theta"</span>: ..., <span class="st">"MAPE_ets"</span>: ...}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>MAPE_last</strong>: naïve baseline (carry the last value forward).</li>
<li><strong>MAPE_theta</strong>: Theta model (trend-focused, no seasonality).</li>
<li><strong>MAPE_ets</strong>: ETS with additive trend/seasonality and damping.</li>
</ul>
<hr>
</section>
<section id="model-selection-by-metric" class="level3">
<h3 class="anchored" data-anchor-id="model-selection-by-metric">Model selection by metric</h3>
<div class="sourceCode" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>best_name, best_mape, best_pred <span class="op">=</span> <span class="bu">min</span>(</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">"theta_nodeseason"</span>, mape_theta, y_pred_theta), (<span class="st">"ets_add"</span>, mape_ets, y_pred_ets)],</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>]</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Builds a small leaderboard of candidates with their MAPE.</li>
<li><code>min(..., key=lambda x: x[1])</code> picks the tuple with the smallest second element (the MAPE).</li>
<li>Returns the <strong>name</strong>, <strong>score</strong>, and <strong>predictions</strong> of the winner for downstream use.</li>
</ul>
<hr>
</section>
<section id="practical-intuition" class="level3">
<h3 class="anchored" data-anchor-id="practical-intuition">Practical intuition</h3>
<ul>
<li><strong>ETS learns three moving pieces</strong>: today’s baseline level, the slope of change, and a repeating seasonal pattern.</li>
<li><strong>Additive seasonality</strong> says “add a seasonal bump” rather than “scale by a seasonal factor,” which is safer when values can be near zero or negative.</li>
<li><strong>Damped trend</strong> avoids forecasts that grow too fast by shrinking the trend effect step by step with <span class="math inline">\(\phi^h\)</span>.</li>
<li>The selected model must <strong>beat the naïve MAPE</strong> to justify its complexity on this dataset.</li>
</ul>
<div id="cell-200" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="1ff764ac-cf96-4312-da34-bad27a02b0dc" data-execution_count="63">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ----- Model B: ETS with additive trend/seasonality (handles sine + trend) -----</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>ets <span class="op">=</span> ExponentialSmoothing(trend<span class="op">=</span><span class="st">"add"</span>, seasonal<span class="op">=</span><span class="st">"add"</span>, sp<span class="op">=</span><span class="dv">75</span>, damped_trend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>ets.fit(y_train)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>y_pred_ets <span class="op">=</span> ets.predict(fh)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>mape_ets <span class="op">=</span> mean_absolute_percentage_error(y_test, y_pred_ets)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MAPE_last"</span>: <span class="bu">float</span>(mape_last),</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MAPE_theta"</span>: <span class="bu">float</span>(mape_theta),</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MAPE_ets"</span>: <span class="bu">float</span>(mape_ets),</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose the better of the two candidate models</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>best_name, best_mape, best_pred <span class="op">=</span> <span class="bu">min</span>(</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">"theta_nodeseason"</span>, mape_theta, y_pred_theta), (<span class="st">"ets_add"</span>, mape_ets, y_pred_ets)],</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>]</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({<span class="st">"best_model"</span>: best_name, <span class="st">"best_mape"</span>: <span class="bu">float</span>(best_mape)})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'MAPE_last': 0.2887089356544459, 'MAPE_theta': 0.2658110643420696, 'MAPE_ets': 0.03130788494131025}
{'best_model': 'ets_add', 'best_mape': 0.03130788494131025}</code></pre>
</div>
</div>
<div id="cell-201" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:407}}" data-outputid="eb80a545-f1e3-49e2-fc90-2cb85bd57e40" data-execution_count="64">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot actuals and forecasts (naive, theta, ETS) with distinct colors/styles</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure all forecasts are Series aligned to the test index</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>y_pred_last  <span class="op">=</span> pd.Series(y_pred_last,  index<span class="op">=</span>y_test.index, name<span class="op">=</span><span class="st">"Naive"</span>)</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>y_pred_theta <span class="op">=</span> pd.Series(y_pred_theta, index<span class="op">=</span>y_test.index, name<span class="op">=</span><span class="st">"Theta"</span>)</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>y_pred_ets   <span class="op">=</span> pd.Series(y_pred_ets,   index<span class="op">=</span>y_test.index, name<span class="op">=</span><span class="st">"ETS"</span>)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Actuals</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>y_train.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"0.7"</span>, label<span class="op">=</span><span class="st">"Train"</span>)</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>y_test.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Actual"</span>)</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>y_pred_last.plot(ax<span class="op">=</span>ax,  color<span class="op">=</span><span class="st">"#1f77b4"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"Naive"</span>)</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>y_pred_theta.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"#ff7f0e"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"Theta"</span>)</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>y_pred_ets.plot(ax<span class="op">=</span>ax,   color<span class="op">=</span><span class="st">"#2ca02c"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"ETS"</span>)</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Split marker</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>ax.axvline(y_test.index[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"0.5"</span>, linestyle<span class="op">=</span><span class="st">":"</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Actual vs Forecasts (Naive, Theta, ETS)"</span>)</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Time"</span>)</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"y"</span>)</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">"best"</span>, ncols<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-66-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="time-series-cross-validation-2" class="level2">
<h2 class="anchored" data-anchor-id="time-series-cross-validation-2">Time-Series Cross Validation</h2>
<p>Evaluate and compare three forecasters—Naive, Theta, and ETS—using <strong>time-series cross-validation</strong> (rolling/forward-chaining). The code also records, for every fold, the <strong>calendar dates</strong> used in training and testing, computes fold-level errors, and summarizes performance.</p>
<hr>
<section id="time-series-cross-validation-rolling-origin" class="level3">
<h3 class="anchored" data-anchor-id="time-series-cross-validation-rolling-origin">Time-series cross-validation (rolling origin)</h3>
<div class="sourceCode" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> SlidingWindowSplitter(window_length<span class="op">=</span><span class="dv">180</span>, fh<span class="op">=</span>np.arange(<span class="dv">1</span>, <span class="dv">31</span>), step_length<span class="op">=</span><span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Training window</strong>: last 180 observations before each cutoff.</li>
<li><strong>Forecasting horizon</strong>: <code>fh = 1..30</code> means produce 30-step-ahead forecasts from each cutoff.</li>
<li><strong>Step length</strong>: move the cutoff forward <strong>7</strong> observations at a time (weekly).</li>
<li>This is leakage-free because each fold trains on past data and tests on strictly future data.</li>
</ul>
<p><strong>Absolute vs.&nbsp;relative horizon.</strong> Later, each fold converts <code>fh</code> to <strong>absolute</strong> timestamps so forecasts align to the calendar:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>fh_abs <span class="op">=</span> ForecastingHorizon(y.index[test_idx], is_relative<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="calendar-of-folds-what-dates-were-used" class="level3">
<h3 class="anchored" data-anchor-id="calendar-of-folds-what-dates-were-used">Calendar of folds (what dates were used)</h3>
<div class="sourceCode" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>fold_meta <span class="op">=</span> []</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fold_id, (tr_idx, te_idx) <span class="kw">in</span> <span class="bu">enumerate</span>(cv.split(y), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    fold_meta.append({</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fold"</span>: fold_id,</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"train_start"</span>: y.index[tr_idx[<span class="dv">0</span>]],</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"train_end"</span>:   y.index[tr_idx[<span class="op">-</span><span class="dv">1</span>]],</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"test_start"</span>:  y.index[te_idx[<span class="dv">0</span>]],</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"test_end"</span>:    y.index[te_idx[<span class="op">-</span><span class="dv">1</span>]],</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_train"</span>:     <span class="bu">len</span>(tr_idx),</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_test"</span>:      <span class="bu">len</span>(te_idx),</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>cv_folds_calendar <span class="op">=</span> pd.DataFrame(fold_meta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>For each fold, the code stores the <strong>train and test start/end dates</strong> and counts.</p></li>
<li><p>This table documents the rolling windows used in CV—critical for auditability.</p></li>
</ul>
<hr>
</section>
<section id="candidate-forecasters" class="level3">
<h3 class="anchored" data-anchor-id="candidate-forecasters">Candidate forecasters</h3>
<div class="sourceCode" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"naive_last"</span>: NaiveForecaster(strategy<span class="op">=</span><span class="st">"last"</span>),</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"theta_nodeseason"</span>: ThetaForecaster(sp<span class="op">=</span><span class="dv">1</span>, deseasonalize<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ets_add"</span>: ExponentialSmoothing(</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>        trend<span class="op">=</span><span class="st">"add"</span>, seasonal<span class="op">=</span><span class="st">"add"</span>, sp<span class="op">=</span>SP, damped_trend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>        initialization_method<span class="op">=</span><span class="st">"estimated"</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><strong>Naive (last)</strong>: <span class="math inline">\(\hat y_{t+h|t}=y_t\)</span> for all <span class="math inline">\(h\)</span>.</p></li>
<li><p><strong>Theta (no deseasonalization)</strong>: trend-focused extrapolation (related to SES with drift), robust when values may be near zero since no multiplicative seasonality is applied.</p></li>
<li><p><strong>ETS(A,Ad,A)</strong>: additive error, <strong>additive</strong> trend (damped), <strong>additive</strong> seasonality with period <span class="math inline">\(s=SP\)</span>. State-space form:</p>
<p>Observation:</p>
<p><span class="math display">\[
y_t=\ell_{t-1}+\phi b_{t-1}+s_{t-s}+\varepsilon_t
\]</span></p>
<p>Updates:</p>
<p><span class="math display">\[
\ell_t=\ell_{t-1}+\phi b_{t-1}+\alpha\varepsilon_t,\quad
b_t=\phi b_{t-1}+\beta\varepsilon_t,\quad
s_t=s_{t-s}+\gamma\varepsilon_t,
\]</span></p>
<p>with <span class="math inline">\(\alpha,\beta,\gamma\in(0,1)\)</span> and damping <span class="math inline">\(\phi\in(0,1)\)</span>.</p>
<p><span class="math inline">\(h\)</span>-step forecast:</p>
<p><span class="math display">\[
\hat y_{t+h|t}=\ell_t+\Big(\sum_{j=1}^{h}\phi^j\Big)b_t+s_{t+h-s\lfloor (h-1)/s\rfloor}.
\]</span></p></li>
<li><p><code>initialization_method="estimated"</code> lets the model estimate initial level/trend/seasonals rather than relying on heuristic rules requiring two full seasonal cycles.</p></li>
</ul>
<hr>
</section>
<section id="cross-validated-backtest-routine" class="level3">
<h3 class="anchored" data-anchor-id="cross-validated-backtest-routine">Cross-validated backtest routine</h3>
<div class="sourceCode" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cv_backtest(y, forecaster, cv):</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    preds_list, ape_records, fold_scores <span class="op">=</span> [], [], []</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fold_id, (train_idx, test_idx) <span class="kw">in</span> <span class="bu">enumerate</span>(cv.split(y), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>        y_train, y_test_fold <span class="op">=</span> y.iloc[train_idx], y.iloc[test_idx]</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>        fh_abs <span class="op">=</span> ForecastingHorizon(y.index[test_idx], is_relative<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        f <span class="op">=</span> clone(forecaster)    <span class="co"># fresh copy per fold</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        f.fit(y_train)           <span class="co"># learn only from the current training window</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        y_pred_fold <span class="op">=</span> f.predict(fh<span class="op">=</span>fh_abs)</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        preds_list.append(y_pred_fold)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fold-level error: MAPE</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>        mape_fold <span class="op">=</span> mean_absolute_percentage_error(y_test_fold, y_pred_fold)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>        fold_scores.append({<span class="st">"fold"</span>: fold_id, <span class="st">"MAPE"</span>: <span class="bu">float</span>(mape_fold)})</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pointwise errors for diagnostics: APE = |y - ŷ| / |y|</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>        ape <span class="op">=</span> (y_test_fold <span class="op">-</span> y_pred_fold).<span class="bu">abs</span>() <span class="op">/</span> y_test_fold.<span class="bu">abs</span>()</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t, val <span class="kw">in</span> ape.items():</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>            ape_records.append({<span class="st">"time"</span>: t, <span class="st">"APE"</span>: <span class="bu">float</span>(val), <span class="st">"fold"</span>: fold_id})</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># “Stitched” predictions across folds (later folds overwrite overlaps)</span></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> pd.concat(preds_list).sort_index()</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> preds[<span class="op">~</span>preds.index.duplicated(keep<span class="op">=</span><span class="st">"last"</span>)]</span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> preds, pd.DataFrame(fold_scores), pd.DataFrame(ape_records)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>MAPE</strong> per fold: <span class="math display">\[\text{MAPE}*\text{fold}=\frac{100%}{H}\sum*{h=1}^{H}\left|\frac{y_{T+h}-\hat y_{T+h}}{y_{T+h}}\right|\]</span> where <span class="math inline">\(T\)</span> is the fold cutoff and <span class="math inline">\(H=30\)</span>.</li>
<li><strong>APE</strong> (pointwise) feeds diagnostic plots: <span class="math display">\[\text{APE}_{t}=\frac{|y_t-\hat y_t|}{|y_t|}.\]</span></li>
</ul>
<p><strong>Backtest (time-series forecasting)</strong></p>
<p>A backtest is a <strong>walk-forward evaluation routine</strong> that simulates how a forecaster would have performed <strong>in real time</strong> by repeatedly training on past data and forecasting future points, then comparing forecasts with the actuals that occurred later. It is leakage-free and time-ordered (no random shuffling).</p>
<section id="why-use-it" class="level4">
<h4 class="anchored" data-anchor-id="why-use-it">Why use it</h4>
<ul>
<li>Estimates <strong>generalization error</strong> under realistic deployment conditions.</li>
<li>Detects <strong>concept drift</strong> and horizon-specific degradation.</li>
<li>Provides a robust basis for <strong>model selection</strong> and <strong>hyperparameter tuning</strong>.</li>
</ul>
</section>
<section id="core-concepts" class="level4">
<h4 class="anchored" data-anchor-id="core-concepts">Core concepts</h4>
<ul>
<li><strong>Cutoff</strong> <span class="math inline">\(T_j\)</span>: the last timestamp available to the model at backtest step <span class="math inline">\(j\)</span>.</li>
<li><strong>Training window</strong> <span class="math inline">\(\mathcal{D}_{\le T_j}\)</span>: either <strong>growing</strong> (expanding) or <strong>sliding</strong> (fixed length).</li>
<li><strong>Forecast horizon</strong> <span class="math inline">\(fh={h_1,\dots,h_H}\)</span>: steps ahead predicted from <span class="math inline">\(T_j\)</span> (e.g., <span class="math inline">\(1{:}30\)</span>).</li>
<li><strong>Step length</strong> <span class="math inline">\(\Delta\)</span>: how far the cutoff moves forward each iteration (e.g., 7 days).</li>
<li><strong>Refit policy</strong>: refit the model at every cutoff (typical) vs.&nbsp;reuse fitted parameters.</li>
</ul>
</section>
<section id="design-choices" class="level4">
<h4 class="anchored" data-anchor-id="design-choices">Design choices</h4>
<ul>
<li><p><strong>Windowing</strong></p>
<ul>
<li><em>Growing</em> window: uses all history up to <span class="math inline">\(T_j\)</span>; stable for slow-changing series.</li>
<li><em>Sliding</em> window: fixed length (e.g., last 180 points); better for drift or seasonal recency.</li>
</ul></li>
<li><p><strong>Horizon definition</strong></p>
<ul>
<li><em>Relative</em> (<span class="math inline">\(1{:}H\)</span> steps from <span class="math inline">\(T_j\)</span>) or <em>absolute</em> (calendar dates). Consistency is critical.</li>
</ul></li>
<li><p><strong>Step length</strong> <span class="math inline">\(\Delta\)</span></p>
<ul>
<li>Smaller <span class="math inline">\(\Delta\)</span> = more folds, smoother estimates, higher compute.</li>
</ul></li>
<li><p><strong>Exogenous features</strong></p>
<ul>
<li>Must be available at prediction time for the horizon; otherwise restrict features or forecast them first.</li>
</ul></li>
<li><p><strong>Transformations</strong></p>
<ul>
<li>Scaling, differencing, and feature engineering must be <strong>fit inside each fold</strong> to avoid leakage.</li>
</ul></li>
</ul>
</section>
<section id="one-line-definition" class="level4">
<h4 class="anchored" data-anchor-id="one-line-definition">One-line definition</h4>
<p>A <strong>backtest routine</strong> is a time-ordered, walk-forward evaluation that repeatedly <strong>fits on past</strong>, <strong>predicts the future horizon</strong>, and <strong>scores against realized outcomes</strong>, aggregating errors across multiple rolling cutoffs to estimate true out-of-sample forecasting performance.</p>
<hr>
</section>
</section>
<section id="running-cv-for-all-models-and-joining-fold-dates" class="level3">
<h3 class="anchored" data-anchor-id="running-cv-for-all-models-and-joining-fold-dates">Running CV for all models and joining fold dates</h3>
<div class="sourceCode" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, model <span class="kw">in</span> models.items():</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    preds, fold_scores_df, ape_df <span class="op">=</span> cv_backtest(y, model, cv)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    preds.name <span class="op">=</span> name</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    cv_preds[name] <span class="op">=</span> preds</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    fold_scores_df[<span class="st">"model"</span>] <span class="op">=</span> name</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    per_fold_scores.append(fold_scores_df)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> ape_df.empty:</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>        ape_df[<span class="st">"model"</span>] <span class="op">=</span> name</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>        ape_all_models.append(ape_df)</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>per_fold_scores <span class="op">=</span> pd.concat(per_fold_scores, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>per_fold_scores <span class="op">=</span> per_fold_scores.merge(cv_folds_calendar, on<span class="op">=</span><span class="st">"fold"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Produces:</p>
<ul>
<li><code>cv_preds</code>: stitched forecast series per model.</li>
<li><code>per_fold_scores</code>: table with columns <code>fold</code>, <code>MAPE</code>, <code>model</code>, plus the <strong>calendar</strong> columns merged in (<code>train_start</code>, <code>train_end</code>, <code>test_start</code>, <code>test_end</code>, <code>n_train</code>, <code>n_test</code>).</li>
<li><code>ape_all_models</code>: long table of per-point APEs with model and fold labels.</li>
</ul></li>
</ul>
<hr>
</section>
<section id="model-level-summary" class="level3">
<h3 class="anchored" data-anchor-id="model-level-summary">Model-level summary</h3>
<div class="sourceCode" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>results_table <span class="op">=</span> (</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    per_fold_scores.groupby(<span class="st">"model"</span>)[<span class="st">"MAPE"</span>]</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    .agg(MAPE_mean<span class="op">=</span><span class="st">"mean"</span>, MAPE_std<span class="op">=</span><span class="st">"std"</span>, MAPE_median<span class="op">=</span><span class="st">"median"</span>, MAPE_min<span class="op">=</span><span class="st">"min"</span>, MAPE_max<span class="op">=</span><span class="st">"max"</span>, folds<span class="op">=</span><span class="st">"count"</span>)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"MAPE_mean"</span>)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Aggregates fold-level MAPE to compare models. Lower mean MAPE indicates better average performance across rolling test windows; the standard deviation reflects stability.</li>
</ul>
<hr>
</section>
<section id="deliverables-printed" class="level3">
<h3 class="anchored" data-anchor-id="deliverables-printed">Deliverables printed</h3>
<div class="sourceCode" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_table)        <span class="co"># model comparison (mean±std, etc.)</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cv_folds_calendar)    <span class="co"># calendar of folds (dates and sizes)</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(per_fold_scores.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong><code>results_table</code></strong>: concise leaderboard.</li>
<li><strong><code>cv_folds_calendar</code></strong>: audit log of the rolling CV windows (start/end dates).</li>
<li><strong><code>per_fold_scores</code></strong>: per-fold MAPE joined with the corresponding calendar dates.</li>
</ul>
<hr>
</section>
<section id="why-this-setup-is-correct-for-forecasting" class="level3">
<h3 class="anchored" data-anchor-id="why-this-setup-is-correct-for-forecasting">Why this setup is correct for forecasting</h3>
<ul>
<li><p><strong>No leakage</strong>: each fold trains on past, validates on future.</p></li>
<li><p><strong>Multiple cutoffs</strong>: tests robustness by varying the information set.</p></li>
<li><p><strong>Calendar traceability</strong>: retained dates allow reproduction and debugging.</p></li>
<li><p><strong>Appropriate baselines and models</strong>: Naive sets the floor; Theta handles level/trend; ETS adds explicit seasonality with damping.</p></li>
</ul>
<p><strong>Interpretation guideline</strong></p>
<p>Pick the model with the <strong>lowest mean MAPE</strong> and acceptable <strong>MAPE_std</strong>. Then visualize <code>cv_preds</code> against <code>y</code> to confirm qualitative fit and check where errors spike using per-point APEs.</p>
<div id="cell-204" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="d6c96609-37a3-4ae8-a100-1e350be57d63" data-execution_count="65">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-validated comparison (Naive, Theta, ETS) + calendar of folds (train/test start &amp; end dates)</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> clone</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.model_selection <span class="im">import</span> SlidingWindowSplitter</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.base <span class="im">import</span> ForecastingHorizon</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.naive <span class="im">import</span> NaiveForecaster</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.theta <span class="im">import</span> ThetaForecaster</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.exp_smoothing <span class="im">import</span> ExponentialSmoothing</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.performance_metrics.forecasting <span class="im">import</span> mean_absolute_percentage_error</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Synthetic data (ensure enough history for seasonal ETS)</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">400</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> pd.date_range(<span class="st">"2015-01-01"</span>, periods<span class="op">=</span>n, freq<span class="op">=</span><span class="st">"D"</span>)</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.Series(</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>    np.sin(np.arange(n) <span class="op">/</span> <span class="fl">12.0</span>) <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> np.random.randn(n) <span class="op">+</span> <span class="fl">0.01</span> <span class="op">*</span> np.arange(n),</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>idx,</span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"y"</span>,</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>SP <span class="op">=</span> <span class="dv">75</span>  <span class="co"># seasonal period</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-validation scheme (&gt;= 2*SP inside each training window)</span></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> SlidingWindowSplitter(</span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>    window_length<span class="op">=</span><span class="dv">180</span>,            <span class="co"># &gt;= 150</span></span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>    fh<span class="op">=</span>np.arange(<span class="dv">1</span>, <span class="dv">31</span>),          <span class="co"># 30-step horizon</span></span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>    step_length<span class="op">=</span><span class="dv">7</span>                 <span class="co"># weekly rolling</span></span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a dataset with the calendar (start/end) for each CV fold</span></span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a>fold_meta <span class="op">=</span> []</span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fold_id, (tr_idx, te_idx) <span class="kw">in</span> <span class="bu">enumerate</span>(cv.split(y), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a>    fold_meta.append({</span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fold"</span>: fold_id,</span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"train_start"</span>: y.index[tr_idx[<span class="dv">0</span>]],</span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"train_end"</span>:   y.index[tr_idx[<span class="op">-</span><span class="dv">1</span>]],</span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"test_start"</span>:  y.index[te_idx[<span class="dv">0</span>]],</span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">"test_end"</span>:    y.index[te_idx[<span class="op">-</span><span class="dv">1</span>]],</span>
<span id="cb95-45"><a href="#cb95-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_train"</span>:     <span class="bu">len</span>(tr_idx),</span>
<span id="cb95-46"><a href="#cb95-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_test"</span>:      <span class="bu">len</span>(te_idx),</span>
<span id="cb95-47"><a href="#cb95-47" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb95-48"><a href="#cb95-48" aria-hidden="true" tabindex="-1"></a>cv_folds_calendar <span class="op">=</span> pd.DataFrame(fold_meta)</span>
<span id="cb95-49"><a href="#cb95-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-50"><a href="#cb95-50" aria-hidden="true" tabindex="-1"></a><span class="co"># print(cv_folds_calendar.head())           # &lt;-- calendar of folds</span></span>
<span id="cb95-51"><a href="#cb95-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-52"><a href="#cb95-52" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb95-53"><a href="#cb95-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Candidate forecasters</span></span>
<span id="cb95-54"><a href="#cb95-54" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {</span>
<span id="cb95-55"><a href="#cb95-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"naive_last"</span>: NaiveForecaster(strategy<span class="op">=</span><span class="st">"last"</span>),</span>
<span id="cb95-56"><a href="#cb95-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"theta_nodeseason"</span>: ThetaForecaster(sp<span class="op">=</span><span class="dv">1</span>, deseasonalize<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb95-57"><a href="#cb95-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ets_add"</span>: ExponentialSmoothing(</span>
<span id="cb95-58"><a href="#cb95-58" aria-hidden="true" tabindex="-1"></a>        trend<span class="op">=</span><span class="st">"add"</span>,</span>
<span id="cb95-59"><a href="#cb95-59" aria-hidden="true" tabindex="-1"></a>        seasonal<span class="op">=</span><span class="st">"add"</span>,</span>
<span id="cb95-60"><a href="#cb95-60" aria-hidden="true" tabindex="-1"></a>        sp<span class="op">=</span>SP,</span>
<span id="cb95-61"><a href="#cb95-61" aria-hidden="true" tabindex="-1"></a>        damped_trend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb95-62"><a href="#cb95-62" aria-hidden="true" tabindex="-1"></a>        initialization_method<span class="op">=</span><span class="st">"estimated"</span>,</span>
<span id="cb95-63"><a href="#cb95-63" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb95-64"><a href="#cb95-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-65"><a href="#cb95-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-66"><a href="#cb95-66" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb95-67"><a href="#cb95-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cv_backtest(y, forecaster, cv):</span>
<span id="cb95-68"><a href="#cb95-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run sliding-window CV for one forecaster and collect predictions, metrics, and per-fold scores."""</span></span>
<span id="cb95-69"><a href="#cb95-69" aria-hidden="true" tabindex="-1"></a>    preds_list <span class="op">=</span> []</span>
<span id="cb95-70"><a href="#cb95-70" aria-hidden="true" tabindex="-1"></a>    ape_records <span class="op">=</span> []</span>
<span id="cb95-71"><a href="#cb95-71" aria-hidden="true" tabindex="-1"></a>    fold_scores <span class="op">=</span> []</span>
<span id="cb95-72"><a href="#cb95-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-73"><a href="#cb95-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fold_id, (train_idx, test_idx) <span class="kw">in</span> <span class="bu">enumerate</span>(cv.split(y), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb95-74"><a href="#cb95-74" aria-hidden="true" tabindex="-1"></a>        y_train <span class="op">=</span> y.iloc[train_idx]</span>
<span id="cb95-75"><a href="#cb95-75" aria-hidden="true" tabindex="-1"></a>        y_test_fold <span class="op">=</span> y.iloc[test_idx]</span>
<span id="cb95-76"><a href="#cb95-76" aria-hidden="true" tabindex="-1"></a>        fh_abs <span class="op">=</span> ForecastingHorizon(y.index[test_idx], is_relative<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb95-77"><a href="#cb95-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-78"><a href="#cb95-78" aria-hidden="true" tabindex="-1"></a>        f <span class="op">=</span> clone(forecaster)</span>
<span id="cb95-79"><a href="#cb95-79" aria-hidden="true" tabindex="-1"></a>        f.fit(y_train)</span>
<span id="cb95-80"><a href="#cb95-80" aria-hidden="true" tabindex="-1"></a>        y_pred_fold <span class="op">=</span> f.predict(fh<span class="op">=</span>fh_abs)</span>
<span id="cb95-81"><a href="#cb95-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-82"><a href="#cb95-82" aria-hidden="true" tabindex="-1"></a>        preds_list.append(y_pred_fold)</span>
<span id="cb95-83"><a href="#cb95-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-84"><a href="#cb95-84" aria-hidden="true" tabindex="-1"></a>        mape_fold <span class="op">=</span> mean_absolute_percentage_error(y_test_fold, y_pred_fold)</span>
<span id="cb95-85"><a href="#cb95-85" aria-hidden="true" tabindex="-1"></a>        fold_scores.append({<span class="st">"fold"</span>: fold_id, <span class="st">"MAPE"</span>: <span class="bu">float</span>(mape_fold)})</span>
<span id="cb95-86"><a href="#cb95-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-87"><a href="#cb95-87" aria-hidden="true" tabindex="-1"></a>        ape <span class="op">=</span> (y_test_fold <span class="op">-</span> y_pred_fold).<span class="bu">abs</span>() <span class="op">/</span> y_test_fold.<span class="bu">abs</span>()</span>
<span id="cb95-88"><a href="#cb95-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t, val <span class="kw">in</span> ape.items():</span>
<span id="cb95-89"><a href="#cb95-89" aria-hidden="true" tabindex="-1"></a>            ape_records.append({<span class="st">"time"</span>: t, <span class="st">"APE"</span>: <span class="bu">float</span>(val), <span class="st">"fold"</span>: fold_id})</span>
<span id="cb95-90"><a href="#cb95-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-91"><a href="#cb95-91" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> pd.concat(preds_list).sort_index()</span>
<span id="cb95-92"><a href="#cb95-92" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> preds[<span class="op">~</span>preds.index.duplicated(keep<span class="op">=</span><span class="st">"last"</span>)]</span>
<span id="cb95-93"><a href="#cb95-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> preds, pd.DataFrame(fold_scores), pd.DataFrame(ape_records)</span>
<span id="cb95-94"><a href="#cb95-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-95"><a href="#cb95-95" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb95-96"><a href="#cb95-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Run CV for all models</span></span>
<span id="cb95-97"><a href="#cb95-97" aria-hidden="true" tabindex="-1"></a>cv_preds <span class="op">=</span> {}                 <span class="co"># Series of stitched CV forecasts per model</span></span>
<span id="cb95-98"><a href="#cb95-98" aria-hidden="true" tabindex="-1"></a>per_fold_scores <span class="op">=</span> []          <span class="co"># list of DataFrames with columns: fold, MAPE, model</span></span>
<span id="cb95-99"><a href="#cb95-99" aria-hidden="true" tabindex="-1"></a>ape_all_models <span class="op">=</span> []           <span class="co"># per-point APE for boxplots</span></span>
<span id="cb95-100"><a href="#cb95-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-101"><a href="#cb95-101" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, model <span class="kw">in</span> models.items():</span>
<span id="cb95-102"><a href="#cb95-102" aria-hidden="true" tabindex="-1"></a>    preds, fold_scores_df, ape_df <span class="op">=</span> cv_backtest(y, model, cv)</span>
<span id="cb95-103"><a href="#cb95-103" aria-hidden="true" tabindex="-1"></a>    preds.name <span class="op">=</span> name</span>
<span id="cb95-104"><a href="#cb95-104" aria-hidden="true" tabindex="-1"></a>    cv_preds[name] <span class="op">=</span> preds</span>
<span id="cb95-105"><a href="#cb95-105" aria-hidden="true" tabindex="-1"></a>    fold_scores_df[<span class="st">"model"</span>] <span class="op">=</span> name</span>
<span id="cb95-106"><a href="#cb95-106" aria-hidden="true" tabindex="-1"></a>    per_fold_scores.append(fold_scores_df)</span>
<span id="cb95-107"><a href="#cb95-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> ape_df.empty:</span>
<span id="cb95-108"><a href="#cb95-108" aria-hidden="true" tabindex="-1"></a>        ape_df[<span class="st">"model"</span>] <span class="op">=</span> name</span>
<span id="cb95-109"><a href="#cb95-109" aria-hidden="true" tabindex="-1"></a>        ape_all_models.append(ape_df)</span>
<span id="cb95-110"><a href="#cb95-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-111"><a href="#cb95-111" aria-hidden="true" tabindex="-1"></a>per_fold_scores <span class="op">=</span> pd.concat(per_fold_scores, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb95-112"><a href="#cb95-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach calendar dates to each fold</span></span>
<span id="cb95-113"><a href="#cb95-113" aria-hidden="true" tabindex="-1"></a>per_fold_scores <span class="op">=</span> per_fold_scores.merge(cv_folds_calendar, on<span class="op">=</span><span class="st">"fold"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb95-114"><a href="#cb95-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-115"><a href="#cb95-115" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb95-116"><a href="#cb95-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary comparison table (mean ± std MAPE)</span></span>
<span id="cb95-117"><a href="#cb95-117" aria-hidden="true" tabindex="-1"></a>results_table <span class="op">=</span> (</span>
<span id="cb95-118"><a href="#cb95-118" aria-hidden="true" tabindex="-1"></a>    per_fold_scores</span>
<span id="cb95-119"><a href="#cb95-119" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"model"</span>)[<span class="st">"MAPE"</span>]</span>
<span id="cb95-120"><a href="#cb95-120" aria-hidden="true" tabindex="-1"></a>    .agg(MAPE_mean<span class="op">=</span><span class="st">"mean"</span>, MAPE_std<span class="op">=</span><span class="st">"std"</span>, MAPE_median<span class="op">=</span><span class="st">"median"</span>, MAPE_min<span class="op">=</span><span class="st">"min"</span>, MAPE_max<span class="op">=</span><span class="st">"max"</span>, folds<span class="op">=</span><span class="st">"count"</span>)</span>
<span id="cb95-121"><a href="#cb95-121" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb95-122"><a href="#cb95-122" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"MAPE_mean"</span>)</span>
<span id="cb95-123"><a href="#cb95-123" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-124"><a href="#cb95-124" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_table)</span>
<span id="cb95-125"><a href="#cb95-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-126"><a href="#cb95-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-127"><a href="#cb95-127" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb95-128"><a href="#cb95-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Artifacts produced:</span></span>
<span id="cb95-129"><a href="#cb95-129" aria-hidden="true" tabindex="-1"></a><span class="co"># - cv_folds_calendar : dataset with start/end dates per fold</span></span>
<span id="cb95-130"><a href="#cb95-130" aria-hidden="true" tabindex="-1"></a><span class="co"># - per_fold_scores   : per-fold MAPE joined with fold calendar</span></span>
<span id="cb95-131"><a href="#cb95-131" aria-hidden="true" tabindex="-1"></a><span class="co"># - results_table     : model-level summary (mean/std/median/min/max MAPE)</span></span>
<span id="cb95-132"><a href="#cb95-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-133"><a href="#cb95-133" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Calendar of CV folds:"</span>)</span>
<span id="cb95-134"><a href="#cb95-134" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cv_folds_calendar)</span>
<span id="cb95-135"><a href="#cb95-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-136"><a href="#cb95-136" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Per-fold scores (with dates):"</span>)</span>
<span id="cb95-137"><a href="#cb95-137" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(per_fold_scores.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              model  MAPE_mean  MAPE_std  MAPE_median  MAPE_min  MAPE_max  \
0           ets_add      0.051     0.022        0.042     0.025     0.105   
1        naive_last      0.285     0.149        0.266     0.070     0.757   
2  theta_nodeseason      0.297     0.169        0.263     0.077     0.836   

   folds  
0     28  
1     28  
2     28  

Calendar of CV folds:
    fold train_start  train_end test_start   test_end  n_train  n_test
0      1  2015-01-01 2015-06-29 2015-06-30 2015-07-29      180      30
1      2  2015-01-08 2015-07-06 2015-07-07 2015-08-05      180      30
2      3  2015-01-15 2015-07-13 2015-07-14 2015-08-12      180      30
3      4  2015-01-22 2015-07-20 2015-07-21 2015-08-19      180      30
4      5  2015-01-29 2015-07-27 2015-07-28 2015-08-26      180      30
5      6  2015-02-05 2015-08-03 2015-08-04 2015-09-02      180      30
6      7  2015-02-12 2015-08-10 2015-08-11 2015-09-09      180      30
7      8  2015-02-19 2015-08-17 2015-08-18 2015-09-16      180      30
8      9  2015-02-26 2015-08-24 2015-08-25 2015-09-23      180      30
9     10  2015-03-05 2015-08-31 2015-09-01 2015-09-30      180      30
10    11  2015-03-12 2015-09-07 2015-09-08 2015-10-07      180      30
11    12  2015-03-19 2015-09-14 2015-09-15 2015-10-14      180      30
12    13  2015-03-26 2015-09-21 2015-09-22 2015-10-21      180      30
13    14  2015-04-02 2015-09-28 2015-09-29 2015-10-28      180      30
14    15  2015-04-09 2015-10-05 2015-10-06 2015-11-04      180      30
15    16  2015-04-16 2015-10-12 2015-10-13 2015-11-11      180      30
16    17  2015-04-23 2015-10-19 2015-10-20 2015-11-18      180      30
17    18  2015-04-30 2015-10-26 2015-10-27 2015-11-25      180      30
18    19  2015-05-07 2015-11-02 2015-11-03 2015-12-02      180      30
19    20  2015-05-14 2015-11-09 2015-11-10 2015-12-09      180      30
20    21  2015-05-21 2015-11-16 2015-11-17 2015-12-16      180      30
21    22  2015-05-28 2015-11-23 2015-11-24 2015-12-23      180      30
22    23  2015-06-04 2015-11-30 2015-12-01 2015-12-30      180      30
23    24  2015-06-11 2015-12-07 2015-12-08 2016-01-06      180      30
24    25  2015-06-18 2015-12-14 2015-12-15 2016-01-13      180      30
25    26  2015-06-25 2015-12-21 2015-12-22 2016-01-20      180      30
26    27  2015-07-02 2015-12-28 2015-12-29 2016-01-27      180      30
27    28  2015-07-09 2016-01-04 2016-01-05 2016-02-03      180      30

Per-fold scores (with dates):
   fold   MAPE       model train_start  train_end test_start   test_end  \
0     1  0.757  naive_last  2015-01-01 2015-06-29 2015-06-30 2015-07-29   
1     2  0.538  naive_last  2015-01-08 2015-07-06 2015-07-07 2015-08-05   
2     3  0.215  naive_last  2015-01-15 2015-07-13 2015-07-14 2015-08-12   
3     4  0.271  naive_last  2015-01-22 2015-07-20 2015-07-21 2015-08-19   
4     5  0.375  naive_last  2015-01-29 2015-07-27 2015-07-28 2015-08-26   

   n_train  n_test  
0      180      30  
1      180      30  
2      180      30  
3      180      30  
4      180      30  </code></pre>
</div>
</div>
<div id="cell-205" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:407}}" data-outputid="4679c3cd-ce0f-435a-b75e-a36a1cccbf6e" data-execution_count="66">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Plots</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Actual vs stitched CV forecasts</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>y.plot(ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">"Actual"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, preds <span class="kw">in</span> cv_preds.items():</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    preds.plot(ax<span class="op">=</span>ax, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span>name)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Actual vs Cross-Validated Forecasts (stitched across folds)"</span>)</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Time"</span>)</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"y"</span>)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.25</span>)</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-68-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-206" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:407}}" data-outputid="b9b0d5eb-302c-4bf8-a32a-e42644b11db6" data-execution_count="67">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Mean MAPE by model (with std error bars)</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(results_table))</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>ax.bar(x, results_table[<span class="st">"MAPE_mean"</span>], yerr<span class="op">=</span>results_table[<span class="st">"MAPE_std"</span>], capsize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x, results_table[<span class="st">"model"</span>])</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Cross-Validated Mean MAPE by Model"</span>)</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"MAPE"</span>)</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, axis<span class="op">=</span><span class="st">"y"</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="08_time_series_files/figure-html/cell-69-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-207" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="1d3df0fb-5139-49b2-bddc-dd9a190a0ba9" data-execution_count="68">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Best model by mean MAPE</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>best_row <span class="op">=</span> results_table.iloc[<span class="dv">0</span>]</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"best_model"</span>: best_row[<span class="st">"model"</span>],</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"best_mape_mean"</span>: best_row[<span class="st">"MAPE_mean"</span>],</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"best_mape_std"</span>: best_row[<span class="st">"MAPE_std"</span>],</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'best_model': 'ets_add', 'best_mape_mean': np.float64(0.05079799448537462), 'best_mape_std': np.float64(0.021624320334035486)}</code></pre>
</div>
</div>
#
<center>
</center>
#
<center>
Have fun!
</center>
<div id="cell-209" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !jupyter nbconvert _08-py-wrangling-basics-practice-solutions.ipynb --to html --template classic --output 08-py-wrangling-basics-practice-solutions.html</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>